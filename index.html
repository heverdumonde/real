<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
  <title>표고모</title>
  <link href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css" rel="stylesheet">

  <!-- Google Identity Services (Sign in with Google) -->
  <script src="https://accounts.google.com/gsi/client" async defer></script>

  <style>
    :root{
      --font: ui-sans-serif, system-ui, -apple-system, "Apple SD Gothic Neo", "Noto Sans KR", Segoe UI, Roboto, Arial, sans-serif;

      /* sizing */
      --navH: 76px;
      --topPad: env(safe-area-inset-top);
      --botPad: env(safe-area-inset-bottom);

      /* responsive widths */
      --maxW: 1040px;
      --maxWPad: 860px;
      --maxWPhone: 560px;

      /* radii */
      --r12: 12px;
      --r16: 16px;
      --r20: 20px;
      --r24: 24px;
      --r999: 999px;

      /* typography */
      --fs-11: 11px;
      --fs-12: 12px;
      --fs-13: 13px;
      --fs-14: 14px;
      --fs-15: 15px;
      --fs-16: 16px;
      --fs-18: 18px;
      --fs-20: 20px;
      --fs-24: 24px;
      --fs-28: 28px;
      --fs-32: 32px;

      /* weights (애플 느낌: 과한 900+ 최대한 금지) */
      --w-regular: 500;
      --w-medium: 600;
      --w-semibold: 650;
      --w-bold: 720;

      /* motion */
      --t-fast: 140ms;
      --t: 220ms;
      --t-smooth: 420ms;
      --ease: cubic-bezier(.2,.8,.2,1);

      /* colors - dark default */
      --bg: #0b0c0f;
      --text: rgba(255,255,255,.92);
      --muted: rgba(255,255,255,.66);
      --muted2: rgba(255,255,255,.46);

      --surface: rgba(255,255,255,.06);
      --surface2: rgba(255,255,255,.09);
      --line: rgba(255,255,255,.10);
      --line2: rgba(255,255,255,.14);

      --cardBg: rgba(255,255,255,.06);
      --cardBorder: rgba(255,255,255,.10);
      /* drawer background (opaque to feel more "app-like") */
      --drawerBg: rgba(11,12,15,0.96);
      --drawer-w: 360px;

      --accent: #ff4500;          /* 레딧 포인트는 살리되 */
      --accent2: rgba(255,69,0,.14);
      --blue: #3b82f6;
      --ok: #22c55e;
      --danger: #ef4444;

      --shadow: 0 16px 40px rgba(0,0,0,.45);
      --shadowSoft: 0 10px 30px rgba(0,0,0,.30);

      --topBlur: rgba(12,13,16,.78);
      --navBlur: rgba(12,13,16,.80);
      --overlay: rgba(0,0,0,.55);
      --overlayStrong: rgba(0,0,0,.72);

      --focusRing: 0 0 0 3px rgba(59,130,246,.25);
    }

    body.theme-light{
      --bg: #f4f5f7;
      --text: rgba(17,24,39,.92);
      --muted: rgba(17,24,39,.62);
      --muted2: rgba(17,24,39,.46);

      --surface: rgba(15,23,42,.05);
      --surface2: rgba(15,23,42,.08);
      --line: rgba(15,23,42,.10);
      --line2: rgba(15,23,42,.14);

      --cardBg: rgba(255,255,255,.88);
      --cardBorder: rgba(15,23,42,.10);
      --drawerBg: rgba(255,255,255,0.98);

      --shadow: 0 16px 40px rgba(15,23,42,.14);
      --shadowSoft: 0 10px 30px rgba(15,23,42,.10);

      --topBlur: rgba(244,245,247,.82);
      --navBlur: rgba(244,245,247,.86);

      --overlay: rgba(15,23,42,.30);
      --overlayStrong: rgba(15,23,42,.44);

      --focusRing: 0 0 0 3px rgba(59,130,246,.22);
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      font-family: var(--font);
      background: var(--bg);
      color: var(--text);
      overflow:hidden;
      -webkit-font-smoothing: antialiased;
      text-rendering: optimizeLegibility;
    }
    body.reduce-motion-ui *,
    body.reduce-motion-ui *::before,
    body.reduce-motion-ui *::after{
      animation: none !important;
      transition: none !important;
      scroll-behavior: auto !important;
    }
    button,input,textarea{ font:inherit; color:inherit; }
    a{ color:inherit; text-decoration:none; }
    ::selection{ background: rgba(255,69,0,.22); }

    /* accessibility */
    :focus-visible{ outline:none; box-shadow: var(--focusRing); border-radius: 10px; }
    @media (prefers-reduced-motion: reduce){
      *{ transition:none !important; animation:none !important; scroll-behavior:auto !important; }
    }

    /* app layout */
    .app{
      height:100%;
      display:flex;
      flex-direction:column;
      background: var(--bg);
      transition: transform var(--t-smooth) cubic-bezier(.22,1,.36,1), box-shadow var(--t) var(--ease);
      will-change: transform, box-shadow;
      position: relative; /* contain the ::before edge reveal */
      z-index: 20; /* sit under the drawer which has higher z-index */
    }
    /* Shifted state when drawer opens — layered slide-out effect */
    .app.shifted{
      transform: translate3d(var(--app-push, 0px),0,0) scale(.996);
      box-shadow: -24px 40px 80px rgba(0,0,0,.38);
      transform-origin: left center;
    }
    /* subtle left-edge reveal to make content look like it's sliding out from under */
    .app.shifted::before{
      content: '';
      position: absolute;
      left: calc(var(--app-push, 0px) - 12px);
      top: 0; bottom: 0;
      width: 12px;
      pointer-events: none;
      background: linear-gradient(90deg, rgba(0,0,0,.18), rgba(0,0,0,0));
      transition: left var(--t-smooth) cubic-bezier(.22,1,.36,1), opacity var(--t) var(--ease);
      opacity: 1;
      z-index: 25;
    }
    .stage{
      flex:1;
      overflow:auto;
      -webkit-overflow-scrolling: touch;
      padding-bottom: calc(var(--navH) + var(--botPad) + 14px);
    }
    .screen{ display:none; min-height:100%; }
    .screen.active{ display:block; }
    .screen.screen-enter{
      animation: screenEnter 260ms cubic-bezier(.22,1,.36,1);
    }
    @keyframes screenEnter{
      from{ opacity:0; transform: translateY(10px); }
      to{ opacity:1; transform: translateY(0); }
    }

    /* ===== Settings Modal Screen ===== */
    .settingsModalScreen{
      position: fixed;
      inset: 0;
      z-index: 120;
      display: none;
    }
    .settingsModalScreen.active{
      display: block;
      animation: settingsFadeIn 180ms var(--ease);
    }
    .settingsModalBackdrop{
      position: absolute;
      inset: 0;
      background: var(--overlayStrong);
      backdrop-filter: blur(4px);
      -webkit-backdrop-filter: blur(4px);
    }
    .settingsPanel{
      position: absolute;
      left: 50%;
      top: 50%;
      transform: translate(-50%, -50%) scale(.98);
      width: min(720px, calc(100vw - 36px));
      max-height: min(78vh, 860px);
      overflow: auto;
      border-radius: 18px;
      border: 1px solid rgba(255,255,255,.12);
      background: #080a0d;
      box-shadow: 0 30px 90px rgba(0,0,0,.55);
      animation: settingsPop 220ms cubic-bezier(.22,1,.36,1) forwards;
    }
    .settingsPanelHead{
      position: sticky;
      top: 0;
      z-index: 1;
      display: grid;
      grid-template-columns: 40px 1fr 40px;
      align-items: center;
      gap: 8px;
      padding: 12px 12px;
      border-bottom: 1px solid rgba(255,255,255,.10);
      background: rgba(8,10,13,.96);
    }
    .settingsBody{ padding: 12px 14px 16px; }
    .settingsGroup{
      margin: 14px 0 8px;
      color: rgba(255,255,255,.52);
      font-size: 11px;
      font-weight: var(--w-bold);
      letter-spacing: .3px;
      text-transform: uppercase;
    }
    .settingsRow{
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      min-height: 54px;
      border-bottom: 1px solid rgba(255,255,255,.08);
      padding: 8px 0;
    }
    .settingsInputRow{
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.03);
      border-radius: 12px;
      padding: 10px;
      display: grid;
      gap: 8px;
    }
    .settingsLabel{ font-weight: var(--w-semibold); }
    .settingsHint{
      margin-top: 4px;
      color: var(--muted2);
      font-size: 12px;
    }
    .settingsListCard{
      border: 1px solid rgba(255,255,255,.10);
      border-radius: 14px;
      background: rgba(255,255,255,.03);
      overflow: hidden;
    }
    .settingsItem{
      width: 100%;
      min-height: 52px;
      border: 0;
      border-bottom: 1px solid rgba(255,255,255,.08);
      background: transparent;
      color: inherit;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      text-align: left;
      padding: 10px 12px;
      cursor: pointer;
    }
    .settingsListCard .settingsItem:last-child{ border-bottom: 0; }
    .settingsItem .l{ display: grid; gap: 4px; }
    .settingsItem .l b{ font-weight: var(--w-semibold); }
    .settingsItem .l small{ color: var(--muted2); font-size: 12px; }
    .settingsItem .r{ color: var(--muted2); font-weight: var(--w-semibold); }
    .settingsItem.danger .l b{ color: #ef6b6b; }
    .settingsToggleRow{ position: relative; }
    .settingsToggleRow input{
      appearance: none;
      -webkit-appearance: none;
      width: 44px;
      height: 26px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.16);
      background: rgba(255,255,255,.20);
      margin: 0;
      cursor: pointer;
    }
    .settingsToggleRow .toggleKnob{
      position: absolute;
      right: 32px;
      width: 20px;
      height: 20px;
      border-radius: 50%;
      background: #fff;
      pointer-events: none;
      transition: transform var(--t) var(--ease);
    }
    .settingsToggleRow input:checked{
      background: #2f81ff;
      border-color: #2f81ff;
    }
    .settingsToggleRow input:checked + .toggleKnob{
      transform: translateX(18px);
    }
    body.theme-light .settingsPanel{
      background: #f3f6fa;
      border-color: rgba(15,23,42,.16);
      box-shadow: 0 24px 70px rgba(15,23,42,.20);
    }
    body.theme-light .settingsPanelHead{
      background: rgba(243,246,250,.97);
      border-bottom-color: rgba(15,23,42,.10);
    }
    body.theme-light .settingsGroup{ color: #667085; }
    body.theme-light .settingsRow{ border-bottom-color: rgba(15,23,42,.10); }
    body.theme-light .settingsInputRow{
      border-color: rgba(15,23,42,.12);
      background: rgba(255,255,255,.86);
    }
    body.theme-light .settingsListCard{
      border-color: rgba(15,23,42,.12);
      background: rgba(255,255,255,.86);
    }
    body.theme-light .settingsItem{
      border-bottom-color: rgba(15,23,42,.10);
    }
    body.theme-light .settingsItem .l small,
    body.theme-light .settingsItem .r{
      color: rgba(15,23,42,.56);
    }
    body.theme-light .settingsToggleRow input{
      border-color: rgba(15,23,42,.16);
      background: rgba(15,23,42,.18);
    }
    @keyframes settingsFadeIn{
      from{ opacity: 0; }
      to{ opacity: 1; }
    }
    @keyframes settingsPop{
      from{ transform: translate(-50%, -49%) scale(.96); opacity: 0; }
      to{ transform: translate(-50%, -50%) scale(1); opacity: 1; }
    }

    .wrap{
      max-width: var(--maxW);
      margin: 0 auto;
      padding: 0 18px;
    }

    /* ====== Topbar (Apple-like) ====== */
    .topbar{
      position: relative;
      top:auto;
      z-index: 30;
      background: var(--topBlur);
      backdrop-filter: blur(16px);
      -webkit-backdrop-filter: blur(16px);
      border-bottom: 1px solid var(--line);
      padding-top: var(--topPad);
    }
    .topbar-inner{
      display:flex;
      align-items:center;
      gap: 12px;
      padding: 12px 6px;
    }
    .titleCenter{
      flex:1;
      min-width:0;
      text-align:center;
      font-size: var(--fs-16);
      font-weight: var(--w-semibold);
      letter-spacing: -0.2px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }

    /* controls */
    .iconBtn, .leftIcon, .rightIcon{
      width: 40px; height: 40px;
      border-radius: var(--r999);
      border: 1px solid var(--line);
      background: rgba(255,255,255,.02);
      display:grid; place-items:center;
      cursor:pointer;
      user-select:none;
      transition: transform var(--t-fast) var(--ease), background var(--t) var(--ease), border-color var(--t) var(--ease);
      will-change: transform, opacity;
    }
    body.theme-light .iconBtn,
    body.theme-light .leftIcon,
    body.theme-light .rightIcon{
      background: rgba(255,255,255,.55);
    }
    .iconBtn:hover,.leftIcon:hover,.rightIcon:hover{ background: var(--surface); border-color: var(--line2); }
    .iconBtn:active,.leftIcon:active,.rightIcon:active{ transform: scale(.98); }

    /* ====== Home search row ====== */
    .searchRow{
      display:flex;
      align-items:center;
      gap: 10px;
      padding: 10px 0 8px;
    }
    .hamburger{
      width: 42px; height: 42px;
      border-radius: 14px;
      border: 1px solid var(--line);
      background: rgba(255,255,255,.02);
      display:grid; place-items:center;
      cursor:pointer;
      transition: transform var(--t-fast) var(--ease), background var(--t) var(--ease);
    }
    .hamburger:hover{ background: var(--surface); }
    .hamburger:active{ transform: scale(.98); }

    .search{
      flex:1;
      height: 46px;
      border-radius: var(--r999);
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.04);
      display:flex;
      align-items:center;
      gap: 10px;
      padding: 0 14px;
      min-width:0;
      transition: border-color var(--t) var(--ease), background var(--t) var(--ease);
    }
    body.theme-light .search{
      border-color: rgba(15,23,42,.12);
      background: rgba(255,255,255,.80);
    }
    .search:focus-within{
      border-color: rgba(59,130,246,.45);
      box-shadow: 0 0 0 3px rgba(59,130,246,.12);
    }
    .redditDot{
      width: 30px; height: 30px;
      border-radius: var(--r999);
      display:grid; place-items:center;
      border: 1px solid rgba(255,69,0,.35);
      background: rgba(255,69,0,.10);
      flex: 0 0 auto;
    }
    .search input{
      width: 100%;
      border:none;
      outline:none;
      background: transparent;
      color: var(--text);
      font-size: var(--fs-14);
      font-weight: var(--w-regular);
      min-width:0;
    }
    .search input::placeholder{ color: var(--muted2); }

    /* ====== Sub tabs ====== */
    .subTabs{
      display:flex;
      gap: 14px;
      padding: 0 4px 10px;
      border-bottom: 1px solid var(--line);
      overflow:auto;
      -webkit-overflow-scrolling: touch;
    }
    .subTabs::-webkit-scrollbar{ display:none; }
    .subTab{
      color: var(--muted2);
      font-size: var(--fs-14);
      padding: 10px 6px;
      cursor:pointer;
      user-select:none;
      position:relative;
      font-weight: var(--w-semibold);
      white-space: nowrap;
      flex: 0 0 auto;
      transition: color var(--t) var(--ease);
    }
    .subTab.active{ color: var(--text); }
    .subTab.active::after{
      content:"";
      position:absolute;
      left: 6px; right: 6px; bottom: 0px;
      height: 3px;
      border-radius: var(--r999);
      background: rgba(59,130,246,.65);
    }

    /* ====== Banner slot ====== */
    .adSlot{
      padding: 10px 0 12px;
      border-bottom: 1px solid var(--line);
      display:flex;
      flex-direction:column;
      gap: 10px;
    }
    .brandRow{
      display:flex;
      align-items:center;
      gap: 10px;
      min-width:0;
    }
    .brandLogo{
      width: 36px; height: 36px;
      border-radius: 14px;
      border: 1px solid var(--line);
      background: var(--surface);
      overflow:hidden;
      display:grid; place-items:center;
      flex:0 0 auto;
    }
    .brandLogo img{ width:100%; height:100%; object-fit:cover; display:block; }
    .brandText{ min-width:0; }
    .brandText b{
      display:block;
      font-weight: var(--w-bold);
      letter-spacing: -0.3px;
      line-height: 1.1;
      font-size: var(--fs-15);
    }
    .brandText small{
      display:block;
      color: var(--muted2);
      font-weight: var(--w-medium);
      margin-top: 2px;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
      font-size: var(--fs-12);
    }

    .adBanner{
      border-radius: var(--r20);
      border: 1px solid var(--line);
      overflow:hidden;
      background:
        radial-gradient(120% 120% at 10% 0%, rgba(59,130,246,.16) 0%, rgba(255,69,0,.10) 55%, rgba(0,0,0,0) 100%),
        linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,0));
      height: 120px;
      position:relative;
      box-shadow: var(--shadowSoft);
    }
    body.theme-light .adBanner{
      background:
        radial-gradient(120% 120% at 10% 0%, rgba(59,130,246,.10) 0%, rgba(255,69,0,.08) 55%, rgba(255,255,255,0) 100%),
        linear-gradient(180deg, rgba(15,23,42,.04), rgba(15,23,42,0));
    }
    .adBanner img{
      position:absolute; inset:0;
      width:100%; height:100%;
      object-fit:cover;
      display:block;
    }
    .adFallbackText{
      position:absolute; inset:0;
      display:flex;
      align-items:flex-end;
      justify-content:space-between;
      padding: 12px 14px;
      gap: 10px;
      pointer-events:none;
    }
    .adFallbackText b{
      font-weight: var(--w-bold);
      letter-spacing: -0.3px;
      font-size: var(--fs-16);
    }
    .adFallbackText small{
      color: var(--muted);
      font-weight: var(--w-semibold);
      white-space:nowrap;
      font-size: var(--fs-12);
    }
    .adEditBtn{
      position:absolute;
      top:10px;
      right:10px;
      z-index: 5;
      display:none;
      padding: 6px 10px;
      border-radius: var(--r999);
      border: 1px solid rgba(255,255,255,.28);
      background: rgba(0,0,0,.45);
      color:#fff;
      font-size: var(--fs-12);
      font-weight: var(--w-semibold);
      cursor:pointer;
      user-select:none;
    }

    /* ====== Cards ====== */
    .postCard{
      border-radius: var(--r20);
      border: 1px solid var(--cardBorder);
      background: var(--cardBg);
      overflow:hidden;
      margin: 14px 0;
      box-shadow: var(--shadow);
      transform: translateZ(0);
      will-change: transform, opacity;
    }
    .postHead{
      display:flex;
      align-items:center;
      gap: 10px;
      padding: 12px 14px 10px;
      min-width:0;
    }
    .miniAvatar{
      width: 22px; height: 22px;
      border-radius: var(--r999);
      background: #bcc6ce;
      border: 1px solid rgba(0,0,0,.08);
      flex:0 0 auto;
      position: relative;
      overflow: hidden;
    }
    .miniAvatar::before{
      content:"";
      position:absolute;
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: #6f8193;
      left: 50%;
      top: 4px;
      transform: translateX(-50%);
    }
    .miniAvatar::after{
      content:"";
      position:absolute;
      width: 16px;
      height: 10px;
      border-radius: 50% 50% 0 0;
      background: #6f8193;
      left: 50%;
      bottom: 0;
      transform: translateX(-50%);
    }
    .metaLine{
      color: var(--muted);
      font-size: var(--fs-13);
      display:flex;
      gap: 8px;
      align-items:center;
      flex-wrap:wrap;
      min-width:0;
      font-weight: var(--w-regular);
    }
    .metaLine b{ color: var(--text); font-weight: var(--w-semibold); }
    .moreBtn{
      margin-left:auto;
      width: 38px; height: 38px;
      border-radius: var(--r999);
      display:grid; place-items:center;
      border: 1px solid var(--line);
      background: rgba(255,255,255,.02);
      cursor:pointer;
      user-select:none;
      transition: transform var(--t-fast) var(--ease), background var(--t) var(--ease);
      flex:0 0 auto;
    }
    .moreBtn:hover{ background: var(--surface); }
    .moreBtn:active{ transform: scale(.98); }

    .postTitle{
      padding: 0 14px 10px;
      font-size: var(--fs-18);
      font-weight: var(--w-bold);
      letter-spacing: -0.25px;
      cursor:pointer;
      word-break: break-word;
      line-height: 1.25;
    }
    .postBodySmall{
      padding: 0 14px 10px;
      color: var(--muted);
      font-weight: var(--w-regular);
      font-size: var(--fs-13);
      line-height: 1.55;
      word-break: break-word;
    }

    .mediaFrame{
      margin: 0 14px 12px;
      border-radius: var(--r20);
      border: 1px solid var(--line);
      background:
        radial-gradient(120% 120% at 10% 0%, rgba(59,130,246,.14) 0%, rgba(255,69,0,.10) 55%, rgba(0,0,0,0) 100%),
        linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,0));
      min-height: 0;
      overflow:hidden;
      display:block;
      user-select:none;
      cursor:pointer;
      position:relative;
    }
    body.theme-light .mediaFrame{
      background:
        radial-gradient(120% 120% at 10% 0%, rgba(59,130,246,.08) 0%, rgba(255,69,0,.07) 55%, rgba(255,255,255,0) 100%),
        linear-gradient(180deg, rgba(15,23,42,.04), rgba(15,23,42,0));
    }
    .mediaFrame img{
      width:100%; height:auto;
      display:block;
      object-fit:contain;
      background:transparent;
    }
    .mediaFrame video{
      width:100%; height:auto;
      display:block;
      background:#000;
    }
    .mediaLabel{
      position:absolute;
      left:12px; bottom:12px;
      background: rgba(0,0,0,.45);
      color:#fff;
      font-weight: var(--w-semibold);
      font-size: var(--fs-12);
      padding: 6px 10px;
      border-radius: var(--r999);
      border: 1px solid rgba(255,255,255,.16);
      backdrop-filter: blur(10px);
      pointer-events:none;
    }
    body.theme-light .mediaLabel{ background: rgba(15,23,42,.50); }
    .mediaCarousel{
      display:grid;
      grid-auto-flow: column;
      grid-auto-columns: 100%;
      gap: 8px;
      overflow-x: auto;
      overflow-y: hidden;
      scroll-snap-type: x mandatory;
      -webkit-overflow-scrolling: touch;
      scrollbar-width: thin;
    }
    .mediaSlide{
      scroll-snap-align: start;
      border-radius: 12px;
      overflow: hidden;
      border: 1px solid var(--line);
      background: rgba(255,255,255,.02);
    }

    .postActions{
      display:flex;
      align-items:center;
      gap: 10px;
      padding: 0 14px 14px;
      flex-wrap:wrap;
    }

    /* vote - softer */
    .voteBox{
      display:inline-flex;
      align-items:center;
      gap: 8px;
      padding: 8px 10px;
      border-radius: var(--r999);
      border: 1px solid var(--line);
      background: rgba(255,255,255,.02);
      user-select:none;
    }
    .voteBtn{
      display:inline-flex;
      align-items:center;
      gap: 8px;
      padding: 8px 10px;
      border-radius: var(--r999);
      border: 1px solid transparent;
      background: transparent;
      cursor:pointer;
      font-weight: var(--w-semibold);
      font-size: var(--fs-13);
      transition: transform var(--t-fast) var(--ease), background var(--t) var(--ease), border-color var(--t) var(--ease);
    }
    .voteBtn:active{ transform: scale(.99); }
    .voteBtn.disabled{ opacity:.45; cursor:not-allowed; }
    .voteCount{ min-width: 18px; text-align:center; font-weight: var(--w-semibold); opacity:.92; }
    .voteBtn.good.active{ border-color: rgba(34,197,94,.28); background: rgba(34,197,94,.10); }
    .voteBtn.bad.active{ border-color: rgba(239,68,68,.28); background: rgba(239,68,68,.10); }

    .pillBtn{
      display:inline-flex;
      align-items:center;
      gap: 8px;
      padding: 10px 12px;
      border-radius: var(--r999);
      border: 1px solid var(--line);
      background: rgba(255,255,255,.02);
      color: var(--text);
      cursor:pointer;
      user-select:none;
      font-weight: var(--w-semibold);
      font-size: var(--fs-13);
      white-space:nowrap;
      transition: transform var(--t-fast) var(--ease), background var(--t) var(--ease);
    }
    .pillBtn:hover{ background: var(--surface); }
    .pillBtn:active{ transform: scale(.99); }
    .pillBtn.muted{ color: var(--muted); }
    .pillBtn.disabled{ opacity:.45; cursor:not-allowed; }

    /* ====== Sections / helpers ====== */
    .sectionTitle{
      margin: 18px 0 10px;
      font-weight: var(--w-bold);
      letter-spacing: -0.2px;
      color: var(--text);
      font-size: var(--fs-16);
    }
    .muted{ color: var(--muted); }
    .muted2{ color: var(--muted2); }
    .spacer{ height: 12px; }
    .divider{ height:1px; background: var(--line); margin: 14px 0; }

    /* ====== Community cards ====== */
    .chips{
      display:flex;
      flex-wrap:wrap;
      gap: 10px;
      padding: 14px 0 6px;
    }
    .chip{
      padding: 10px 12px;
      border-radius: var(--r999);
      border: 1px solid var(--line);
      background: rgba(255,255,255,.02);
      color: var(--muted);
      font-weight: var(--w-semibold);
      font-size: var(--fs-13);
      cursor:pointer;
      user-select:none;
      transition: background var(--t) var(--ease), border-color var(--t) var(--ease);
    }
    .chip:hover{ background: var(--surface); border-color: var(--line2); }

    .commCard{
      display:flex;
      align-items:center;
      gap: 12px;
      padding: 14px;
      border-radius: var(--r24);
      border: 1px solid var(--cardBorder);
      background: var(--cardBg);
      margin: 12px 0;
      box-shadow: var(--shadowSoft);
      min-width:0;
      transition: transform var(--t-fast) var(--ease);
    }
    .commCard:active{ transform: scale(.995); }
    .commIcon{
      width: 44px; height: 44px;
      border-radius: var(--r999);
      border: 1px solid var(--line);
      background: rgba(255,255,255,.02);
      display:grid; place-items:center;
      font-weight: var(--w-bold);
      flex:0 0 auto;
    }
    .commMeta{ flex:1; min-width:0; }
    .commName{ font-weight: var(--w-bold); margin-bottom: 4px; letter-spacing:-.2px; }
    .commSub{
      color: var(--muted);
      font-size: var(--fs-13);
      line-height: 1.35;
      overflow:hidden;
      text-overflow:ellipsis;
      display:-webkit-box;
      -webkit-line-clamp:2;
      -webkit-box-orient: vertical;
      font-weight: var(--w-regular);
    }
    .joinBtn{
      padding: 10px 14px;
      border-radius: var(--r999);
      border: 1px solid rgba(59,130,246,.28);
      background: rgba(59,130,246,.12);
      color: var(--text);
      font-weight: var(--w-semibold);
      cursor:pointer;
      user-select:none;
      flex:0 0 auto;
      white-space:nowrap;
      transition: transform var(--t-fast) var(--ease), background var(--t) var(--ease);
    }
    .joinBtn:hover{ background: rgba(59,130,246,.16); }
    .joinBtn:active{ transform: scale(.99); }
    .joinBtn.joined{
      border-color: rgba(255,69,0,.28);
      background: rgba(255,69,0,.12);
    }

    /* ====== Inbox ====== */
    .segTabs{
      display:flex;
      justify-content:center;
      gap: 36px;
      border-bottom: 1px solid var(--line);
      padding: 6px 0 0;
      margin-top: 6px;
    }
    .segTab{
      position:relative;
      padding: 12px 12px 14px;
      color: var(--muted2);
      font-weight: var(--w-semibold);
      cursor:pointer;
      user-select:none;
      white-space:nowrap;
      transition: color var(--t) var(--ease);
    }
    .segTab.active{ color: var(--text); }
    .segTab.active::after{
      content:"";
      position:absolute;
      left: 10px; right: 10px; bottom: 0;
      height: 3px;
      background: rgba(59,130,246,.65);
      border-radius: var(--r999);
    }
    .dot{
      width: 7px; height: 7px;
      border-radius: var(--r999);
      background: var(--danger);
      display:inline-block;
      margin-left: 6px;
      transform: translateY(-3px);
    }
    .inboxList{ padding: 14px 0; }
    .noticeCard{
      display:flex;
      gap: 12px;
      padding: 14px;
      border-radius: var(--r20);
      border: 1px solid var(--cardBorder);
      background:
        linear-gradient(160deg, rgba(59,130,246,.11) 0%, rgba(59,130,246,.06) 44%, rgba(255,69,0,.09) 100%),
        linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
      margin: 12px 0;
      box-shadow: var(--shadowSoft);
      cursor:pointer;
      user-select:none;
      min-width:0;
      transition: transform var(--t-fast) var(--ease);
    }
    .noticeCard:active{ transform: scale(.995); }
    .noticeIcon{
      width: 42px; height: 42px;
      border-radius: var(--r999);
      border: 1px solid var(--line);
      background: rgba(255,255,255,.02);
      display:grid; place-items:center;
      flex:0 0 auto;
    }
    .noticeText{ min-width:0; }
    .noticeText b{
      display:block;
      margin-bottom: 4px;
      font-weight: var(--w-bold);
      letter-spacing:-.2px;
      font-size: var(--fs-14);
    }
    .noticeText .body{
      color: var(--muted);
      font-weight: var(--w-regular);
      font-size: var(--fs-13);
      line-height: 1.35;
      word-break: break-word;
    }
    .noticeText small{
      display:block;
      margin-top: 6px;
      color: var(--muted2);
      font-weight: var(--w-semibold);
      font-size: var(--fs-12);
    }

    /* ====== Buttons / Inputs ====== */
    .btn{
      padding: 10px 12px;
      border-radius: 14px;
      border: 1px solid var(--line);
      background: rgba(255,255,255,.02);
      cursor:pointer;
      user-select:none;
      font-weight: var(--w-semibold);
      display:inline-flex;
      align-items:center;
      gap: 8px;
      white-space:nowrap;
      transition: transform var(--t-fast) var(--ease), background var(--t) var(--ease), border-color var(--t) var(--ease);
    }
    .btn:hover{ background: var(--surface); border-color: var(--line2); }
    .btn:active{ transform: scale(.99); }
    .btn.primary{
      border-color: rgba(255,69,0,.28);
      background: rgba(255,69,0,.12);
    }
    .btn.blue{
      border-color: rgba(59,130,246,.28);
      background: rgba(59,130,246,.12);
    }
    .btn.danger{
      border-color: rgba(239,68,68,.28);
      background: rgba(239,68,68,.10);
    }
    .btn.disabled{ opacity:.5; cursor:not-allowed; }

    .input{
      width:100%;
      border-radius: 14px;
      border: 1px solid var(--line);
      background: rgba(255,255,255,.02);
      padding: 12px 12px;
      outline:none;
      font-weight: var(--w-regular);
      transition: border-color var(--t) var(--ease), background var(--t) var(--ease);
    }
    body.theme-light .input{ background: rgba(255,255,255,.70); }
    .input:focus{
      border-color: rgba(59,130,246,.45);
      box-shadow: 0 0 0 3px rgba(59,130,246,.12);
    }
    textarea.input{
      min-height: 120px;
      resize:none;
      line-height:1.55;
    }
    .hint{
      color: var(--muted2);
      font-weight: var(--w-medium);
      font-size: var(--fs-12);
      margin-top: 8px;
      line-height: 1.45;
    }
    .authCodeDigit{
      width: 42px;
      height: 46px;
      border-radius: 12px;
      border: 1px solid var(--line);
      background: rgba(255,255,255,.02);
      color: var(--text);
      text-align: center;
      font-size: 20px;
      font-weight: var(--w-bold);
      outline: none;
    }
    .authCodeDigit:focus{
      border-color: rgba(59,130,246,.45);
      box-shadow: 0 0 0 3px rgba(59,130,246,.12);
    }

    /* ====== Bottom Nav ====== */
    .bottomNav{
      position: fixed;
      left:0; right:0;
      bottom:0;
      z-index: 60;
      background: var(--navBlur);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      border-top: 1px solid var(--line);
      padding-bottom: var(--botPad);
    }
    .navInner{
      max-width: var(--maxW);
      margin: 0 auto;
      padding: 10px 10px 10px;
      display:flex;
      justify-content:space-between;
      align-items:flex-end;
      gap: 8px;
    }
    .navItem{
      flex:1;
      min-width:0;
      display:flex;
      flex-direction:column;
      align-items:center;
      gap: 6px;
      color: var(--muted2);
      cursor:pointer;
      user-select:none;
      font-weight: var(--w-semibold);
      transition: color var(--t) var(--ease);
    }
    .navItem.active{ color: var(--text); }
    .navIcon{
      width: 40px; height: 40px;
      border-radius: 14px;
      display:grid; place-items:center;
      border: 1px solid var(--line);
      background: rgba(255,255,255,.02);
      position:relative;
      transition: background var(--t) var(--ease), border-color var(--t) var(--ease), transform var(--t-fast) var(--ease);
    }
    .navItem:hover .navIcon{ background: var(--surface); border-color: var(--line2); }
    .navItem:active .navIcon{ transform: scale(.98); }

    .badge{
      position:absolute;
      top: -6px; right: -6px;
      display:none;
      min-width: 22px;
      text-align:center;
      background: linear-gradient(135deg, #ff6b6b 0%, #dc2626 100%);
      color:#fff;
      font-weight: var(--w-bold);
      font-size: 11px;
      padding: 3px 7px;
      border-radius: 10px;
      border: 1px solid rgba(255,255,255,.24);
      box-shadow: 0 6px 14px rgba(220,38,38,.35);
    }
    body.theme-light .badge{
      border-color: rgba(255,255,255,.85);
      box-shadow: 0 6px 14px rgba(220,38,38,.22);
    }
    .navLabel{
      font-size: var(--fs-11);
      font-weight: var(--w-semibold);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      max-width: 100%;
    }

    .quickMyBtn{
      position: fixed;
      right: max(16px, calc((100vw - var(--maxW))/2 + 18px));
      top: calc(var(--topPad) + 64px);
      z-index: 72;
      display:flex;
      align-items:center;
      gap: 8px;
      padding: 7px 10px 7px 7px;
      border-radius: 999px;
      border: 1px solid var(--line);
      background: var(--navBlur);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      cursor:pointer;
      color: var(--text);
      font-weight: var(--w-semibold);
      font-size: 12px;
      box-shadow: var(--shadowSoft);
    }
    .quickMyBtn:active{ transform: scale(.98); }
    .quickMyBtn .avatar{
      width: 24px;
      height: 24px;
      border-radius: 999px;
      border: 1px solid var(--line2);
      background: #8fa0b3;
      position:relative;
      flex: 0 0 auto;
      overflow:hidden;
    }
    .quickMyBtn .avatar::before{
      content:"";
      position:absolute;
      left:50%;
      top:4px;
      width:9px;
      height:9px;
      transform:translateX(-50%);
      border-radius:999px;
      background:#c2ccd7;
    }
    .quickMyBtn .avatar::after{
      content:"";
      position:absolute;
      left:50%;
      bottom:-8px;
      width:20px;
      height:16px;
      transform:translateX(-50%);
      border-radius: 14px 14px 8px 8px;
      background:#c2ccd7;
    }

    /* ====== Overlays ====== */
    .overlay{
      position:fixed;
      inset:0;
      background: var(--overlay);
      display:none;
      z-index: 90;
      padding: calc(var(--topPad) + 10px) 18px calc(var(--botPad) + 10px);
    }
    .overlay.open{ display:block; }
    .overlay.strong{ background: var(--overlayStrong); }

    #menuOverlay{
      background: transparent !important;
      padding: 0;
    }
    .menuPopup{
      position: fixed;
      z-index: 200;
      min-width: 220px;
      max-width: 280px;
      border-radius: 14px;
      border: 1px solid var(--line2);
      background: #0f1116;
      box-shadow: 0 14px 40px rgba(0,0,0,.45);
      overflow: hidden;
    }
    body.theme-light .menuPopup{
      background:#ffffff;
      box-shadow: 0 12px 30px rgba(15,23,42,.18);
    }
    .menuHead{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:8px;
      padding:10px 12px;
      border-bottom: 1px solid var(--line);
    }
    .menuClose{
      width:24px;height:24px;
      border-radius:999px;
      border:1px solid var(--line);
      display:grid;place-items:center;
      cursor:pointer;
      color:var(--muted);
      font-size:12px;
    }
    .menuList{ padding: 6px 0; }
    .menuItem{
      display:flex;
      align-items:center;
      gap:10px;
      padding: 10px 10px;
      margin: 0 6px;
      border-radius: 10px;
      color: var(--text);
      cursor:pointer;
      user-select:none;
      font-size: 14px;
    }
    .menuItem:hover{ background: var(--surface); }
    .menuItem.danger{ color: #ff7f7f; }
    .menuItem .ico{
      width:16px;
      text-align:center;
      opacity:.9;
      flex: 0 0 auto;
    }

    .sheet{
      max-width: var(--maxW);
      margin: 0 auto;
      border-radius: var(--r24);
      border: 1px solid var(--line);
      background: var(--cardBg);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .sheetHeader{
      display:flex;
      align-items:center;
      gap: 10px;
      padding: 12px 14px;
      border-bottom: 1px solid var(--line);
      font-weight: var(--w-semibold);
    }
    .sheetHeader .sp{ flex:1; }
    .sheetBody{ padding: 14px; }

    /* ====== Drawer ====== */
    .drawer{
      position:fixed;
      top:0; left:0;
      height:100%;
      width: var(--drawer-w);
      max-width: min(86vw, var(--drawer-w));
      background: var(--drawerBg);
      border-right: 1px solid var(--line);
      box-shadow: var(--shadow);
      transform: translate3d(-24px,0,0);
      opacity:0;
      transition: transform var(--t-smooth) cubic-bezier(.22,1,.36,1), opacity var(--t) var(--ease);
      will-change: transform, opacity;
      padding-top: var(--topPad);
      z-index: 110;
      pointer-events: none;
    }

    .drawer.open{
      transform: translate3d(0,0,0);
      opacity: 1;
      pointer-events: auto;
    }

    .drawerOverlay{
      position:fixed;
      top:0; bottom:0; right:0;
      left: var(--drawer-w);
      z-index: 100;
      /* keep overlay transparent so right side isn't dimmed */
      background: transparent;
      opacity: 0;
      transition: opacity var(--t) var(--ease);
      pointer-events: none;
    }

    .drawerOverlay.open{
      opacity: 1;
      pointer-events: auto;
    }
    .drawerTop{
      padding: 14px 14px 10px;
      display:flex;
      align-items:center;
      gap: 10px;
      border-bottom: 1px solid var(--line);
    }
    .drawerBrand{
      display:flex;
      align-items:center;
      gap: 10px;
      min-width:0;
      flex:1;
    }
    .drawerBrand b{
      display:block;
      font-weight: var(--w-bold);
      letter-spacing:-.2px;
      line-height:1.1;
      font-size: var(--fs-14);
    }
    .drawerBrand small{
      display:block;
      color: var(--muted2);
      font-weight: var(--w-medium);
      margin-top:2px;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
      font-size: var(--fs-12);
    }
    .drawerClose{
      width: 40px; height: 40px;
      border-radius: var(--r999);
      display:grid; place-items:center;
      border: 1px solid var(--line);
      background: rgba(255,255,255,.02);
      cursor:pointer;
      user-select:none;
      transition: transform var(--t-fast) var(--ease), background var(--t) var(--ease);
      flex:0 0 auto;
    }
    .drawerClose:hover{ background: var(--surface); }
    .drawerClose:active{ transform: scale(.98); }
    .drawerBody{
      padding: 12px 14px 18px;
      overflow:auto;
      height: calc(100% - 72px);
    }
    .drawerItem{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      padding: 12px 12px;
      border-radius: var(--r16);
      border: 1px solid var(--line);
      background: rgba(255,255,255,.02);
      margin: 10px 0;
      cursor:pointer;
      user-select:none;
      transition: background var(--t) var(--ease), border-color var(--t) var(--ease);
    }
    .drawerItem:hover{ background: var(--surface); border-color: var(--line2); }
    .drawerItem .l{
      display:flex;
      align-items:center;
      gap: 10px;
      font-weight: var(--w-semibold);
      min-width:0;
    }
    .drawerItem .l span{ white-space:nowrap; }
    .drawerItem .r{
      color: var(--muted2);
      font-weight: var(--w-medium);
      white-space:nowrap;
      font-size: var(--fs-12);
    }
    .drawerSectionTitle{
      margin-top: 14px;
      margin-bottom: 8px;
      color: var(--muted2);
      font-size: 12px;
      font-weight: var(--w-semibold);
      letter-spacing: .2px;
    }
    .drawerMiniList .drawerItem{
      margin: 8px 0;
      padding: 10px 12px;
      background: rgba(255,255,255,.01);
    }
    .drawerMiniEmpty{
      margin: 8px 0;
      padding: 10px 12px;
      border: 1px dashed var(--line);
      border-radius: 12px;
      color: var(--muted2);
      font-size: 12px;
      font-weight: var(--w-medium);
    }
    .profileHero{
      margin: 12px 0;
      border: 1px solid var(--line);
      border-radius: var(--r20);
      overflow: hidden;
      background:
        linear-gradient(180deg, rgba(37,99,235,.75) 0%, rgba(10,14,26,.95) 55%, rgba(10,14,26,1) 100%);
    }
    .profileHeroTop{
      padding: 16px 14px;
      min-height: 132px;
      display:flex;
      align-items:flex-end;
      justify-content:space-between;
      gap: 12px;
    }
    .simpleAvatar{
      width: 72px;
      height: 72px;
      border-radius: 50%;
      border: 2px solid rgba(255,255,255,.25);
      background: #bcc6ce;
      position: relative;
      overflow:hidden;
      flex:0 0 auto;
    }
    .simpleAvatar::before{
      content:"";
      position:absolute;
      width: 28px;
      height: 28px;
      border-radius: 50%;
      background: #6f8193;
      left: 50%;
      top: 13px;
      transform: translateX(-50%);
    }
    .simpleAvatar::after{
      content:"";
      position:absolute;
      width: 56px;
      height: 34px;
      border-radius: 50% 50% 0 0;
      background: #6f8193;
      left: 50%;
      bottom: 3px;
      transform: translateX(-50%);
    }
    .profileTabs{
      display:flex;
      border-top: 1px solid var(--line);
      background: rgba(10,14,26,.45);
    }
    .profileTab{
      flex:1;
      text-align:center;
      padding: 12px 8px;
      font-weight: var(--w-semibold);
      color: var(--muted2);
      border-bottom: 2px solid transparent;
      cursor:pointer;
      user-select:none;
    }
    .profileTab.active{
      color: var(--text);
      border-bottom-color: rgba(59,130,246,.8);
    }
    .profilePanel{ display:none; }
    .profilePanel.active{ display:block; }
    .pullRefresh{
      position: sticky;
      top: 0;
      z-index: 40;
      height: 0;
      overflow: visible;
      display:flex;
      justify-content:center;
      pointer-events:none;
    }
    .pullBubble{
      margin-top: 6px;
      min-width: 128px;
      padding: 8px 12px;
      border-radius: 999px;
      border: 1px solid var(--line);
      background: rgba(10,14,26,.88);
      color: var(--text);
      font-size: 12px;
      font-weight: var(--w-semibold);
      opacity: 0;
      transform: translateY(-22px) scale(.94);
      transition: transform 180ms ease, opacity 180ms ease;
      display:flex;
      align-items:center;
      gap:8px;
    }
    .pullBubble.open{
      opacity: 1;
      transform: translateY(0) scale(1);
    }
    .pullArrow{
      width: 16px;
      height:16px;
      display:inline-block;
      border-left: 2px solid currentColor;
      border-bottom: 2px solid currentColor;
      transform: rotate(-45deg);
      transition: transform 180ms ease;
    }
    .pullBubble.ready .pullArrow{
      transform: rotate(135deg);
    }

    /* Ensure closed drawer doesn't block interactions */
    .drawer{ pointer-events: none; }
    .drawer.open{ pointer-events: auto; }


    /* ====== Auth Gate (Google + domain restricted) ====== */
    .gateOverlay{
      position:fixed;
      inset:0;
      z-index: 120;
      display:none;
      background: rgba(0,0,0,.35);
      backdrop-filter: blur(18px);
      -webkit-backdrop-filter: blur(18px);
    }
    body.theme-light .gateOverlay{ background: rgba(15,23,42,.22); }
    .gateOverlay.open{ display:block; }

    .gateSheet{
      position:absolute;
      left:0; right:0;
      bottom:0;
      padding-bottom: calc(var(--botPad) + 14px);
    }
    .gateInner{
      max-width: var(--maxW);
      margin: 0 auto;
      padding: 0 12px;
    }
    .gateCard{
      border-radius: var(--r24);
      border: 1px solid var(--line);
      background: var(--cardBg);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .gateHeader{
      display:flex;
      align-items:center;
      gap: 10px;
      padding: 14px 14px;
      border-bottom: 1px solid var(--line);
      font-weight: var(--w-semibold);
    }
    .gateHeader .sp{ flex:1; }
    .gateBody{ padding: 14px; }
    .tabsMini{
      display:flex;
      gap: 10px;
      margin-bottom: 12px;
    }
    .tabMini{
      flex:1;
      text-align:center;
      padding: 10px 12px;
      border-radius: var(--r999);
      border: 1px solid var(--line);
      background: rgba(255,255,255,.02);
      font-weight: var(--w-semibold);
      cursor:pointer;
      user-select:none;
      opacity:.85;
      transition: opacity var(--t) var(--ease), background var(--t) var(--ease), border-color var(--t) var(--ease);
    }
    .tabMini.active{
      opacity: 1;
      border-color: rgba(59,130,246,.30);
      background: rgba(59,130,246,.12);
    }

    .inlineEmail{
      display:flex;
      align-items:center;
      gap: 8px;
      border: 1px solid var(--line);
      background: rgba(255,255,255,.02);
      border-radius: 14px;
      padding: 10px 12px;
    }
    .inlineEmail code{
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
      font-weight: var(--w-semibold);
      font-size: 13px;
      opacity:.92;
    }
    .inlineEmail input{
      width: 92px;
      text-align:center;
      border:none;
      outline:none;
      background: transparent;
      font-weight: var(--w-semibold);
      font-size: 14px;
      letter-spacing: .6px;
    }
    .grid3{
      display:grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 10px;
      margin-top: 10px;
    }
    .grid3 .input{ padding: 12px 10px; text-align:center; }

    .gateNote{
      margin-top: 10px;
      color: var(--muted2);
      font-weight: var(--w-medium);
      font-size: var(--fs-12);
      line-height: 1.45;
    }

    .googleRow{
      margin-top: 12px;
      display:flex;
      flex-direction:column;
      gap: 10px;
    }
    .googleHintPill{
      border: 1px solid var(--line);
      background: rgba(255,255,255,.02);
      border-radius: 14px;
      padding: 10px 12px;
      font-size: var(--fs-12);
      color: var(--muted);
      line-height: 1.45;
    }
    .googleBtnWrap{
      display:flex;
      gap: 10px;
      align-items:center;
      flex-wrap:wrap;
    }
    .googleBtnMount{
      min-height: 44px;
      display:flex;
      align-items:center;
    }

    .gateFooter{
      padding: 12px 14px 14px;
      border-top: 1px solid var(--line);
      display:flex;
      gap: 10px;
      align-items:center;
      justify-content:space-between;
      flex-wrap:wrap;
    }
    .linkLike{
      color: var(--muted);
      font-weight: var(--w-semibold);
      cursor:pointer;
      user-select:none;
    }

    /* ====== Toast ====== */
    .toast{
      position:fixed;
      left:0; right:0;
      bottom: calc(var(--navH) + var(--botPad) + 18px);
      z-index: 140;
      opacity: 0;
      transform: translateY(8px);
      pointer-events:none;
      transition: opacity var(--t) var(--ease), transform var(--t) var(--ease);
      will-change: opacity, transform;
      display:block;
    }
    .toast.show{
      opacity: 1;
      transform: translateY(0);
    }
    .toast .inner{
      max-width: var(--maxW);
      margin: 0 auto;
      padding: 0 18px;
      display:flex;
      justify-content:center;
      pointer-events:none;
    }
    .toast .pill{
      background: rgba(0,0,0,.55);
      color:#fff;
      border: 1px solid rgba(255,255,255,.14);
      border-radius: var(--r999);
      padding: 10px 14px;
      font-weight: var(--w-semibold);
      font-size: var(--fs-13);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      box-shadow: var(--shadowSoft);
    }
    body.theme-light .toast .pill{ background: rgba(15,23,42,.65); }

    /* Apple-like entrance animation helpers */
    .animate-in{
      opacity: 0;
      transform: translateY(12px) scale(.985);
      transition: transform 520ms cubic-bezier(.22,1,.36,1), opacity 360ms var(--ease);
      transition-delay: var(--enter-delay, 0ms);
      will-change: transform, opacity;
    }
    .animate-in.is-visible{
      opacity: 1;
      transform: translateY(0) scale(1);
    }

    .commPanel{ display:none; }
    .commPanel.active{ display:block; }
    .reviewCard{
      border: 1px solid var(--line);
      border-radius: var(--r16);
      padding: 12px;
      margin: 10px 0;
      background: rgba(255,255,255,.02);
    }
    .reviewMeta{
      color: var(--muted2);
      font-size: 12px;
      margin-top: 6px;
      line-height: 1.45;
    }
    .reviewActions{
      display:flex;
      gap:8px;
      margin-top: 10px;
    }

    /* Create screen: left-bottom toolbar */
    #screen-create > .wrap{ position: relative; padding-top: 10px; padding-bottom: calc(var(--navH) + var(--botPad) + 96px); }
    /* bring community select much closer to topbar/title */
    #screen-create > .wrap{ margin-top: 0; }
    .createToolbar{
      position: fixed;
      left: %;
      width: auto;
      justify-content: flex-start;
      bottom: calc(var(--botPad) + 6px);
      display:flex;
      gap:6px;
      z-index: 90;
      align-items: flex-end;
      transform: translateX(calc(-50% + 18px));
      padding: 0;
      border: none;
      background: transparent;
      backdrop-filter: none;
      -webkit-backdrop-filter: none;
      box-shadow: none;
    }
    .createAction{
      display:flex;
      flex-direction:column;
      align-items:center;
      gap:6px;
      background: transparent;
      border-radius: 12px;
      padding: 6px 8px;
      cursor: pointer;
      color: var(--muted);
      font-size: 12px;
      user-select:none;
      transition: background var(--t) var(--ease), transform var(--t-fast) var(--ease), color var(--t) var(--ease);
    }
    .createAction .icon{
      width:44px; height:44px; display:grid; place-items:center; border-radius:12px; background: transparent; border:1px solid var(--line);
    }
    .createAction:hover{ color: var(--text); }
    .createAction:active{ transform: translateY(2px); }
    .createAction .label{ font-size:11px; color:var(--muted2); }
    #pollBox{ display:none; margin-top:12px; padding:10px; border-radius:12px; background:var(--cardBg); border:1px solid var(--line); }
    #composeMediaPreview{ margin-bottom: 86px !important; }
    /* hide bottom nav while composing */
    body.compose-mode .bottomNav{ display:none !important; }

    /* Unified compose area: remove boxed inputs and visually merge title + body */
    #screen-create .input{ background: transparent; border: none; box-shadow: none; padding: 0; margin: 0; color: var(--text); }
    #composeTitle{ font-size: var(--fs-20); font-weight: var(--w-bold); margin-top: 34px; margin-bottom:280px; }
    #composeBody{ font-size: var(--fs-15); line-height:1.6; margin-top:12px; }
    /* tighter topbar when composing so post button and title feel closer */
    body.compose-mode .topbar-inner{ padding: 4px 6px; }
    /* reduce top safe-area padding in compose-mode to remove large blank space on tablets */
    body.compose-mode .topbar{ padding-top: calc(var(--topPad) + 0px); }
    #composeTitle::placeholder, #composeBody::placeholder{ color: var(--muted2); }
    /* pull community selector upward */
    #screen-create #communitySelect{ margin-top:0; }
    /* Remove large preview/banner that may appear above compose fields in create screen */
    #screen-create .mediaFrame,
    #screen-create .adBanner,
    #screen-create .preview,
    #screen-create .composePreview,
    #screen-create .media-preview,
    #screen-create img.compose-img,
    #screen-create #adBanner,
    #screen-create #adBannerImg { display: none !important; max-height: 0 !important; height: 0 !important; margin:0 !important; padding:0 !important; }
    /* Hide any debug/global variable boxes or runtime-inserted previews inside compose screen */
    #screen-create #sheetErrors,
    #screen-create .sheetErrors,
    #screen-create #mediaPreview,
    #screen-create .media-preview,
    #screen-create .googleHintPill,
    #screen-create .debug,
    #screen-create .devBox,
    #screen-create .globalVars,
    #screen-create #globalVars,
    #screen-create pre,
    #screen-create code { display: none !important; max-height: 0 !important; height: 0 !important; margin:0 !important; padding:0 !important; overflow:hidden !important; }
    /* also hide any ad/banner when in compose-mode to ensure no large block appears */
    body.compose-mode .adBanner, body.compose-mode .mediaFrame, body.compose-mode .composePreview, body.compose-mode .media-preview{ display:none !important; max-height:0 !important; height:0 !important; }

    /* If a different "write sheet" overlay exists elsewhere in project, hide it when composing
       so our inline `#screen-create` is used instead. This covers templates that include
       `#writeSheet`, `.sheet-backdrop`, `#sheetBackdrop`, `#sheetErrors`, and `#mediaPreview`. */
    #writeSheet, .sheet-backdrop, #sheetBackdrop, #sheetErrors, #mediaPreview,
    body.compose-mode #writeSheet, body.compose-mode .sheet-backdrop, body.compose-mode #sheetBackdrop,
    body.compose-mode #sheetErrors, body.compose-mode #mediaPreview {
      display: none !important;
      opacity: 0 !important;
      pointer-events: none !important;
      max-height: 0 !important;
      height: 0 !important;
      overflow: hidden !important;
    }

    /* Ensure toolbar icons sit flush on iPad small inset */
    .createAction .icon{ width:40px; height:40px; }

    .ibAppCard{
      padding:14px;
      margin:10px 0;
      border-radius: 16px;
      border: 1px solid var(--line);
      background: rgba(255,255,255,.03);
    }
    .ibAppTop{
      display:flex;
      gap:12px;
      align-items: center;
    }
    .ibAppThumb{
      width:64px;
      height:64px;
      border-radius: 14px;
      object-fit: cover;
      border:1px solid var(--line2);
      background: rgba(255,255,255,.06);
      flex: 0 0 auto;
    }
    .ibAppFeatures{
      margin-top:10px;
      display:flex;
      flex-wrap: wrap;
      gap:6px;
    }
    .ibFeatureChip{
      font-size:11px;
      border:1px solid var(--line);
      border-radius: 999px;
      padding:4px 8px;
      color: var(--muted);
      background: rgba(255,255,255,.03);
    }
    .ibAppActions{
      margin-top:10px;
      display:flex;
      gap:8px;
      flex-wrap: wrap;
    }

    /* subtle card hover lift */
    .postCard:hover, .commCard:hover{
      transform: translateY(-6px);
      box-shadow: 0 20px 50px rgba(0,0,0,.45);
      transition: transform 260ms cubic-bezier(.22,1,.36,1), box-shadow 260ms var(--ease);
    }

    /* bottom nav icon gentle lift when active */
    .navItem .navIcon{ transition: transform 360ms cubic-bezier(.22,1,.36,1), background var(--t) var(--ease); will-change: transform; }
    .navItem.active .navIcon{ transform: translateY(-4px) scale(1.04); box-shadow: var(--shadowSoft); }

    /* ====== Responsive: phone / tablet / laptop ====== */
    /* phone */
    @media (max-width: 520px){
      :root{ --maxW: var(--maxWPhone); }
      .wrap{ padding: 0 14px; }
      .navIcon{ width: 38px; height: 38px; border-radius: 13px; }
      .navLabel{ font-size: 10.5px; }
      .postTitle{ font-size: var(--fs-18); }
    }

    /* tablet */
    @media (min-width: 521px) and (max-width: 980px){
      :root{ --maxW: var(--maxWPad); }
      .wrap{ padding: 0 18px; }
    }

    /* laptop/desktop: 조금 더 “앱”처럼 */
    @media (min-width: 981px){
      .wrap{ padding: 0 22px; }
      .adBanner{ height: 136px; }
      .postCard{ margin: 16px 0; }
      .navInner{ padding: 10px 18px 10px; }
    }
  </style>
</head>
<body>
<div class="app">
  <div class="stage" id="stage">

    <!-- ================= HOME ================= -->
    <section class="screen active" id="screen-home" aria-label="홈">
      <div class="topbar">
        <div class="wrap">

          <div class="searchRow">
            <div class="hamburger" id="homeMenuBtn" title="메뉴">
              <svg width="22" height="22" viewBox="0 0 24 24" fill="none">
                <path d="M4 7h16M4 12h16M4 17h16" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
              </svg>
            </div>

            <div class="search">
              <div class="redditDot" aria-hidden="true">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none">
                  <path d="M12 3c5 0 9 4 9 9s-4 9-9 9-9-4-9-9 4-9 9-9Z" stroke="currentColor" stroke-width="2" opacity=".9"/>
                  <path d="M8.2 14.2c1.2 1.1 2.6 1.7 3.8 1.7s2.6-.6 3.8-1.7" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                </svg>
              </div>
              <input id="homeSearch" placeholder="무엇이든 찾아보세요" />
            </div>
          </div>

          <div class="subTabs" id="homeSubtabs">
            <div class="subTab active" data-sub="home">홈</div>
            <div class="subTab" data-sub="news">뉴스</div>
            <div class="subTab" data-sub="latest">최신</div>
          </div>

          <div class="adSlot">
            <div class="brandRow">
              <div class="brandLogo" id="brandLogo">
                <img id="brandLogoImg" src="assets/logo.svg" alt="logo" />
              </div>
              <div class="brandText">
                <b>표고모</b>
                <small>Apple 톤 + Reddit 구조 • 커뮤니티 데모</small>
              </div>
            </div>

            <div class="adBanner" id="adBanner">
              <img id="adBannerImg" src="assets/ad-banner.png" alt="ad" />
              <div class="adFallbackText" aria-hidden="true">
                <b id="adBannerTitle">오늘의 배너</b>
                <small id="adBannerSubtitle">스크린샷 느낌</small>
              </div>
              <div class="adEditBtn" id="adEditBtn">배너 수정</div>
            </div>
          </div>

        </div>
      </div>

      <div class="wrap">
        <div class="pullRefresh" id="pullRefresh">
          <div class="pullBubble" id="pullBubble"><span class="pullArrow"></span><span id="pullText">당겨서 새로고침</span></div>
        </div>
        <div class="spacer"></div>
        <div id="homeFeed"></div>
        <div class="spacer"></div>
      </div>
    </section>

    <!-- ================= COMMUNITIES ================= -->
    <section class="screen" id="screen-comm" aria-label="커뮤니티">
      <div class="topbar">
        <div class="wrap">
          <div class="topbar-inner">
            <div class="leftIcon" id="commMenuBtn" title="메뉴">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none">
                <path d="M4 7h16M4 12h16M4 17h16" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
              </svg>
            </div>
            <div class="titleCenter">커뮤니티</div>
            <div class="rightIcon" id="commCreateBtn" title="커뮤니티 만들기">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
                <path d="M12 5v14M5 12h14" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
              </svg>
            </div>
          </div>
        </div>
      </div>

      <div class="wrap">
        <div class="spacer"></div>
        <div class="segTabs" id="commTabs">
          <div class="segTab active" data-comm-tab="explore">검색/둘러보기</div>
          <div class="segTab" data-comm-tab="create">커뮤니티 만들기</div>
          <div class="segTab" data-comm-tab="review">신청 관리</div>
        </div>

        <div class="commPanel active" id="commPanelExplore">
          <div class="search" style="margin-top:12px;">
            <svg width="17" height="17" viewBox="0 0 24 24" fill="none"><circle cx="11" cy="11" r="7" stroke="currentColor" stroke-width="2"/><path d="M20 20l-3-3" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
            <input id="commSearchInput" placeholder="커뮤니티 이름/설명 검색" />
          </div>

          <div class="sectionTitle">내 커뮤니티</div>
          <div id="myCommList"></div>

          <div class="divider"></div>

          <div class="muted" style="font-weight:var(--w-semibold);">주제별로 커뮤니티 둘러보기</div>
          <div class="chips" id="topicChips">
            <div class="chip">IB</div>
            <div class="chip">게임</div>
            <div class="chip">Q&A</div>
            <div class="chip">영화 & TV</div>
            <div class="chip">테크놀로지</div>
            <div class="chip">문화</div>
            <div class="chip">CAS</div>
            <div class="chip">스포츠</div>
            <div class="chip">교육 & 커리어</div>
            <div class="chip">독서 & 글쓰기</div>
            <div class="chip">과학</div>
            <div class="chip">EE</div>
          </div>

          <div class="sectionTitle">추천 커뮤니티</div>
          <div id="commList"></div>
        </div>

        <div class="commPanel" id="commPanelCreate">
          <div class="sectionTitle">커뮤니티 신청서</div>
          <input class="input" id="commApplyName" placeholder="커뮤니티 이름 (예: study-hub)" />
          <input class="input" id="commApplyTopic" placeholder="주제 (예: 공부/취미/정보)" style="margin-top:8px;" />
          <textarea class="input" id="commApplyDesc" placeholder="소개글" style="margin-top:8px; min-height:96px;"></textarea>
          <textarea class="input" id="commApplyRule" placeholder="운영 규칙(선택)" style="margin-top:8px; min-height:84px;"></textarea>
          <div style="display:flex;gap:8px;margin-top:10px;">
            <div class="btn blue" id="commApplyBtn">신청하기</div>
            <div class="btn" id="commApplyResetBtn">초기화</div>
          </div>
          <div class="hint" style="margin-top:10px;">신청하면 관리자 검토 탭에서 승인/거절됩니다.</div>
        </div>

        <div class="commPanel" id="commPanelReview">
          <div style="display:flex;align-items:center;justify-content:space-between;gap:10px;">
            <div class="sectionTitle" style="margin:0;">신청 검토</div>
            <div class="btn" id="adminToggleBtn">관리자 모드</div>
          </div>
          <div class="hint" id="adminHint" style="margin-top:10px;">관리자 모드에서만 승인/거절 가능합니다.</div>
          <div id="commReviewList" style="margin-top:10px;"></div>
        </div>

        <div class="spacer"></div>
      </div>
    </section>

    <!-- ================= COMMUNITY DETAIL ================= -->
    <section class="screen" id="screen-comm-detail" aria-label="커뮤니티 상세">
      <div class="topbar">
        <div class="wrap">
          <div class="topbar-inner">
            <div class="leftIcon" id="commBackBtn" title="뒤로">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none">
                <path d="M15 18 9 12l6-6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
              </svg>
            </div>
            <div class="titleCenter" id="commDetailTitle">r/...</div>
            <div class="rightIcon" id="commDetailWriteBtn" title="이 커뮤니티에 글쓰기">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
                <path d="M4 20h4l10.5-10.5a2 2 0 0 0 0-3L16.5 4a2 2 0 0 0-3 0L3 14.5V20Z" stroke="currentColor" stroke-width="2" stroke-linejoin="round"/>
              </svg>
            </div>
          </div>
        </div>
      </div>

      <div class="wrap">
        <div class="spacer"></div>
        <div class="muted" style="font-weight:var(--w-semibold);" id="commDetailDesc"></div>
        <div class="spacer"></div>
        <div id="commDetailFeed"></div>
        <div class="spacer"></div>
      </div>
    </section>

    <!-- ================= CREATE ================= -->
    <section class="screen" id="screen-create" aria-label="만들기">
      <div class="topbar">
        <div class="wrap">
          <div class="topbar-inner">
            <div class="leftIcon" id="composeClose" title="닫기">
              <svg width="22" height="22" viewBox="0 0 24 24" fill="none">
                <path d="M6 6l12 12M18 6 6 18" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
              </svg>
            </div>
            <div class="titleCenter">새 게시물</div>
            <div class="rightIcon" id="postBtn" title="게시">게시</div>
          </div>
        </div>
      </div>

      <div class="wrap" style="padding-top:2px;">
        <div class="btn" id="communitySelect" style="width:100%;justify-content:space-between;border-radius:16px;">
          <span class="muted" style="font-weight:var(--w-medium);">커뮤니티</span>
          <span style="font-weight:var(--w-semibold);" id="selectedCommunity">선택</span>
        </div>

        <div id="commDropdown" class="sheet" style="margin-top:10px; display:none;">
          <div class="sheetHeader">
            <span>내 커뮤니티</span><span class="sp"></span>
            <span class="muted2" style="font-size:12px;">선택해서 글쓰기</span>
          </div>
          <div class="sheetBody" id="commDropdownList" style="padding:0;"></div>
        </div>

        <!-- title label removed per UX: title placeholder used instead -->
        <input class="input" id="composeTitle" placeholder="제목을 입력하세요" style="margin-top:6px;"/>
        <textarea class="input" id="composeBody" placeholder="본문(선택)" style="margin-top:6px; min-height:260px;"></textarea>

        <div class="hint" id="composeLockHint" style="display:none;margin-top:14px;">
          참여한 커뮤니티가 없어서 글쓰기가 잠겨 있어요. 커뮤니티에 참여하면 바로 글을 올릴 수 있어요.
        </div>

        
        <!-- Create toolbar (left-bottom) -->
        <div class="createToolbar" aria-hidden="false">
          <div class="createAction" id="createAttachLink" title="링크 첨부">
            <div class="icon">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none"><path d="M10.59 13.41a2 2 0 0 0 2.83 0l3.17-3.17a2 2 0 0 0 0-2.83 2 2 0 0 0-2.83 0L10.59 10.6" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/></svg>
            </div>
            <div class="label">링크</div>
          </div>
          <div class="createAction" id="createAttachPhoto" title="사진 첨부">
            <div class="icon">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none"><rect x="3" y="5" width="18" height="14" rx="2" stroke="currentColor" stroke-width="1.4"/><path d="M8 10l2 2 3-3 5 5" stroke="currentColor" stroke-width="1.4" stroke-linecap="round" stroke-linejoin="round"/></svg>
            </div>
            <div class="label">사진</div>
          </div>
          <div class="createAction" id="createAttachVideo" title="영상 첨부">
            <div class="icon">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none"><rect x="3" y="6" width="14" height="12" rx="2" stroke="currentColor" stroke-width="1.4"/><path d="M20 8v8" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"/></svg>
            </div>
            <div class="label">영상</div>
          </div>
          <div class="createAction" id="createAttachPoll" title="투표 만들기">
            <div class="icon">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none"><path d="M6 20V10" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"/><path d="M12 20V4" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"/><path d="M18 20v-6" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"/></svg>
            </div>
            <div class="label">투표</div>
          </div>
          <div class="createAction" id="createAskBtn" title="무엇이든 물어보기">
            <div class="icon">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none"><path d="M9.09 9a3 3 0 1 1 5.82 1c0 1.5-2 2-2 3" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/><path d="M12 18h.01" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/></svg>
            </div>
            <div class="label">물어보기</div>
          </div>
        </div>

        <!-- Hidden file inputs and poll UI -->
        <input type="file" id="createPhotoInput" accept="image/*" multiple style="display:none" />
        <input type="file" id="createVideoInput" accept="video/*" style="display:none" />
        
        <!-- 미디어 미리보기 섹션 -->
        <div id="composeMediaPreview" style="display:none; margin-top: 20px; padding-top: 20px; border-top: 1px solid var(--line);">
          <div style="font-weight: var(--w-semibold); margin-bottom: 12px; font-size: 14px;">첨부된 미디어</div>
          <div id="mediaPreviewContainer" style="display: flex; gap: 12px; overflow-x: auto; padding-bottom: 10px;">
          </div>
        </div>
        
        <div id="pollBox">
          <div style="font-weight:var(--w-semibold); margin-bottom:8px;">투표 만들기</div>
          <input class="input" id="pollOpt1" placeholder="옵션 1" style="margin-bottom:6px;" />
          <input class="input" id="pollOpt2" placeholder="옵션 2" style="margin-bottom:6px;" />
          <div style="display:flex; gap:8px;">
            <div class="btn" id="addPollOption">옵션 추가</div>
            <div class="btn" id="createPollSave">저장</div>
            <div class="btn" id="createPollCancel">취소</div>
          </div>
        </div>
      </div>
    </section>

    <!-- ================= INBOX ================= -->
    <section class="screen" id="screen-inbox" aria-label="받은 편지함">
      <div class="topbar">
        <div class="wrap">
          <div class="topbar-inner">
            <div class="leftIcon" id="inboxMenuBtn" title="메뉴">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none">
                <path d="M4 7h16M4 12h16M4 17h16" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
              </svg>
            </div>
            <div class="titleCenter">받은 편지함</div>
            <div style="display:flex;gap:10px;flex:0 0 auto;">
              <div class="iconBtn" id="inboxMarkAll" title="읽음 표시">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
                  <path d="M20 6 9 17l-5-5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
              </div>
              <div class="iconBtn" id="inboxMore" title="더보기">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
                  <path d="M6 12h.01M12 12h.01M18 12h.01" stroke="currentColor" stroke-width="3" stroke-linecap="round"/>
                </svg>
              </div>
            </div>
          </div>

          <div class="segTabs" id="inboxTabs">
            <div class="segTab active" data-tab="noti">알림<span class="dot" id="inboxDot"></span></div>
            <div class="segTab" data-tab="chat">채팅</div>
          </div>
        </div>
      </div>

      <div class="wrap">
        <div class="inboxList" id="inboxList"></div>
      </div>
    </section>

    <!-- ================= IB STUDY ================= -->
    <section class="screen" id="screen-ib" aria-label="IB공부">
      <div class="topbar">
        <div class="wrap">
          <div class="topbar-inner">
            <div class="leftIcon" id="ibMenuBtn" title="메뉴">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none">
                <path d="M4 7h16M4 12h16M4 17h16" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
              </svg>
            </div>
            <div class="titleCenter">IB공부</div>
            <div class="rightIcon" id="ibAdminAuthBtn" title="뉴스 관리자">관리</div>
          </div>
        </div>
      </div>

      <div class="wrap">
        <div class="spacer"></div>
        <div class="postCard" style="padding:14px;">
          <div style="font-weight:var(--w-bold);font-size:20px;margin-bottom:10px;">IB뉴스 · IB도움앱 소개</div>
          <div class="muted2" style="line-height:1.6;">표선고 IB 학생을 위한 핵심 정보만 모았습니다. 뉴스와 앱을 검색/분류해서 빠르게 찾을 수 있습니다.</div>
          <div class="segTabs" id="ibMainTabs" style="margin-top:12px;">
            <div class="segTab active" data-ib-tab="news">IB뉴스</div>
            <div class="segTab" data-ib-tab="apps">IB도움앱 소개</div>
          </div>
        </div>

        <div id="ibNewsPanel" class="postCard" style="padding:14px;">
          <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap;">
            <input class="input" id="ibNewsSearch" placeholder="뉴스 검색" style="flex:1;min-width:220px;" />
            <div class="btn" id="ibNewsAdminBtn">뉴스 관리자 인증</div>
            <div class="btn blue" id="ibNewsWriteBtn" style="display:none;">뉴스 작성</div>
          </div>
          <div id="ibNewsEditor" style="display:none;margin-top:12px;">
            <input class="input" id="ibNewsTitle" placeholder="뉴스 제목" />
            <textarea class="input" id="ibNewsBody" placeholder="뉴스 본문" style="min-height:120px;margin-top:8px;"></textarea>
            <input type="file" id="ibNewsMediaInput" accept="image/*,video/*" style="display:none" />
            <div style="display:flex;gap:8px;margin-top:8px;flex-wrap:wrap;">
              <div class="btn" id="ibNewsAttachBtn">미디어 첨부</div>
              <div class="btn" id="ibNewsEditorCancelBtn">취소</div>
              <div class="btn blue" id="ibNewsSubmitBtn">뉴스 게시</div>
            </div>
            <div id="ibNewsAttachHint" class="hint">첨부 없음</div>
          </div>
          <div id="ibNewsList" style="margin-top:12px;"></div>
        </div>

        <div id="ibAppsPanel" class="postCard" style="padding:14px;display:none;">
          <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap;">
            <input class="input" id="ibAppSearch" placeholder="앱 이름/기능 검색" style="flex:1;min-width:210px;" />
            <select class="input" id="ibAppCategory" style="max-width:220px;">
              <option value="all">전체 카테고리</option>
              <option value="writing">글쓰기/첨삭</option>
              <option value="research">자료조사</option>
              <option value="planning">일정관리</option>
              <option value="focus">집중/학습</option>
              <option value="ai">AI 도우미</option>
              <option value="language">언어학습</option>
            </select>
          </div>
          <div id="ibAppList" style="margin-top:12px;"></div>
        </div>
        <div class="spacer"></div>
      </div>
    </section>

    <!-- ================= MINI GAME ================= -->
    <section class="screen" id="screen-mini" aria-label="미니게임">
      <div class="topbar">
        <div class="wrap">
          <div class="topbar-inner">
            <div class="leftIcon" id="miniMenuBtn" title="메뉴">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none">
                <path d="M4 7h16M4 12h16M4 17h16" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
              </svg>
            </div>
            <div class="titleCenter">미니게임</div>
            <div class="rightIcon" id="miniResetBtn" title="초기화">리셋</div>
          </div>
        </div>
      </div>
      <div class="wrap">
        <div class="spacer"></div>
        <div class="postCard" style="padding:14px;">
          <div style="font-weight:var(--w-bold);font-size:16px;">반응속도 테스트</div>
          <div class="muted2" style="font-size:12px;margin-top:6px;">시작을 누르고 화면이 초록색이 되면 바로 누르세요.</div>
          <div id="miniGameField" style="margin-top:14px;height:180px;border-radius:16px;border:1px solid var(--line);display:grid;place-items:center;background:rgba(255,255,255,.02);font-weight:var(--w-semibold);">대기 중</div>
          <div style="display:flex;gap:8px;margin-top:10px;">
            <div class="btn blue" id="miniStartBtn">시작</div>
            <div class="btn" id="miniBestBtn">기록 보기</div>
          </div>
          <div class="hint" id="miniGameResult" style="margin-top:10px;">최고 기록: -</div>
        </div>
      </div>
    </section>

    <!-- ================= PROFILE ================= -->
    <section class="screen" id="screen-profile" aria-label="회원님">
      <div class="topbar">
        <div class="wrap">
          <div class="topbar-inner">
            <div class="leftIcon" id="profileMenuBtn" title="메뉴">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none">
                <path d="M4 7h16M4 12h16M4 17h16" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
              </svg>
            </div>
            <div class="titleCenter" id="profileTitle">회원님</div>
            <div class="rightIcon" id="profileSettingsBtn" title="설정">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
                <path d="M12 15.5a3.5 3.5 0 1 0 0-7 3.5 3.5 0 0 0 0 7Z" stroke="currentColor" stroke-width="2"/>
                <path d="M19.4 15a7.98 7.98 0 0 0 .1-1 7.98 7.98 0 0 0-.1-1l2-1.5-2-3.5-2.3.7a7.8 7.8 0 0 0-1.7-1L15 2h-6L8.6 5.7a7.8 7.8 0 0 0-1.7 1L4.6 6 2.6 9.5 4.6 11a7.98 7.98 0 0 0-.1 1c0 .34.03.67.1 1l-2 1.5 2 3.5 2.3-.7a7.8 7.8 0 0 0 1.7 1L9 22h6l.4-3.7a7.8 7.8 0 0 0 1.7-1l2.3.7 2-3.5-2-1.5Z"
                      stroke="currentColor" stroke-width="1.5" stroke-linejoin="round" opacity=".65"/>
              </svg>
            </div>
          </div>
        </div>
      </div>

      <div class="wrap" style="padding-top:10px;">
        <div class="profileHero">
          <div class="profileHeroTop">
            <div style="display:flex;align-items:flex-end;gap:10px;min-width:0;">
              <div class="simpleAvatar"></div>
              <div style="min-width:0;">
                <div style="font-weight:var(--w-bold);font-size:18px;letter-spacing:-.2px;" id="profileUserText">u/표고모</div>
                <div class="muted2" style="font-size:12px;margin-top:4px;" id="profileEmailText">로그인하면 학교 계정으로 표시됨</div>
              </div>
            </div>
            <div style="display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end;">
              <div class="btn" id="profileEditBtn">수정</div>
              <div class="btn" id="profileShareBtn">링크</div>
              <div class="btn blue" id="profileAuthBtn">로그인</div>
            </div>
          </div>
          <div class="profileTabs" id="profileTabs">
            <div class="profileTab active" data-ptab="posts">게시물</div>
            <div class="profileTab" data-ptab="about">소개</div>
            <div class="profileTab" data-ptab="stats">기록</div>
          </div>
        </div>

        <div class="profilePanel active" id="profilePanelPosts">
          <div class="sectionTitle">내 게시물</div>
          <div id="profileContent"></div>
        </div>

        <div class="profilePanel" id="profilePanelAbout">
          <div class="postCard" style="padding:14px;">
            <div style="font-weight:var(--w-semibold);">프로필 소개</div>
            <div class="muted2" id="profileBioText" style="margin-top:8px;line-height:1.6;">소개를 입력해 주세요.</div>
            <div id="profileEditBox" style="display:none;margin-top:10px;">
              <input class="input" id="profileNameInput" placeholder="표시 이름" />
              <textarea class="input" id="profileBioInput" placeholder="자기소개" style="margin-top:8px;min-height:82px;"></textarea>
              <div style="display:flex;gap:8px;margin-top:8px;">
                <div class="btn blue" id="profileSaveBtn">저장</div>
                <div class="btn" id="profileCancelBtn">취소</div>
              </div>
            </div>
          </div>
        </div>

        <div class="profilePanel" id="profilePanelStats">
          <div class="postCard" style="padding:14px;">
            <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:10px;">
              <div class="postCard" style="margin:0;box-shadow:none;border-radius:16px;padding:12px;background:rgba(255,255,255,.03);">
                <div style="font-weight:var(--w-bold);" id="karmaNum">0</div>
                <div class="muted2" style="font-size:12px;">카르마</div>
              </div>
              <div class="postCard" style="margin:0;box-shadow:none;border-radius:16px;padding:12px;background:rgba(255,255,255,.03);">
                <div style="font-weight:var(--w-bold);" id="contribNum">0</div>
                <div class="muted2" style="font-size:12px;">기여</div>
              </div>
              <div class="postCard" style="margin:0;box-shadow:none;border-radius:16px;padding:12px;background:rgba(255,255,255,.03);">
                <div style="font-weight:var(--w-bold);" id="ageNum">20일</div>
                <div class="muted2" style="font-size:12px;">기간</div>
              </div>
              <div class="postCard" style="margin:0;box-shadow:none;border-radius:16px;padding:12px;background:rgba(255,255,255,.03);">
                <div style="font-weight:var(--w-bold);" id="activeNum">1</div>
                <div class="muted2" style="font-size:12px;">활동</div>
              </div>
            </div>
          </div>
        </div>
        <div class="spacer"></div>
      </div>
    </section>

    <!-- ================= COMMENTS ================= -->
    <section class="screen" id="screen-comments" aria-label="댓글">
      <div class="topbar">
        <div class="wrap">
          <div class="topbar-inner">
            <div class="leftIcon" id="commentsBackBtn" title="뒤로">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none">
                <path d="M15 18 9 12l6-6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
              </svg>
            </div>
            <div class="titleCenter">댓글</div>
            <div class="rightIcon" id="commentsShareBtn" title="링크">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
                <path d="M12 5v14" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                <path d="M7 9l5-5 5 5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                <path d="M5 19h14" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
              </svg>
            </div>
          </div>
        </div>
      </div>

      <div class="wrap" style="padding-top:14px;">
        <div id="commentsPost"></div>
        <div class="sectionTitle">댓글</div>
        <div class="postCard" id="commentsList" style="box-shadow:var(--shadowSoft);"></div>

        <div class="spacer"></div>

        <div class="postCard" style="padding:12px 14px; box-shadow:var(--shadowSoft);">
          <div style="display:flex;gap:10px;align-items:center;">
            <input class="input" id="commentInput" placeholder="댓글을 작성하세요 (익명)" style="border-radius:999px; flex:1;"/>
            <div class="btn primary" id="commentSendBtn" style="border-radius:999px;">전송</div>
          </div>
          <div class="hint" id="commentHintText" style="margin-top:10px;"></div>
        </div>

        <div style="height:120px;"></div>
      </div>
    </section>

    <!-- ================= SETTINGS ================= -->
    <section class="screen settingsModalScreen" id="screen-settings" aria-label="설정">
      <div class="settingsModalBackdrop" id="settingsBackBtn"></div>
      <div class="settingsPanel">
        <div class="settingsPanelHead">
          <div></div>
          <div class="titleCenter">설정</div>
          <div class="rightIcon" id="settingsCloseBtn" title="닫기">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none">
              <path d="M6 6l12 12M18 6 6 18" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
            </svg>
          </div>
        </div>

        <div class="settingsBody">
          <div class="settingsGroup">ACCOUNT SETTINGS</div>
          <div class="settingsListCard">
            <button class="settingsItem" id="openAuthBtn" type="button">
              <span class="l">
                <b id="accountRowTitle">계정 인증</b>
                <small id="accountRowDesc">로그인/로그아웃 및 인증 상태 확인</small>
              </span>
              <span class="r">›</span>
            </button>
          </div>

          <div class="settingsGroup">VIEW OPTIONS</div>
          <div class="settingsListCard">
            <button class="settingsItem" id="settingsMediaAnimBtn" type="button">
              <span class="l"><b>미디어 및 애니메이션</b></span>
              <span class="r">›</span>
            </button>
            <button class="settingsItem" id="saveTitleLabelBtn" type="button">
              <span class="l"><b>텍스트 라벨 설정</b><small>글쓰기 제목 라벨 문구 변경</small></span>
              <span class="r">›</span>
            </button>
          </div>

          <div class="settingsGroup">DARK MODE</div>
          <div class="settingsListCard">
            <div class="settingsItem">
              <span class="l"><b>다크 모드</b></span>
              <button class="btn" id="themeToggle" type="button">다크</button>
            </div>
            <button class="settingsItem" id="settingsLightThemeBtn" type="button">
              <span class="l"><b>라이트 테마</b><small>눈부심 완화 소프트 라이트</small></span>
              <span class="r">Alien blue</span>
            </button>
          </div>

          <div class="settingsGroup">ADVANCED</div>
          <div class="settingsListCard">
            <label class="settingsItem settingsToggleRow">
              <span class="l"><b>동영상 기본 음소거</b></span>
              <input id="settingsMuteVideos" type="checkbox" checked />
              <span class="toggleKnob"></span>
            </label>
            <label class="settingsItem settingsToggleRow">
              <span class="l"><b>최근 커뮤니티 표시</b></span>
              <input id="settingsRecentCommunities" type="checkbox" checked />
              <span class="toggleKnob"></span>
            </label>
            <button class="settingsItem" id="createCommBtn" type="button">
              <span class="l"><b>커뮤니티 만들기</b><small>이름/설명 입력 후 즉시 생성</small></span>
              <span class="r">›</span>
            </button>
          </div>

          <div class="settingsGroup">ABOUT</div>
          <div class="settingsListCard">
            <button class="settingsItem" id="settingsPrivacyBtn" type="button"><span class="l"><b>개인정보 처리방침</b></span><span class="r">›</span></button>
            <button class="settingsItem" id="settingsTermsBtn" type="button"><span class="l"><b>이용약관</b></span><span class="r">›</span></button>
            <button class="settingsItem" id="settingsHelpBtn" type="button"><span class="l"><b>도움말 센터</b></span><span class="r">›</span></button>
          </div>

          <div class="settingsGroup">DATA</div>
          <div class="settingsListCard">
            <button class="settingsItem danger" id="resetBtn" type="button">
              <span class="l"><b>데모 데이터 초기화</b><small>게시물/댓글/커뮤니티/알림 초기화</small></span>
              <span class="r">›</span>
            </button>
          </div>

          <input id="settingTitleLabel" style="display:none" />
          <input id="newCommName" style="display:none" />
          <input id="newCommDesc" style="display:none" />
        </div>
      </div>
    </section>

    <!-- ================= SUGGEST ================= -->
    <section class="screen" id="screen-suggest" aria-label="제안/건의">
      <div class="topbar">
        <div class="wrap">
          <div class="topbar-inner">
            <div class="leftIcon" id="suggestBackBtn" title="뒤로">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none">
                <path d="M15 18 9 12l6-6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
              </svg>
            </div>
            <div class="titleCenter">제안/건의</div>
            <div class="rightIcon" id="suggestAdminBtn" title="관리자 인증">관리자</div>
          </div>
        </div>
      </div>
      <div class="wrap" style="padding-top:14px;">
        <div class="postCard" style="padding:14px; box-shadow:var(--shadowSoft);">
          <div style="font-weight:var(--w-bold);">베타 피드백 보내기</div>
          <div class="muted2" style="font-size:12px;margin-top:6px;">버그 제보, 기능 제안, 불편사항을 남겨주세요.</div>
          <div class="spacer"></div>
          <textarea class="input" id="suggestInput" placeholder="제안/건의 내용을 입력해 주세요" style="min-height:94px;"></textarea>
          <div class="spacer"></div>
          <div style="display:flex;gap:8px;align-items:center;">
            <div class="btn blue" id="suggestSubmitBtn">제안 등록</div>
            <div class="muted2" style="font-size:12px;">상태: 접수/검토중/완료</div>
          </div>
        </div>

        <div class="sectionTitle">제안 내역</div>
        <div id="suggestList"></div>
        <div class="sectionTitle">유해 댓글 검수</div>
        <div class="muted2" id="commentModerationHint" style="font-size:12px;">관리자 코드 2026 인증 후 승인/거절할 수 있습니다.</div>
        <div id="commentModerationList"></div>
        <div class="spacer"></div>
      </div>
    </section>

    <!-- ================= PROMO ================= -->
    <section class="screen" id="screen-promo" aria-label="홍보 배너">
      <div class="topbar">
        <div class="wrap">
          <div class="topbar-inner">
            <div class="leftIcon" id="promoBackBtn" title="뒤로">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none">
                <path d="M15 18 9 12l6-6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
              </svg>
            </div>
            <div class="titleCenter">홍보 배너 관리</div>
            <div class="rightIcon" id="promoAdminBtn" title="관리자 인증">관리자</div>
          </div>
        </div>
      </div>
      <div class="wrap" style="padding-top:14px;">
        <div class="postCard" style="padding:14px; box-shadow:var(--shadowSoft);">
          <div style="display:flex;justify-content:space-between;align-items:center;gap:8px;">
            <div style="font-weight:var(--w-semibold);">배너 편집</div>
            <div class="btn" id="adEditBtnInline">텍스트 수정</div>
          </div>
          <div style="display:flex;gap:8px;align-items:center;margin-top:8px;">
            <div class="btn blue" id="adImageUploadBtn">이미지 업로드</div>
            <input type="file" id="adImageFileInput" accept="image/*" style="display:none" />
          </div>
          <div class="hint" id="adminBannerHint" style="margin-top:8px;">관리자 코드 인증 후 편집할 수 있습니다.</div>
        </div>
        <div class="postCard" style="padding:14px; box-shadow:var(--shadowSoft);">
          <div style="font-weight:var(--w-semibold);margin-bottom:10px;">현재 배너 미리보기</div>
          <div class="adBanner">
            <img id="promoPreviewImg" alt="promo-preview" />
            <div class="adFallbackText" aria-hidden="true">
              <b id="promoPreviewTitle">오늘의 배너</b>
              <small id="promoPreviewSubtitle">프로젝트 참여해주세요</small>
            </div>
          </div>
        </div>
      </div>
    </section>

  </div>

  <button class="quickMyBtn" id="quickMyBtn" title="회원님">
    <span class="avatar" aria-hidden="true"></span>
    <span id="quickMyLabel">익명의 고래</span>
  </button>

  <!-- ================= Bottom Nav ================= -->
  <nav class="bottomNav" aria-label="하단 내비게이션">
    <div class="navInner">
      <div class="navItem active" data-route="home">
        <div class="navIcon">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
            <path d="M3 10.5 12 3l9 7.5V21a1 1 0 0 1-1 1h-5v-7H9v7H4a1 1 0 0 1-1-1v-10.5Z" stroke="currentColor" stroke-width="2" stroke-linejoin="round"/>
          </svg>
        </div>
        <div class="navLabel">홈</div>
      </div>

      <div class="navItem" data-route="comm">
        <div class="navIcon">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
            <path d="M7 20h10M6 17h12M4 7h16v7a6 6 0 0 1-6 6H10a6 6 0 0 1-6-6V7Z" stroke="currentColor" stroke-width="2" stroke-linejoin="round"/>
            <path d="M8 7a4 4 0 0 1 8 0" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
          </svg>
        </div>
        <div class="navLabel">커뮤니티</div>
      </div>

      <div class="navItem" data-route="create">
        <div class="navIcon">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
            <path d="M12 5v14M5 12h14" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
          </svg>
        </div>
        <div class="navLabel">만들기</div>
      </div>

      <div class="navItem" data-route="inbox">
        <div class="navIcon">
          <span class="badge" id="inboxBadge">0</span>
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
            <path d="M4 4h16v12H4z" stroke="currentColor" stroke-width="2"/>
            <path d="M4 16l4 4h8l4-4" stroke="currentColor" stroke-width="2" stroke-linejoin="round"/>
            <path d="M7 8h10" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
          </svg>
        </div>
        <div class="navLabel">받은편지함</div>
      </div>

      <div class="navItem" data-route="ib">
        <div class="navIcon">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
            <path d="M4 19V6a2 2 0 0 1 2-2h12a2 2 0 0 1 2 2v13" stroke="currentColor" stroke-width="2" stroke-linejoin="round"/>
            <path d="M6 18h14" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
            <path d="M8 7h8M8 10h8M8 13h6" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
          </svg>
        </div>
        <div class="navLabel">IB공부</div>
      </div>
    </div>
  </nav>
</div>

<!-- ================= Drawer ================= -->
  <aside class="drawer" id="drawer" role="dialog" aria-label="drawer">
    <div class="drawerTop">
      <div class="drawerBrand">
        <div class="brandLogo">
          <img id="drawerLogoImg" src="assets/logo.svg" alt="logo"/>
        </div>
        <div style="min-width:0;">
          <b>표고모</b>
          <small id="drawerSubText">참여 전엔 보기만 가능</small>
        </div>
      </div>
      <div class="drawerClose" id="drawerCloseBtn" title="닫기">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
          <path d="M6 6l12 12M18 6 6 18" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
        </svg>
      </div>
    </div>

    <div class="drawerBody">
      <div class="drawerItem" data-drawer="home"><div class="l"><span>⌂</span><span>홈</span></div><div class="r">이동</div></div>
      <div class="drawerItem" data-drawer="comm"><div class="l"><span>◻️</span><span>커뮤니티</span></div><div class="r">참여/생성</div></div>
      <div class="drawerItem" data-drawer="create"><div class="l"><span>+</span><span>만들기</span></div><div class="r">게시</div></div>
      <div class="drawerItem" data-drawer="inbox"><div class="l"><span>✉️</span><span>받은 편지함</span></div><div class="r">알림</div></div>
      <div class="drawerItem" data-drawer="ib"><div class="l"><span>🎓</span><span>IB공부</span></div><div class="r">탭</div></div>
      <div class="drawerItem" data-drawer="mini"><div class="l"><span>🎮</span><span>미니게임</span></div><div class="r">플레이</div></div>
      <div class="drawerItem" data-drawer="promo"><div class="l"><span>📣</span><span>홍보 배너</span></div><div class="r">관리</div></div>
      <div class="drawerSectionTitle">내가 속한 커뮤니티</div>
      <div class="drawerMiniList" id="drawerJoinedList"></div>
      <div class="drawerSectionTitle">최근 방문 커뮤니티</div>
      <div class="drawerMiniList" id="drawerRecentList"></div>
      <div class="divider"></div>
      <div class="drawerItem" id="drawerThemeToggle"><div class="l"><span>◯</span><span>테마</span></div><div class="r" id="drawerThemeText">다크</div></div>
      <div class="drawerItem" id="drawerAdminCodeBtn"><div class="l"><span>🔑</span><span>관리 코드</span></div><div class="r">입력</div></div>
      <div class="drawerItem" id="drawerSuggestBtn"><div class="l"><span>💡</span><span>제안/건의</span></div><div class="r">베타 피드백</div></div>
      <div class="drawerItem" data-drawer="settings"><div class="l"><span>⚙</span><span>설정</span></div><div class="r">열기</div></div>
      <div class="divider"></div>
      <div class="drawerItem" id="drawerAuthBtn"><div class="l"><span>👤</span><span id="drawerAuthText">로그인</span></div><div class="r" id="drawerAuthHint">잠금 해제</div></div>
      <div class="drawerItem" id="drawerLogoutBtn" style="display:none;"><div class="l"><span>🚪</span><span>로그아웃</span></div><div class="r">해제</div></div>
    </div>
  </aside>

<div class="drawerOverlay" id="drawerOverlay" aria-hidden="true"></div>

<!-- overlay: menu -->
<div class="overlay strong" id="menuOverlay" aria-hidden="true">
  <div class="menuPopup" id="menuPopup">
    <div class="menuHead">
      <div style="font-weight:var(--w-bold);" id="menuPanelTitle">More actions...</div>
      <div class="menuClose" id="closeMenuOverlay">✕</div>
    </div>
    <div class="menuList">
      <div class="menuItem" id="menuGoSettingsRow" data-menu-action="settings"><span class="ico">⚙️</span><span>설정으로 이동</span></div>
      <div class="menuItem" id="menuCopyLinkRow" data-menu-action="copyLink"><span class="ico">🔗</span><span>링크 복사</span></div>
      <div class="menuItem" id="menuShowLessRow" data-menu-action="showLess"><span class="ico">👁️</span><span>비슷한 게시물 덜 보기</span></div>
      <div class="menuItem" id="menuFollowRow" data-menu-action="follow"><span class="ico">🔔</span><span>게시물 팔로우</span></div>
      <div class="menuItem" id="menuSaveRow" data-menu-action="save"><span class="ico">🔖</span><span>저장</span></div>
      <div class="menuItem" id="menuCopyTextRow" data-menu-action="copyText"><span class="ico">📋</span><span>텍스트 복사</span></div>
      <div class="menuItem" id="menuCrosspostRow" data-menu-action="crosspost"><span class="ico">🔀</span><span>커뮤니티로 크로스포스트</span></div>
      <div class="menuItem" id="menuWhyRow" data-menu-action="why"><span class="ico">❓</span><span>추천 이유 보기</span></div>
      <div class="menuItem danger" id="menuReportRow" data-menu-action="report"><span class="ico">🚩</span><span>신고</span></div>
      <div class="menuItem danger" id="menuBlockRow" data-menu-action="block"><span class="ico">⛔</span><span>계정 차단</span></div>
      <div class="menuItem" id="menuHideRow" data-menu-action="hide"><span class="ico">🙈</span><span>숨기기</span></div>
      <div class="menuItem danger" id="menuDeletePostRow" data-menu-action="delete" style="display:none;"><span class="ico">🗑️</span><span id="menuDeleteTitle">게시물 삭제</span></div>
    </div>
  </div>
</div>

<!-- auth gate -->
<div class="gateOverlay" id="authGate" aria-hidden="true">
  <div class="gateSheet">
    <div class="gateInner">
      <div class="gateCard">
        <div class="gateHeader">
          <span id="authGateTitle">로그인</span>
          <span class="sp"></span>
          <div class="btn" id="closeAuthGate">닫기</div>
        </div>

        <div class="gateBody">
          <div class="tabsMini">
            <div class="tabMini active" id="tabLogin">로그인</div>
            <div class="tabMini" id="tabSignup">회원가입</div>
          </div>

          <!-- login -->
          <div id="loginView">
            <div class="inlineEmail">
              <code>ps2</code>
              <input id="loginDigits" inputmode="numeric" maxlength="4" placeholder="0000" />
              <code>@onedu.jje.go.kr</code>
            </div>
            <input class="input" id="loginPassword" type="password" placeholder="비밀번호 (회원가입 때 설정)" style="margin-top:8px;" />
            <div class="grid3">
              <input class="input" id="loginGrade" inputmode="numeric" placeholder="학년" maxlength="1"/>
              <input class="input" id="loginClass" inputmode="numeric" placeholder="반" maxlength="2"/>
              <input class="input" id="loginNo" inputmode="numeric" placeholder="번호" maxlength="2"/>
            </div>

            <div class="googleRow">
              <div class="googleHintPill" id="schoolEmailPreview">
                학교 계정으로만 통과: <b id="emailPreviewText">ps2____@onedu.jje.go.kr</b>
              </div>

              <div class="googleBtnWrap">
                <div class="googleBtnMount" id="googleBtnMount"></div>
                <div class="btn blue" id="googleContinueBtn">구글로 계속</div>
              </div>

              <div class="gateNote">
                위 버튼은 실제 Google 계정 인증을 사용합니다. 인증 후 <b>onedu.jje.go.kr</b> 도메인만 허용됩니다.
              </div>
            </div>
          </div>

          <!-- signup -->
          <div id="signupView" style="display:none;">
            <div class="inlineEmail">
              <code>ps2</code>
              <input id="signupDigits" inputmode="numeric" maxlength="4" placeholder="0000" />
              <code>@onedu.jje.go.kr</code>
            </div>
            <input class="input" id="signupPassword" type="password" placeholder="비밀번호 (6자 이상)" style="margin-top:8px;" />
            <div class="grid3">
              <input class="input" id="signupGrade" inputmode="numeric" placeholder="학년" maxlength="1"/>
              <input class="input" id="signupClass" inputmode="numeric" placeholder="반" maxlength="2"/>
              <input class="input" id="signupNo" inputmode="numeric" placeholder="번호" maxlength="2"/>
            </div>

            <div class="googleRow">
              <div class="googleHintPill">
                회원가입도 동일하게 학교 계정 인증 후 진행됩니다.
              </div>
              <div class="googleBtnWrap">
                <div class="googleBtnMount" id="googleBtnMount2"></div>
                <div class="btn blue" id="googleContinueBtn2">구글로 계속</div>
              </div>
              <div class="gateNote">인증 성공 시 회원가입 → 즉시 로그인 상태로 전환됩니다.</div>
            </div>
          </div>

          <div id="authOtpBox" style="display:none; margin-top:10px; border:1px solid var(--line); border-radius:12px; padding:10px;">
            <div class="muted2" id="authOtpHint" style="font-size:12px;">인증번호를 이메일로 보냈습니다.</div>
            <div id="authCodeInputs" style="display:flex; gap:8px; margin-top:8px;">
              <input class="authCodeDigit" data-otp-idx="0" inputmode="numeric" maxlength="1" />
              <input class="authCodeDigit" data-otp-idx="1" inputmode="numeric" maxlength="1" />
              <input class="authCodeDigit" data-otp-idx="2" inputmode="numeric" maxlength="1" />
              <input class="authCodeDigit" data-otp-idx="3" inputmode="numeric" maxlength="1" />
              <input class="authCodeDigit" data-otp-idx="4" inputmode="numeric" maxlength="1" />
              <input class="authCodeDigit" data-otp-idx="5" inputmode="numeric" maxlength="1" />
              <input class="authCodeDigit" data-otp-idx="6" inputmode="numeric" maxlength="1" />
              <input class="authCodeDigit" data-otp-idx="7" inputmode="numeric" maxlength="1" />
            </div>
            <div style="display:flex; gap:8px; margin-top:8px; flex-wrap:wrap;">
              <div class="btn" id="authOtpResendBtn">인증번호 재전송</div>
              <div class="btn blue" id="authOtpVerifyBtn">인증번호 확인</div>
            </div>
          </div>
        </div>

        <div class="gateFooter">
          <div class="linkLike" id="switchToSignup">회원가입</div>
          <div style="display:flex;gap:10px;flex-wrap:wrap;">
            <div class="btn" id="authGuestBtn">나중에</div>
            <div class="btn primary" id="authSubmitBtn">데모 확인</div>
          </div>
          <div class="hint" id="authModeHint" style="margin-top:8px;">무료 모드: Supabase 키를 넣으면 이메일 인증번호 인증이 활성화됩니다.</div>
        </div>
      </div>

      <div class="spacer"></div>
    </div>
  </div>
</div>

<!-- toast -->
<div class="toast" id="toast">
  <div class="inner">
    <div class="pill" id="toastText">토스트</div>
  </div>
</div>
<script>
window.__APP_CONFIG__ = window.__APP_CONFIG__ || {};
</script>
<script src="./app.config.js"></script>
<script src="./app.config.local.js"></script>
<script>
(() => {
  const $ = (s, el=document) => el.querySelector(s);
  const $$ = (s, el=document) => Array.from(el.querySelectorAll(s));

  const LS_KEY = "pyogomo_apple_reddit_v4";
  const APP_CONFIG = window.__APP_CONFIG__ || {};

  // ===== Google Auth Config =====
  const GOOGLE_CLIENT_ID = String(APP_CONFIG.GOOGLE_CLIENT_ID || "PASTE_YOUR_CLIENT_ID.apps.googleusercontent.com");
  const SUPABASE_URL = String(APP_CONFIG.SUPABASE_URL || "PASTE_YOUR_SUPABASE_URL");
  const SUPABASE_ANON_KEY = String(APP_CONFIG.SUPABASE_ANON_KEY || "PASTE_YOUR_SUPABASE_ANON_KEY");
  const SCHOOL_DOMAIN = String(APP_CONFIG.SCHOOL_DOMAIN || "onedu.jje.go.kr");
  const EMAIL_PREFIX = String(APP_CONFIG.EMAIL_PREFIX || "ps2"); // ps2####@onedu.jje.go.kr
  const ADMIN_CODE = String(APP_CONFIG.ADMIN_CODE || "2026");
  const ADMIN_EMAIL = String(APP_CONFIG.ADMIN_EMAIL || `admin@${SCHOOL_DOMAIN}`);
  const ANON_NICKNAME_POOL = buildAnonNicknamePool();

  // ===== DB =====
  const db = loadDB();
  if(normalizeAnonIdentity(db)){
    try{ saveDB(db); }catch(e){}
  }
  if(enrichExistingPosts(db)){
    try{ saveDB(db); }catch(e){}
  }
  applyTheme(db.settings.theme);
  applyRuntimeSettings();

  const screens = {
    home: $("#screen-home"),
    comm: $("#screen-comm"),
    commDetail: $("#screen-comm-detail"),
    create: $("#screen-create"),
    inbox: $("#screen-inbox"),
    ib: $("#screen-ib"),
    mini: $("#screen-mini"),
    promo: $("#screen-promo"),
    profile: $("#screen-profile"),
    comments: $("#screen-comments"),
    settings: $("#screen-settings"),
    suggest: $("#screen-suggest"),
  };

  let state = {
    activeRoute: "home",
    prevRoute: "home",
    activePostId: null,
    activeCommunityId: null,
    commTab: db.ui.commTab || "explore",
    homeSub: "home",
    homeQuery: "",
    authReason: "",
    googleReady: false,
    supabaseReady: false,
    adminMode: false,
    adminSession: false,
    menuPostId: null,
    menuCommentId: null,
  };
  let pendingRenderHome = null;
  let drawerPushTimer = null;
  let composeMedia = []; // 첨부된 미디어들 (배열)
  let miniGameTimer = null;
  let miniGameStart = 0;
  let miniGameArmed = false;
  let pullState = { touching: false, startY: 0, offset: 0, active: false, refreshing: false };
  let supabaseClient = null;
  let pendingEmailAuth = null;
  let authCodeTimer = null;
  const AUTH_CODE_TTL_MS = 3 * 60 * 1000;

  initLogoFallback();
  initGoogleIdentity();
  initSupabaseAuth();
  bindUI();
  try{ renderAll(); }catch(e){ console.error(e); }
  syncAuthUI();
  switchProfileTab("posts");
  resetMiniGame();
  applyHashRouteIfAny();

  // =========================
  // UI bind
  // =========================
  function bindUI(){
    // bottom nav
    $$(".navItem").forEach(item => item.addEventListener("click", () => {
      const r = item.dataset.route;

      if(r === "profile" && !db.auth.loggedIn){
        openAuthGate("회원님");
        return;
      }
      if(r === "create"){
        if(!db.auth.loggedIn){ openAuthGate("작성"); return; }
        if(!hasAnyJoined()){ toast("커뮤니티 참여 후 작성 가능"); go("comm"); return; }
      }
      go(r);
    }));

    // drawer buttons
    ["homeMenuBtn","commMenuBtn","inboxMenuBtn","ibMenuBtn","miniMenuBtn","profileMenuBtn"].forEach(id=>{
      const el = $("#"+id);
      if(el) el.addEventListener("click", ()=> openDrawer(true));
    });
    $("#drawerCloseBtn").addEventListener("click", ()=> openDrawer(false));
    $("#drawerOverlay").addEventListener("click", (e)=> {
      if(e.target.id === "drawerOverlay") openDrawer(false);
    });
    $$("[data-drawer]").forEach(item => item.addEventListener("click", () => {
      const r = item.dataset.drawer;
      openDrawer(false);
      if(r === "create"){
        if(!db.auth.loggedIn){ openAuthGate("작성"); return; }
        if(!hasAnyJoined()){ toast("커뮤니티 참여 후 작성 가능"); go("comm"); return; }
      }
      if(r === "settings"){ go("settings"); return; }
      if(r === "profile" && !db.auth.loggedIn){ openAuthGate("회원님"); return; }
      go(r);
    }));

    $("#drawerThemeToggle").addEventListener("click", toggleTheme);
    $("#drawerAdminCodeBtn").addEventListener("click", adminQuickAuth);
    $("#drawerSuggestBtn").addEventListener("click", () => {
      openDrawer(false);
      go("suggest");
      setTimeout(()=> $("#suggestInput")?.focus(), 180);
    });
    $("#drawerAuthBtn").addEventListener("click", () => { openDrawer(false); openAuthGate("로그인"); });
    $("#drawerLogoutBtn").addEventListener("click", () => logout());

    // home subtabs
    $$("#homeSubtabs .subTab").forEach(t => t.addEventListener("click", () => {
      $$("#homeSubtabs .subTab").forEach(x => x.classList.toggle("active", x === t));
      state.homeSub = t.dataset.sub;
      renderHomeFeed();
    }));

    // search (throttled via rAF to avoid rapid reflows)
    $("#homeSearch").addEventListener("input", e => {
      state.homeQuery = e.target.value.trim();
      if(pendingRenderHome) cancelAnimationFrame(pendingRenderHome);
      pendingRenderHome = requestAnimationFrame(() => { renderHomeFeed(); pendingRenderHome = null; });
    });

    // chips (demo)
    $$("#topicChips .chip").forEach(ch => ch.addEventListener("click", () => {
      $$("#topicChips .chip").forEach(x => x.style.borderColor = "var(--line)");
      ch.style.borderColor = "rgba(59,130,246,.35)";
      toast(`주제: ${ch.textContent.trim()}`);
    }));

    // community create shortcut
    $("#commCreateBtn").addEventListener("click", () => {
      go("comm");
      switchCommTab("create");
      setTimeout(()=> $("#commApplyName")?.focus(), 120);
    });

    // community tabs / search / application
    $$("#commTabs .segTab").forEach(t => t.addEventListener("click", () => switchCommTab(t.dataset.commTab)));
    $("#commSearchInput")?.addEventListener("input", () => renderCommunities());
    $("#commApplyResetBtn")?.addEventListener("click", () => {
      $("#commApplyName").value = "";
      $("#commApplyTopic").value = "";
      $("#commApplyDesc").value = "";
      $("#commApplyRule").value = "";
    });
    $("#commApplyBtn")?.addEventListener("click", submitCommunityApplication);
    $("#adminToggleBtn")?.addEventListener("click", adminQuickAuth);
    $("#commReviewList")?.addEventListener("click", (e) => {
      const btn = e.target.closest("[data-review-act]");
      if(!btn || !isAdminUser()) return;
      const reqId = btn.dataset.reqId;
      const act = btn.dataset.reviewAct;
      reviewCommunityRequest(reqId, act);
    });

    // comm back / write
    $("#commBackBtn").addEventListener("click", () => go("comm"));
    $("#commDetailWriteBtn").addEventListener("click", () => {
      if(!db.auth.loggedIn){ openAuthGate("작성"); return; }
      if(!isJoined(state.activeCommunityId)){ toast("참여 후 작성 가능"); return; }
      if(state.activeCommunityId){
        db.ui.composeSelectedCommunityId = state.activeCommunityId;
        saveDB(db);
      }
      go("create");
      syncCompose();
    });

    // create
    $("#composeClose").addEventListener("click", () => go("home"));
    $("#communitySelect").addEventListener("click", () => {
      if(!db.auth.loggedIn){ openAuthGate("작성"); return; }
      if(!hasAnyJoined()){ toast("커뮤니티 참여 후 작성 가능"); go("comm"); return; }
      toggleCommDropdown();
    });
    $("#composeTitle").addEventListener("input", updatePostBtn);
    $("#composeBody").addEventListener("input", updatePostBtn);
    $("#postBtn").addEventListener("click", submitPost);

    // make title label focus the title input
    // title label removed — title input receives focus directly when opening create

    // Create toolbar: attach handlers
    const _photoInput = $("#createPhotoInput");
    const _videoInput = $("#createVideoInput");
    $("#createAttachLink")?.addEventListener("click", ()=>{
      const url = prompt("첨부할 링크 URL을 입력하세요");
      if(url){ const b = $("#composeBody"); b.value = (b.value||"") + `\n[링크] ${url}\n`; toast("링크 추가됨"); updatePostBtn(); }
    });
    $("#createAttachPhoto")?.addEventListener("click", ()=> _photoInput && _photoInput.click());
    if(_photoInput) _photoInput.addEventListener("change", (e)=>{
      const files = e.target.files;
      if(files){
        Array.from(files).forEach(f => {
          if(f.size > 2 * 1024 * 1024){
            toast(`사진 용량이 커서 첨부 불가 (${Math.round(f.size/1024/1024)}MB)`);
            return;
          }
          const reader = new FileReader();
          reader.onload = (evt) => {
            composeMedia.push({ type: "image", src: evt.target.result });
            renderComposeMediaPreview();
            toast("사진 첨부됨");
            updatePostBtn();
          };
          reader.readAsDataURL(f);
        });
      }
      e.target.value = '';
    });
    $("#createAttachVideo")?.addEventListener("click", ()=> _videoInput && _videoInput.click());
    if(_videoInput) _videoInput.addEventListener("change", (e)=>{
      const f = e.target.files && e.target.files[0];
      if(f){
        if(f.size > 3 * 1024 * 1024){
          toast(`영상 용량이 커서 첨부 불가 (${Math.round(f.size/1024/1024)}MB)`);
          e.target.value = '';
          return;
        }
        const reader = new FileReader();
        reader.onload = (evt) => {
          composeMedia.push({ type: "video", src: evt.target.result, poster: "" });
          renderComposeMediaPreview();
          toast("영상 첨부됨");
          updatePostBtn();
        };
        reader.readAsDataURL(f);
      }
      e.target.value = '';
    });

    // Poll: toggle UI and save
    $("#createAttachPoll")?.addEventListener("click", ()=>{
      const pb = $("#pollBox");
      if(!pb) return;
      pb.style.display = (pb.style.display === 'block') ? 'none' : 'block';
      if(pb.style.display === 'block') setTimeout(()=> { $("#pollOpt1")?.focus(); }, 40);
    });
    $("#createPollCancel")?.addEventListener("click", ()=>{ const pb = $("#pollBox"); if(pb) pb.style.display='none'; });
    $("#createPollSave")?.addEventListener("click", ()=>{
      const o1 = $("#pollOpt1").value.trim();
      const o2 = $("#pollOpt2").value.trim();
      if(!o1 || !o2){ toast("옵션을 최소 2개 입력하세요"); return; }
      const opts = [$ ("#pollOpt1").value.trim(), $("#pollOpt2").value.trim()];
      // collect additional options if any
      $$("#pollBox .input").forEach((el,i)=> { if(i>1 && el.value.trim()) opts.push(el.value.trim()); });
      $("#composeBody").value += `\n[투표]\n${opts.map((x,i)=> (i+1)+'. '+x).join('\n')}\n`;
      toast("투표가 본문에 추가되었습니다");
      $("#pollBox").style.display='none';
      updatePostBtn();
    });
    $("#addPollOption")?.addEventListener("click", ()=>{
      const pb = $("#pollBox"); if(!pb) return;
      const inp = document.createElement('input'); inp.className = 'input'; inp.placeholder = '옵션 추가'; inp.style.marginBottom = '6px';
      pb.insertBefore(inp, pb.querySelector('div'));
    });

    // Ask-anything quick insert
    $("#createAskBtn")?.addEventListener("click", ()=>{
      const q = prompt("무엇이든 물어보세요 (간단한 질문)");
      if(q){ $("#composeBody").value += `\n[물어보기] ${q}\n`; toast("질문이 본문에 추가되었습니다"); updatePostBtn(); }
    });

    // IB hub
    $("#ibAdminAuthBtn")?.addEventListener("click", adminQuickAuth);
    $("#ibNewsAdminBtn")?.addEventListener("click", adminQuickAuth);
    $("#ibNewsWriteBtn")?.addEventListener("click", () => toggleIbNewsEditor(true));
    $("#ibNewsEditorCancelBtn")?.addEventListener("click", () => toggleIbNewsEditor(false));
    $("#ibNewsSubmitBtn")?.addEventListener("click", submitIbNews);
    $("#ibNewsAttachBtn")?.addEventListener("click", () => $("#ibNewsMediaInput")?.click());
    $("#ibNewsSearch")?.addEventListener("input", renderIbNewsList);
    $("#ibAppSearch")?.addEventListener("input", renderIbAppList);
    $("#ibAppCategory")?.addEventListener("change", renderIbAppList);
    $("#ibNewsMediaInput")?.addEventListener("change", onIbNewsMediaSelected);
    $$("#ibMainTabs .segTab").forEach(tab => tab.addEventListener("click", () => switchIbTab(tab.dataset.ibTab || "news")));

    // top-right my button
    $("#quickMyBtn")?.addEventListener("click", () => {
      if(!db.auth.loggedIn){ openAuthGate("회원님"); return; }
      go("profile");
    });

    // inbox
    $$("#inboxTabs .segTab").forEach(t => t.addEventListener("click", () => {
      const tab = t.dataset.tab;
      if(tab === "chat" && !db.auth.loggedIn){ openAuthGate("채팅"); return; }
      $$("#inboxTabs .segTab").forEach(x => x.classList.toggle("active", x === t));
      renderInbox(tab);
    }));
    $("#inboxMarkAll").addEventListener("click", () => {
      db.inbox.forEach(n => n.unread = false);
      saveDB(db);
      renderInbox(getActiveInboxTab());
      toast("모두 읽음");
    });
    $("#inboxMore").addEventListener("click", (e) => openGeneralMenu(e.currentTarget));
    $("#closeMenuOverlay").addEventListener("click", () => {
      openOverlay("menuOverlay", false);
      state.menuPostId = null;
      state.menuCommentId = null;
    });
    $("#menuOverlay").addEventListener("click", (e) => {
      if(e.target.id !== "menuOverlay") return;
      openOverlay("menuOverlay", false);
      state.menuPostId = null;
      state.menuCommentId = null;
    });
    $("#menuPopup").addEventListener("click", (e) => {
      const row = e.target.closest("[data-menu-action]");
      if(!row) return;
      handleMenuAction(row.dataset.menuAction);
    });

    // profile
    $("#profileSettingsBtn").addEventListener("click", () => go("settings"));
    $("#profileAuthBtn").addEventListener("click", () => {
      if(!db.auth.loggedIn) openAuthGate("회원님");
      else toast("이미 로그인됨");
    });
    $("#profileShareBtn").addEventListener("click", () => copyText(makeLink({type:"profile"})));
    $$("#profileTabs .profileTab").forEach(t => t.addEventListener("click", () => switchProfileTab(t.dataset.ptab)));
    $("#profileEditBtn").addEventListener("click", () => {
      const box = $("#profileEditBox");
      box.style.display = (box.style.display === "none" || !box.style.display) ? "block" : "none";
      $("#profileNameInput").value = db.profile.displayName || "";
      $("#profileBioInput").value = db.profile.bio || "";
      switchProfileTab("about");
    });
    $("#profileSaveBtn").addEventListener("click", saveProfileInfo);
    $("#profileCancelBtn").addEventListener("click", () => { $("#profileEditBox").style.display = "none"; });

    // comments
    $("#commentsBackBtn").addEventListener("click", () => go(state.prevRoute || "home"));
    $("#commentsShareBtn").addEventListener("click", () => {
      if(state.activePostId) copyText(makeLink({type:"post", postId: state.activePostId}));
    });
    $("#commentSendBtn").addEventListener("click", sendComment);
    $("#commentInput").addEventListener("keydown", (e)=> { if(e.key==="Enter") sendComment(); });
    $("#commentsList").addEventListener("click", (e) => {
      const menuBtn = e.target.closest("[data-comment-menu]");
      if(menuBtn){
        openCommentMenu(menuBtn.dataset.commentMenu, menuBtn);
      }
    });

    // settings
    const closeSettingsScreen = () => go(state.prevRoute || "home");
    $("#settingsBackBtn").addEventListener("click", closeSettingsScreen);
    $("#settingsCloseBtn").addEventListener("click", closeSettingsScreen);
    $("#themeToggle").addEventListener("click", toggleTheme);
    $("#settingsLightThemeBtn")?.addEventListener("click", () => {
      db.settings.theme = "light";
      saveDB(db);
      applyTheme("light");
      applyRuntimeSettings();
      syncAuthUI();
      renderSettings();
      toast("라이트 테마 적용");
    });
    $("#settingsMediaAnimBtn")?.addEventListener("click", () => {
      db.settings.mediaAnimations = !(db.settings.mediaAnimations !== false);
      saveDB(db);
      applyRuntimeSettings();
      renderSettings();
      toast(db.settings.mediaAnimations ? "애니메이션 켜짐" : "애니메이션 꺼짐");
    });
    $("#settingsMuteVideos")?.addEventListener("change", (e) => {
      db.settings.muteVideos = !!e.target.checked;
      saveDB(db);
      renderAll();
      toast(db.settings.muteVideos ? "동영상 기본 음소거 켜짐" : "동영상 기본 음소거 꺼짐");
    });
    $("#settingsRecentCommunities")?.addEventListener("change", (e) => {
      db.settings.showRecentCommunities = !!e.target.checked;
      saveDB(db);
      renderDrawerCommunityLists();
      toast(db.settings.showRecentCommunities ? "최근 커뮤니티 표시 켜짐" : "최근 커뮤니티 표시 꺼짐");
    });
    $("#settingsPrivacyBtn")?.addEventListener("click", () => {
      alert("개인정보 처리방침\n\n표고모는 로컬 저장소(localStorage)에 데모 데이터를 저장합니다.");
    });
    $("#settingsTermsBtn")?.addEventListener("click", () => {
      alert("이용약관\n\n욕설/비방/개인정보 유출 게시물은 삭제될 수 있습니다.");
    });
    $("#settingsHelpBtn")?.addEventListener("click", () => {
      toast("도움말: 설정 > 계정 인증 > 로그인 순서로 진행하세요.");
    });

    $("#saveTitleLabelBtn").addEventListener("click", () => {
      const labelInput = $("#settingTitleLabel");
      let v = (labelInput?.value || "").trim();
      if(!v){
        v = String(prompt("제목 라벨 문구를 입력하세요", db.settings.composeTitleLabel || "제목") || "").trim();
      }
      if(!v) return;
      if(labelInput) labelInput.value = v;
      db.settings.composeTitleLabel = v;
      saveDB(db);
      syncCompose();
      toast("저장");
    });
    $("#suggestSubmitBtn")?.addEventListener("click", submitSuggestion);
    $("#suggestList")?.addEventListener("click", (e) => {
      const btn = e.target.closest("[data-suggest-act]");
      if(!btn || !isAdminUser()) return;
      updateSuggestionStatus(btn.dataset.suggestId, btn.dataset.suggestAct);
    });
    $("#commentModerationList")?.addEventListener("click", (e) => {
      const btn = e.target.closest("[data-mod-act]");
      if(!btn || !isAdminUser()) return;
      reviewCommentModeration(btn.dataset.modId, btn.dataset.modAct);
    });
    $("#adEditBtn").addEventListener("click", editBannerByAdmin);
    $("#adEditBtnInline")?.addEventListener("click", editBannerByAdmin);
    $("#adImageUploadBtn")?.addEventListener("click", () => {
      if(!isAdminUser()){ toast("관리자 인증 후 업로드 가능"); return; }
      $("#adImageFileInput")?.click();
    });
    $("#adImageFileInput")?.addEventListener("change", uploadBannerImageFile);
    $("#suggestBackBtn")?.addEventListener("click", () => go(state.prevRoute || "home"));
    $("#suggestAdminBtn")?.addEventListener("click", adminQuickAuth);
    $("#promoBackBtn")?.addEventListener("click", () => go(state.prevRoute || "home"));
    $("#promoAdminBtn")?.addEventListener("click", adminQuickAuth);

    $("#createCommBtn").addEventListener("click", () => {
      const nameEl = $("#newCommName");
      const descEl = $("#newCommDesc");
      let nameRaw = (nameEl?.value || "").trim();
      let descRaw = (descEl?.value || "").trim();
      if(!nameRaw){
        nameRaw = String(prompt("커뮤니티 이름 입력", "pyogomo-students") || "").trim();
      }
      if(!descRaw){
        descRaw = String(prompt("커뮤니티 설명(선택)", "새 커뮤니티") || "").trim();
      }
      if(!nameRaw) return;

      const safe = sanitizeCommName(nameRaw);
      if(!safe){ toast("이름 형식 확인"); return; }

      if(db.communities.some(c => c.name.toLowerCase() === safe.toLowerCase())){
        const ex = db.communities.find(c => c.name.toLowerCase() === safe.toLowerCase());
        ex.joined = true;
        ex.members += 1;
      }else{
        db.communities.unshift({
          id: uid("c"),
          name: safe,
          desc: (descRaw || "새 커뮤니티"),
          members: 1,
          joined: true,
          createdBy: db.me.anon
        });
      }

      if(nameEl) nameEl.value = "";
      if(descEl) descEl.value = "";

      saveDB(db);
      renderCommunities();
      syncCompose();
      syncAuthUI();
      toast("커뮤니티 생성/참여");
    });

    $("#resetBtn").addEventListener("click", () => {
      const ok = confirm("정말 초기화할까요? (데이터가 전부 초기 상태로 돌아갑니다)");
      if(!ok) return;
      localStorage.removeItem(LS_KEY);
      location.reload();
    });

    // list delegates
    $("#commList").addEventListener("click", (e) => commListHandler(e));
    $("#myCommList").addEventListener("click", (e) => commListHandler(e));
    $("#commDetailFeed").addEventListener("click", (e) => postFeedHandler(e));
    $("#homeFeed").addEventListener("click", (e) => postFeedHandler(e));
    $("#profileContent").addEventListener("click", (e) => postFeedHandler(e));
    $("#drawerJoinedList").addEventListener("click", (e) => drawerCommunityHandler(e));
    $("#drawerRecentList").addEventListener("click", (e) => drawerCommunityHandler(e));

    // auth gate
    $("#openAuthBtn").addEventListener("click", () => openAuthGate("계정"));
    $("#closeAuthGate").addEventListener("click", ()=> openAuthGate(null, false));
    $("#authGuestBtn").addEventListener("click", ()=> openAuthGate(null, false));
    $("#tabLogin").addEventListener("click", ()=> switchAuthTab("login"));
    $("#tabSignup").addEventListener("click", ()=> switchAuthTab("signup"));
    $("#switchToSignup").addEventListener("click", ()=> {
      const isLogin = $("#tabLogin").classList.contains("active");
      switchAuthTab(isLogin ? "signup" : "login");
    });

    // auth submit
    $("#authSubmitBtn").addEventListener("click", submitAuthFlow);
    $("#authOtpVerifyBtn").addEventListener("click", verifyEmailOtp);
    $("#authOtpResendBtn").addEventListener("click", resendEmailOtp);
    bindAuthCodeInputs();

    // digits -> preview update + enter triggers google prompt
    ["loginDigits","signupDigits"].forEach(id=>{
      const el = $("#"+id);
      el.addEventListener("input", refreshEmailPreview);
      el.addEventListener("keydown", (e)=>{
        if(e.key === "Enter"){
          const isSignup = (id === "signupDigits");
          tryGooglePrompt(isSignup);
        }
      });
    });

    $("#googleContinueBtn").addEventListener("click", ()=> tryGooglePrompt(false));
    $("#googleContinueBtn2").addEventListener("click", ()=> tryGooglePrompt(true));

    // mini game
    $("#miniResetBtn").addEventListener("click", resetMiniGame);
    $("#miniStartBtn").addEventListener("click", startMiniGame);
    $("#miniBestBtn").addEventListener("click", () => {
      toast(`최고 기록: ${db.ui.miniBestMs ? db.ui.miniBestMs + "ms" : "없음"}`);
    });
    $("#miniGameField").addEventListener("click", onMiniFieldClick);

    // pull to refresh (home only)
    const stage = $("#stage");
    stage.addEventListener("touchstart", onPullStart, { passive: true });
    stage.addEventListener("touchmove", onPullMove, { passive: false });
    stage.addEventListener("touchend", onPullEnd, { passive: true });
  }

  // =========================
  // Routing
  // =========================
  function go(route){
    if(route !== "comments" && route !== "settings") state.prevRoute = state.activeRoute;
    state.activeRoute = route;

    // toggle compose-mode on body to make UI adjustments (hide bottom nav, padding)
    document.body.classList.toggle('compose-mode', route === 'create');

    $$(".navItem").forEach(n => n.classList.toggle("active", n.dataset.route === route));
    Object.keys(screens).forEach(k => screens[k].classList.toggle("active", k === route));
    const current = screens[route];
    if(current){
      current.classList.remove("screen-enter");
      requestAnimationFrame(() => current.classList.add("screen-enter"));
    }
    $("#stage").scrollTo({top:0, behavior:"smooth"});
    const quickMyBtn = $("#quickMyBtn");
    if(quickMyBtn) quickMyBtn.style.display = (route === "create") ? "none" : "flex";

    if(route === "create"){
      syncCompose();
      updatePostBtn();
      setTimeout(()=> $("#composeTitle").focus({preventScroll:true}), 120);
    }
    if(route === "comm"){
      renderCommunities();
      switchCommTab(state.commTab || "explore", false);
    }
    if(route === "suggest") renderSuggestScreen();
    if(route === "promo") renderPromoScreen();
    if(route === "ib") renderIbHub();
    if(route === "settings") renderSettings();
  }

  function openDrawer(open){
    const ov = $("#drawerOverlay");
    const drawer = $("#drawer");
    const appEl = document.querySelector('.app');
    if(open){
      // open overlay + show drawer + push app to the right by drawer width
      ov.classList.add('open');
      ov.setAttribute('aria-hidden', 'false');
      drawer.classList.add('open');
      drawer.setAttribute('aria-hidden', 'false');
      // compute drawer width and apply transform in next frame so transition runs
      requestAnimationFrame(() => {
        const w = drawer.getBoundingClientRect().width;
        // set CSS variable so overlay positioning aligns with drawer width
        document.documentElement.style.setProperty('--drawer-w', Math.round(w) + 'px');
        // Two-stage push: small peek first, then settle to final push for layered feel
        const finalPush = Math.round(w * 0.50); // final covers ~50% of drawer width
        const peekPush = Math.round(w * 0.28);  // initial peek amount

        // reduced-motion users get a single-step transition
        const reduce = window.matchMedia && window.matchMedia('(prefers-reduced-motion: reduce)').matches;
        if(reduce){
          document.documentElement.style.setProperty('--app-push', finalPush + 'px');
          appEl.classList.add('shifted');
        }else{
          // apply peek, then schedule the final settle
          document.documentElement.style.setProperty('--app-push', peekPush + 'px');
          appEl.classList.add('shifted');
          if(drawerPushTimer) clearTimeout(drawerPushTimer);
          drawerPushTimer = setTimeout(()=>{
            document.documentElement.style.setProperty('--app-push', finalPush + 'px');
            drawerPushTimer = null;
          }, 120);
        }
      });
    }else{
      // close: remove 'open' to trigger overlay/drawer transitions
      // hide drawer and then slide app back and cleanup after transitions end
      ov.classList.remove('open');
      drawer.classList.remove('open');
      drawer.setAttribute('aria-hidden', 'true');

      // cancel any pending settle timer and remove shifted state so app slides back
      if(drawerPushTimer){ clearTimeout(drawerPushTimer); drawerPushTimer = null; }
      appEl.classList.remove('shifted');

      const onOverlayEnd = (e) => {
        if(e.propertyName === 'opacity'){
          ov.setAttribute('aria-hidden', 'true');
          ov.removeEventListener('transitionend', onOverlayEnd);
        }
      };
      ov.addEventListener('transitionend', onOverlayEnd);

      const onAppEnd = (e) => {
        if(e.propertyName === 'transform'){
          // cleanup CSS vars so layout returns to natural state
          document.documentElement.style.removeProperty('--app-push');
          document.documentElement.style.setProperty('--drawer-w', '360px');
          appEl.removeEventListener('transitionend', onAppEnd);
        }
      };
      appEl.addEventListener('transitionend', onAppEnd);
    }
  }

  function openOverlay(id, open){
    const el = $("#"+id);
    el.classList.toggle("open", open);
    el.setAttribute("aria-hidden", open ? "false" : "true");
  }

  // =========================
  // Theme
  // =========================
  function toggleTheme(){
    db.settings.theme = (db.settings.theme === "light") ? "dark" : "light";
    saveDB(db);
    applyTheme(db.settings.theme);
    applyRuntimeSettings();
    syncAuthUI();
    toast(db.settings.theme === "light" ? "화이트" : "다크");
  }

  function applyTheme(theme){
    document.body.classList.toggle("theme-light", theme === "light");
    $("#drawerThemeText").textContent = (theme === "light") ? "화이트" : "다크";
  }

  function applyRuntimeSettings(){
    const motionOn = db.settings.mediaAnimations !== false;
    document.body.classList.toggle("reduce-motion-ui", !motionOn);
  }

  // =========================
  // Google Identity
  // =========================
  function initGoogleIdentity(){
    // Google script가 로드되기 전에 불리는 경우가 있어 방어
    const wait = () => {
      if(!window.google || !google.accounts || !google.accounts.id){
        setTimeout(wait, 120);
        return;
      }

      // client id가 교체되지 않았으면 버튼만 숨기고 데모로만 동작
      if(!GOOGLE_CLIENT_ID || GOOGLE_CLIENT_ID.includes("PASTE_YOUR_CLIENT_ID")){
        state.googleReady = false;
        $("#googleBtnMount").innerHTML = "";
        $("#googleBtnMount2").innerHTML = "";
        $("#googleContinueBtn").style.display = "none";
        $("#googleContinueBtn2").style.display = "none";
        $("#googleBtnMount")?.closest(".googleBtnWrap")?.style?.setProperty("display","none");
        $("#googleBtnMount2")?.closest(".googleBtnWrap")?.style?.setProperty("display","none");
        refreshEmailPreview();
        return;
      }

      state.googleReady = true;

      google.accounts.id.initialize({
        client_id: GOOGLE_CLIENT_ID,
        callback: onGoogleCredential,
        auto_select: false,
        cancel_on_tap_outside: false
      });

      // 버튼 렌더 (두 탭 모두)
      renderGoogleButtons();
      refreshEmailPreview();
    };
    wait();
  }

  function renderGoogleButtons(){
    const mount1 = $("#googleBtnMount");
    const mount2 = $("#googleBtnMount2");
    mount1.innerHTML = "";
    mount2.innerHTML = "";

    google.accounts.id.renderButton(mount1, {
      theme: "outline",
      size: "large",
      width: 240,
      text: "continue_with",
      shape: "pill",
      locale: "ko"
    });

    google.accounts.id.renderButton(mount2, {
      theme: "outline",
      size: "large",
      width: 240,
      text: "continue_with",
      shape: "pill",
      locale: "ko"
    });
  }

  function tryGooglePrompt(isSignup){
    if(!state.googleReady){
      toast("현재 구글 로그인은 비활성화 상태입니다");
      return;
    }
    // 입력값이 정상일 때만 유도
    const info = readGateInputs(isSignup);
    if(!info.ok){
      toast(info.msg);
      return;
    }
    // 실제 prompt 호출 (사용자 제스처 기반)
    // One Tap 또는 계정 선택 UI가 뜸
    google.accounts.id.prompt((n) => {
      // 브라우저/쿠키 설정에 따라 표시가 안 될 수 있어 안내만
      if(n.isNotDisplayed() || n.isSkippedMoment()){
        toast("구글 로그인 화면을 열 수 없음(브라우저 설정 확인)");
      }
    });
  }

  function onGoogleCredential(res){
    // res.credential = ID token (JWT)
    const jwt = res && res.credential;
    if(!jwt){
      toast("구글 인증 실패");
      return;
    }

    const payload = decodeJwt(jwt);
    if(!payload){
      toast("토큰 해석 실패");
      return;
    }

    const email = String(payload.email || "");
    const hd = String(payload.hd || ""); // hosted domain
    const emailVerified = !!payload.email_verified;

    // 학교 도메인 강제
    if(!emailVerified){
      toast("이메일 인증 필요");
      return;
    }
    if(!(email.endsWith("@"+SCHOOL_DOMAIN) && hd === SCHOOL_DOMAIN)){
      toast("학교 계정만 허용");
      return;
    }

    // 사용자가 입력한 ps2#####와 email이 일치하는지 검사
    const isSignup = $("#tabSignup").classList.contains("active");
    const info = readGateInputs(isSignup);
    if(!info.ok){
      toast(info.msg);
      return;
    }

    if(email.toLowerCase() !== info.email.toLowerCase()){
      toast("입력한 계정과 구글 계정이 다름");
      return;
    }

    // 성공: 로그인 상태 확정
    db.auth.loggedIn = true;
    db.auth.user = {
      email,
      handle: email.split("@")[0],
      grade: info.grade,
      clazz: info.clazz,
      no: info.no
    };
    refreshCurrentAnonNickname();
    saveDB(db);
    syncAuthUI();
    openAuthGate(null, false);
    toast(isSignup ? "회원가입/로그인 완료" : "로그인 완료");

    if(state.activeRoute === "home" && state.authReason === "회원님") go("profile");
  }

  function decodeJwt(token){
    try{
      const part = token.split(".")[1];
      const b64 = part.replace(/-/g, "+").replace(/_/g, "/");
      const json = decodeURIComponent(atob(b64).split("").map(c => "%" + ("00"+c.charCodeAt(0).toString(16)).slice(-2)).join(""));
      return JSON.parse(json);
    }catch(e){
      return null;
    }
  }

  // =========================
  // Auth Gate UI
  // =========================
  async function initSupabaseAuth(){
    if(!SUPABASE_URL || !SUPABASE_ANON_KEY || SUPABASE_URL.includes("PASTE_") || SUPABASE_ANON_KEY.includes("PASTE_")){
      state.supabaseReady = false;
      syncAuthModeHint();
      return;
    }
    try{
      const mod = await import("https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm");
      supabaseClient = mod.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
      state.supabaseReady = true;
    }catch(e){
      state.supabaseReady = false;
      console.error(e);
    }
    syncAuthModeHint();
  }

  function syncAuthModeHint(){
    const btn = $("#authSubmitBtn");
    const hint = $("#authModeHint");
    if(btn) btn.textContent = state.supabaseReady ? "인증번호 보내기" : "데모 확인";
    if(hint){
      hint.textContent = state.supabaseReady
        ? "실제 모드: 비밀번호 확인 후 이메일 인증번호(3분 제한)로 로그인됩니다."
        : "무료 모드 준비: Supabase URL/ANON KEY 입력 시 인증번호 인증 활성화";
    }
  }

  function openOtpBox(open, text){
    const box = $("#authOtpBox");
    if(box) box.style.display = open ? "block" : "none";
    if(text) $("#authOtpHint").textContent = text;
    if(!open){
      clearAuthCodeInputs();
      stopAuthCodeTimer();
    }else{
      setTimeout(()=> $$(".authCodeDigit")[0]?.focus(), 40);
    }
  }

  function clearAuthCodeInputs(){
    $$(".authCodeDigit").forEach(el => el.value = "");
  }

  function getAuthCodeToken(){
    return $$(".authCodeDigit").map(el => (el.value || "").trim()).join("");
  }

  function bindAuthCodeInputs(){
    const inputs = $$(".authCodeDigit");
    if(!inputs.length) return;
    inputs.forEach((el, idx) => {
      el.addEventListener("input", () => {
        el.value = (el.value || "").replace(/\D/g, "").slice(0, 1);
        if(el.value && idx < inputs.length - 1) inputs[idx + 1].focus();
      });
      el.addEventListener("keydown", (e) => {
        if(e.key === "Backspace" && !el.value && idx > 0){
          inputs[idx - 1].focus();
        }
        if(e.key === "Enter"){
          verifyEmailOtp();
        }
      });
      el.addEventListener("paste", (e) => {
        const raw = (e.clipboardData?.getData("text") || "").replace(/\D/g, "").slice(0, 6);
        if(!raw) return;
        e.preventDefault();
        raw.split("").forEach((ch, i) => {
          if(inputs[i]) inputs[i].value = ch;
        });
        const next = Math.min(raw.length, inputs.length - 1);
        inputs[next]?.focus();
      });
    });
  }

  function stopAuthCodeTimer(){
    if(authCodeTimer){
      clearInterval(authCodeTimer);
      authCodeTimer = null;
    }
  }

  function formatRemain(sec){
    const mm = String(Math.floor(sec / 60)).padStart(2, "0");
    const ss = String(sec % 60).padStart(2, "0");
    return `${mm}:${ss}`;
  }

  function startAuthCodeTimer(){
    stopAuthCodeTimer();
    const hint = $("#authOtpHint");
    const resendBtn = $("#authOtpResendBtn");
    const tick = () => {
      if(!pendingEmailAuth || !pendingEmailAuth.expiresAt){
        stopAuthCodeTimer();
        return;
      }
      const remainSec = Math.max(0, Math.ceil((pendingEmailAuth.expiresAt - Date.now()) / 1000));
      if(remainSec <= 0){
        pendingEmailAuth.expired = true;
        if(hint) hint.textContent = "인증번호가 만료되었습니다. 인증번호를 다시 보내주세요.";
        if(resendBtn){
          resendBtn.classList.remove("disabled");
          resendBtn.textContent = "인증번호 재전송";
        }
        stopAuthCodeTimer();
        return;
      }
      pendingEmailAuth.expired = false;
      if(hint) hint.textContent = `인증번호 확인 제한시간 ${formatRemain(remainSec)} (3분)`;
      if(resendBtn){
        resendBtn.classList.add("disabled");
        resendBtn.textContent = `재전송 ${formatRemain(remainSec)}`;
      }
    };
    tick();
    authCodeTimer = setInterval(tick, 1000);
  }

  function getGatePassword(isSignup){
    const p = (isSignup ? $("#signupPassword").value : $("#loginPassword").value).trim();
    if(p.length < 6){
      return { ok:false, msg:"비밀번호는 6자 이상 입력해 주세요", password:"" };
    }
    return { ok:true, msg:"", password:p };
  }

  function openAuthGate(reason, open=true){
    state.authReason = reason || "";
    $("#authGateTitle").textContent = reason ? `${reason} 사용하려면 로그인` : "로그인";
    $("#authGate").classList.toggle("open", open);
    $("#authGate").setAttribute("aria-hidden", open ? "false" : "true");
    if(open){
      switchAuthTab("login");
      setTimeout(()=> $("#loginDigits").focus(), 120);
      refreshEmailPreview();
      syncAuthModeHint();
    }else{
      pendingEmailAuth = null;
      openOtpBox(false);
    }
  }

  function switchAuthTab(tab){
    const isLogin = tab === "login";
    $("#tabLogin").classList.toggle("active", isLogin);
    $("#tabSignup").classList.toggle("active", !isLogin);
    $("#loginView").style.display = isLogin ? "block" : "none";
    $("#signupView").style.display = isLogin ? "none" : "block";
    $("#switchToSignup").textContent = isLogin ? "회원가입" : "로그인";
    setTimeout(()=> (isLogin ? $("#loginDigits") : $("#signupDigits")).focus(), 60);
    refreshEmailPreview();
    openOtpBox(false);
  }

  function refreshEmailPreview(){
    const isSignup = $("#tabSignup").classList.contains("active");
    const digits = (isSignup ? $("#signupDigits").value : $("#loginDigits").value).trim();
    const safe = digits.replace(/\D/g,"").slice(0,4);
    const shown = safe.padEnd(4, "_");
    const email = `${EMAIL_PREFIX}${shown}@${SCHOOL_DOMAIN}`;
    const el = $("#emailPreviewText");
    if(el) el.textContent = email;
  }

  function readGateInputs(isSignup){
    const digits = (isSignup ? $("#signupDigits").value : $("#loginDigits").value).trim();
    const grade = (isSignup ? $("#signupGrade").value : $("#loginGrade").value).trim();
    const clazz = (isSignup ? $("#signupClass").value : $("#loginClass").value).trim();
    const no = (isSignup ? $("#signupNo").value : $("#loginNo").value).trim();

    if(!/^\d{4}$/.test(digits)) return { ok:false, msg:"0000(4자리)만 입력", email:"" };
    if(!/^\d{1}$/.test(grade)) return { ok:false, msg:"학년 확인", email:"" };
    if(!/^\d{1,2}$/.test(clazz)) return { ok:false, msg:"반 확인", email:"" };
    if(!/^\d{1,2}$/.test(no)) return { ok:false, msg:"번호 확인", email:"" };

    const email = `${EMAIL_PREFIX}${digits}@${SCHOOL_DOMAIN}`;
    return { ok:true, msg:"", email, grade, clazz, no };
  }

  async function submitAuthFlow(){
    if(!state.supabaseReady || !supabaseClient){
      submitDemoAuth();
      return;
    }

    const isSignup = $("#tabSignup").classList.contains("active");
    const info = readGateInputs(isSignup);
    if(!info.ok){ toast(info.msg); return; }
    const pass = getGatePassword(isSignup);
    if(!pass.ok){ toast(pass.msg); return; }

    if(isSignup){
      // 이미 있는 계정이면 재가입 메일을 다시 보내지 않도록 먼저 로그인 가능 여부를 확인
      const probe = await supabaseClient.auth.signInWithPassword({
        email: info.email,
        password: pass.password
      });
      if(!probe.error){
        await supabaseClient.auth.signOut();
      }else{
        const msg = String(probe.error.message || "").toLowerCase();
        const maybeNew = msg.includes("invalid login credentials") || msg.includes("invalid");
        if(!maybeNew){
          openOtpBox(true, `회원가입 확인 실패: ${probe.error.message}`);
          toast("회원가입 확인 실패: " + probe.error.message);
          return;
        }
        const { error } = await supabaseClient.auth.signUp({
          email: info.email,
          password: pass.password,
          options: {
            data: {
              grade: info.grade,
              clazz: info.clazz,
              no: info.no,
              handle: info.email.split("@")[0]
            }
          }
        });
        if(error && !String(error.message || "").toLowerCase().includes("already")){
          openOtpBox(true, `회원가입 실패: ${error.message}`);
          toast("회원가입 실패: " + error.message);
          return;
        }
      }
    }else{
      const { error } = await supabaseClient.auth.signInWithPassword({
        email: info.email,
        password: pass.password
      });
      if(error){
        openOtpBox(true, "로그인 실패: 이메일/비밀번호를 확인해 주세요.");
        toast("로그인 실패: 이메일/비밀번호 확인");
        return;
      }
      await supabaseClient.auth.signOut();
    }

    openOtpBox(true, `인증번호 발송 중... 대상: ${maskEmail(info.email)}`);
    const send = await supabaseClient.auth.signInWithOtp({
      email: info.email,
      options: { shouldCreateUser: false }
    });
    if(send.error){
      if(String(send.error.message || "").toLowerCase().includes("rate limit")){
        setAuthHint("발송 제한: 잠시 후 다시 시도해 주세요. (Supabase 기본 메일 한도)");
      }
      setAuthHint(`발송 실패: ${send.error.message}`);
      toast("인증번호 발송 실패: " + send.error.message);
      return;
    }

    pendingEmailAuth = {
      mode: isSignup ? "signup" : "login",
      email: info.email,
      grade: info.grade,
      clazz: info.clazz,
      no: info.no,
      expiresAt: Date.now() + AUTH_CODE_TTL_MS,
      expired: false
    };
    openOtpBox(true, `인증번호를 ${maskEmail(info.email)} 로 보냈습니다.`);
    startAuthCodeTimer();
    toast("인증번호 발송 완료");
  }

  async function resendEmailOtp(){
    if(!state.supabaseReady || !supabaseClient || !pendingEmailAuth){
      toast("먼저 인증번호를 보내주세요");
      return;
    }
    if(pendingEmailAuth.expiresAt && Date.now() < pendingEmailAuth.expiresAt){
      toast("3분 제한 중에는 재전송할 수 없습니다");
      return;
    }
    setAuthHint(`인증번호 재전송 중... 대상: ${maskEmail(pendingEmailAuth.email)}`);
    const send = await supabaseClient.auth.signInWithOtp({
      email: pendingEmailAuth.email,
      options: { shouldCreateUser: false }
    });
    if(send.error){
      if(String(send.error.message || "").toLowerCase().includes("rate limit")){
        setAuthHint("재전송 제한: 잠시 후 다시 시도해 주세요. (Supabase 기본 메일 한도)");
      }
      setAuthHint(`재전송 실패: ${send.error.message}`);
      toast("재전송 실패: " + send.error.message);
      return;
    }
    pendingEmailAuth.expiresAt = Date.now() + AUTH_CODE_TTL_MS;
    pendingEmailAuth.expired = false;
    startAuthCodeTimer();
    toast("인증번호 재전송 완료");
  }

  async function verifyEmailOtp(){
    if(!state.supabaseReady || !supabaseClient || !pendingEmailAuth){
      toast("먼저 인증번호를 보내주세요");
      return;
    }
    if(!pendingEmailAuth.expiresAt || Date.now() > pendingEmailAuth.expiresAt){
      pendingEmailAuth.expired = true;
      toast("인증번호가 만료되었습니다. 다시 받아주세요");
      return;
    }
    const token = getAuthCodeToken();
    if(!/^\d{8}$/.test(token)){
      toast("인증번호 8자리를 입력해 주세요");
      return;
    }
    const { data, error } = await supabaseClient.auth.verifyOtp({
      email: pendingEmailAuth.email,
      token,
      type: "email"
    });
    if(error){
      toast("인증 실패: " + error.message);
      return;
    }
    const user = data?.user || null;
    const md = user?.user_metadata || {};
    const email = String(user?.email || pendingEmailAuth.email || "");
    db.auth.loggedIn = true;
    db.auth.user = {
      email,
      handle: email.split("@")[0],
      grade: String(md.grade || pendingEmailAuth.grade || ""),
      clazz: String(md.clazz || pendingEmailAuth.clazz || ""),
      no: String(md.no || pendingEmailAuth.no || "")
    };
    refreshCurrentAnonNickname();
    saveDB(db);
    syncAuthUI();
    openAuthGate(null, false);
    toast("로그인 완료");
  }

  function maskEmail(email){
    const [id, dom] = String(email || "").split("@");
    if(!id || !dom) return email;
    const h = id.slice(0, Math.min(4, id.length));
    return `${h}***@${dom}`;
  }

  function setAuthHint(text){
    const h = $("#authOtpHint");
    if(h && text) h.textContent = text;
  }

  // fallback “데모 확인” (구글 없이도 UI 테스트 가능)
  function submitDemoAuth(){
    const isSignup = $("#tabSignup").classList.contains("active");
    const info = readGateInputs(isSignup);
    if(!info.ok){ toast(info.msg); return; }

    db.auth.loggedIn = true;
    db.auth.user = {
      email: info.email,
      handle: `${EMAIL_PREFIX}${info.email.split("@")[0].replace(EMAIL_PREFIX,"")}`,
      grade: info.grade,
      clazz: info.clazz,
      no: info.no
    };
    refreshCurrentAnonNickname();
    saveDB(db);
    syncAuthUI();
    openAuthGate(null, false);
    toast(isSignup ? "회원가입(데모)" : "로그인(데모)");
  }

  function logout(){
    db.auth.loggedIn = false;
    db.auth.user = null;
    state.adminSession = false;
    refreshCurrentAnonNickname();
    saveDB(db);
    syncAuthUI();
    toast("로그아웃");
    if(state.activeRoute === "profile") go("home");
  }

  function syncAuthUI(){
    const logged = !!db.auth.loggedIn;
    const anonLabel = db.me?.anon || "익명의 고래";
    const profileDisplay = String(db.profile.displayName || "").trim();
    const safeDisplay = /ps2\d+/i.test(profileDisplay) ? "" : profileDisplay;
    const display = safeDisplay || `u/${anonLabel}`;
    $("#profileUserText").textContent = display;
    $("#profileEmailText").textContent = logged ? (db.auth.user?.email || "") : "로그인하면 학교 계정으로 표시됨";
    $("#profileAuthBtn").textContent = logged ? "로그인됨" : "로그인";
    $("#profileAuthBtn").classList.toggle("disabled", logged);

    $("#drawerAuthText").textContent = logged ? "로그인됨" : "로그인";
    $("#drawerAuthHint").textContent = logged ? (db.auth.user?.email || "") : "잠금 해제";
    $("#drawerLogoutBtn").style.display = logged ? "flex" : "none";
    $("#drawerSubText").textContent = hasAnyJoined() ? "참여 중 • 커뮤니티 피드 활성" : "참여 전엔 보기만 가능";

    $("#accountRowTitle").textContent = logged ? "로그인됨" : "로그인";
    $("#accountRowDesc").textContent = logged ? (db.auth.user?.email || "") : "댓글/투표/작성/채팅이 열림";
    $("#drawerThemeText").textContent = (db.settings.theme === "light") ? "화이트" : "다크";
    const quickLabel = $("#quickMyLabel");
    if(quickLabel) quickLabel.textContent = logged ? display : anonLabel;
    const admin = isAdminUser();
    $("#adEditBtn").style.display = admin ? "block" : "none";
    const inlineBtn = $("#adEditBtnInline");
    if(inlineBtn) inlineBtn.style.display = admin ? "inline-flex" : "none";
    const hint = $("#adminBannerHint");
    if(hint) hint.textContent = admin ? "관리자 인증됨: 배너 수정 가능합니다." : "관리자 인증 후 배너를 수정할 수 있습니다.";
    const newsAdminBtn = $("#ibNewsWriteBtn");
    if(newsAdminBtn) newsAdminBtn.style.display = admin ? "inline-flex" : "none";
  }
    // =========================
  // Render
  // =========================
  function renderAll(){
    renderBanner();
    renderHomeFeed();
    renderCommunities();
    renderInbox(getActiveInboxTab());
    renderIbHub();
    renderProfile();
    renderDrawerCommunityLists();
    if($("#miniGameResult")) $("#miniGameResult").textContent = `최고 기록: ${db.ui.miniBestMs ? db.ui.miniBestMs + "ms" : "-"}`;
    syncCompose();
    renderSettings();
    syncInboxBadge();
    // apply entrance animations to newly-rendered list items
    try{ applyEntranceAnimations(); }catch(e){}
  }

  // Entrance animations: mark nodes with .animate-in and reveal them when intersecting
  function applyEntranceAnimations(){
    if(window.matchMedia && window.matchMedia('(prefers-reduced-motion: reduce)').matches) return;
    if(document.body.classList.contains("reduce-motion-ui")) return;
    const selector = '.postCard, .commCard, .noticeCard, .adBanner, .ibAppCard';
    const nodes = Array.from(document.querySelectorAll(selector));
    if(!nodes.length) return;

    const io = new IntersectionObserver((entries, obs) => {
      entries.forEach(en => {
        if(en.isIntersecting){
          en.target.classList.add('is-visible');
          obs.unobserve(en.target);
        }
      });
    }, { threshold: 0.08, rootMargin: '0px 0px -8% 0px' });

    nodes.forEach((n, idx) => {
      if(n.classList.contains('is-visible')) return;
      n.classList.add('animate-in');
      n.style.setProperty("--enter-delay", `${Math.min((idx % 10) * 26, 220)}ms`);
      io.observe(n);
    });
  }

  function renderHomeFeed(){
    const host = $("#homeFeed");
    const q = (state.homeQuery || "").toLowerCase();
    let list = db.posts.slice();

    if(state.homeSub === "news"){
      list = list.filter(p => (p.title||"").toLowerCase().includes("news") || (p.body||"").toLowerCase().includes("news"));
    }else if(state.homeSub === "latest"){
      list = list.slice().sort((a,b)=> (b.createdAt||0)-(a.createdAt||0));
    }

    if(q){
      list = list.filter(p =>
        (p.title||"").toLowerCase().includes(q) ||
        (p.body||"").toLowerCase().includes(q) ||
        ("r/"+(p.communityName||"")).toLowerCase().includes(q)
      );
    }

    host.innerHTML = list.length ? list.map(p => postCardHTML(p)).join("")
      : `<div class="muted" style="font-weight:var(--w-semibold);">아직 게시물이 없어요. 커뮤니티에 참여하고 첫 글을 올려보세요.</div>`;
  }

  function renderCommunities(){
    const myHost = $("#myCommList");
    const host = $("#commList");
    const q = ($("#commSearchInput")?.value || "").trim().toLowerCase();

    const matched = db.communities.filter(c => {
      if(!q) return true;
      return (
        String(c.name || "").toLowerCase().includes(q) ||
        String(c.desc || "").toLowerCase().includes(q)
      );
    });
    const joined = matched.filter(c => c.joined);
    const others = matched.filter(c => !c.joined);

    myHost.innerHTML = joined.length
      ? joined.map(c => commRowHTML(c, true)).join("")
      : `<div class="muted" style="font-weight:var(--w-semibold);">${q ? "검색 결과가 없어요." : "아직 참여한 커뮤니티가 없어요. 아래에서 참여해보세요."}</div>`;

    host.innerHTML = others.length
      ? others.map(c => commRowHTML(c, false)).join("")
      : `<div class="muted" style="font-weight:var(--w-semibold);">${q ? "검색 결과가 없어요." : "추천 커뮤니티가 없어요."}</div>`;

    renderCommDropdown();
    renderCommunityReview();
    renderDrawerCommunityLists();
    switchCommTab(state.commTab || "explore", false);
  }

  function switchCommTab(tab, persist=true){
    const target = tab || "explore";
    if(target === "review" && !isAdminUser()){
      toast("관리 코드 인증 후 신청관리 접근 가능");
      state.commTab = "explore";
      $$("#commTabs .segTab").forEach(x => x.classList.toggle("active", x.dataset.commTab === "explore"));
      $("#commPanelExplore").classList.add("active");
      $("#commPanelCreate").classList.remove("active");
      $("#commPanelReview").classList.remove("active");
      return;
    }
    state.commTab = target;
    if(persist){
      db.ui.commTab = target;
      saveDB(db);
    }
    $$("#commTabs .segTab").forEach(x => x.classList.toggle("active", x.dataset.commTab === target));
    $("#commPanelExplore").classList.toggle("active", target === "explore");
    $("#commPanelCreate").classList.toggle("active", target === "create");
    $("#commPanelReview").classList.toggle("active", target === "review");
    if(target === "review") renderCommunityReview();
  }

  function submitCommunityApplication(){
    if(!db.auth.loggedIn){ openAuthGate("커뮤니티 신청"); return; }
    const nameRaw = $("#commApplyName").value.trim();
    const topic = $("#commApplyTopic").value.trim();
    const desc = $("#commApplyDesc").value.trim();
    const rule = $("#commApplyRule").value.trim();
    const safe = sanitizeCommName(nameRaw);
    if(!safe){ toast("커뮤니티 이름 형식을 확인해 주세요"); return; }
    if(!topic || !desc){ toast("주제와 소개글을 입력해 주세요"); return; }
    if(db.communities.some(c => c.name.toLowerCase() === safe.toLowerCase())){
      toast("이미 존재하는 커뮤니티 이름입니다");
      return;
    }
    if(db.commRequests.some(r => r.name.toLowerCase() === safe.toLowerCase() && r.status === "pending")){
      toast("이미 심사 중인 신청입니다");
      return;
    }
    db.commRequests.unshift({
      id: uid("rq"),
      name: safe,
      topic,
      desc,
      rule,
      applicant: db.auth.user?.email || db.me.anon,
      status: "pending",
      createdAt: Date.now()
    });
    saveDB(db);
    $("#commApplyName").value = "";
    $("#commApplyTopic").value = "";
    $("#commApplyDesc").value = "";
    $("#commApplyRule").value = "";
    switchCommTab("review");
    toast("신청이 접수되었습니다");
  }

  function renderCommunityReview(){
    const host = $("#commReviewList");
    if(!host) return;
    const hint = $("#adminHint");
    const pending = db.commRequests.filter(x => x.status === "pending");
    const done = db.commRequests.filter(x => x.status !== "pending").slice(0, 8);
    if(!isAdminUser()){
      hint.textContent = "관리 코드 인증 후에만 승인/거절 가능합니다.";
      host.innerHTML = `
        <div class="drawerMiniEmpty">사이드 메뉴의 “관리 코드”에서 코드 입력 후 다시 들어와 주세요.</div>
        <div class="sectionTitle" style="margin-top:12px;">최근 처리 내역</div>
        ${done.length ? done.map(r => `
          <div class="reviewCard">
            <div style="font-weight:var(--w-semibold);">r/${esc(r.name)}</div>
            <div class="reviewMeta">상태: ${r.status === "approved" ? "승인됨" : "거절됨"} • 신청자: ${esc(r.applicant||"-")}</div>
          </div>
        `).join("") : `<div class="drawerMiniEmpty">아직 처리된 신청이 없습니다.</div>`}
      `;
      return;
    }
    hint.textContent = "관리자 모드 활성화됨. 신청을 승인/거절하세요.";
    host.innerHTML = pending.length ? pending.map(r => `
      <div class="reviewCard">
        <div style="font-weight:var(--w-bold);">r/${esc(r.name)}</div>
        <div class="reviewMeta">주제: ${esc(r.topic)}<br/>소개: ${esc(r.desc)}${r.rule ? `<br/>규칙: ${esc(r.rule)}` : ""}<br/>신청자: ${esc(r.applicant||"-")}</div>
        <div class="reviewActions">
          <div class="btn blue" data-review-act="approve" data-req-id="${esc(r.id)}">승인</div>
          <div class="btn danger" data-review-act="reject" data-req-id="${esc(r.id)}">거절</div>
        </div>
      </div>
    `).join("") : `<div class="drawerMiniEmpty">대기 중인 신청이 없습니다.</div>`;
  }

  function reviewCommunityRequest(reqId, action){
    const r = db.commRequests.find(x => x.id === reqId);
    if(!r || r.status !== "pending") return;
    if(action === "approve"){
      if(db.communities.some(c => c.name.toLowerCase() === r.name.toLowerCase())){
        r.status = "rejected";
      }else{
        db.communities.unshift({
          id: uid("c"),
          name: r.name,
          desc: r.desc,
          members: 1,
          joined: false,
          createdBy: r.applicant || "관리자"
        });
        r.status = "approved";
        db.inbox.unshift({
          id: uid("n"),
          icon: "🧩",
          title: "커뮤니티 신청이 승인되었습니다",
          body: `r/${r.name}`,
          time: "지금",
          target: {type:"community", communityId: db.communities[0].id},
          unread: true
        });
      }
    }else{
      r.status = "rejected";
      db.inbox.unshift({
        id: uid("n"),
        icon: "⛔",
        title: "커뮤니티 신청이 거절되었습니다",
        body: `r/${r.name}`,
        time: "지금",
        target: {type:"comm"},
        unread: true
      });
    }
    r.reviewedAt = Date.now();
    saveDB(db);
    renderCommunities();
    toast(action === "approve" ? "승인 처리됨" : "거절 처리됨");
  }

  function renderDrawerCommunityLists(){
    const joinedHost = $("#drawerJoinedList");
    const recentHost = $("#drawerRecentList");
    if(!joinedHost || !recentHost) return;
    const showRecent = db.settings.showRecentCommunities !== false;
    const joined = db.communities.filter(c => c.joined).slice(0, 6);
    const recents = (db.ui.recentCommunityIds || [])
      .map(id => db.communities.find(c => c.id === id))
      .filter(Boolean)
      .slice(0, 6);

    joinedHost.innerHTML = joined.length
      ? joined.map(c => `<div class="drawerItem" data-open-comm="${esc(c.id)}"><div class="l"><span>r/${esc(c.name)}</span></div><div class="r">참여 중</div></div>`).join("")
      : `<div class="drawerMiniEmpty">참여 중인 커뮤니티가 없습니다.</div>`;
    if(!showRecent){
      recentHost.innerHTML = `<div class="drawerMiniEmpty">최근 커뮤니티 표시가 꺼져 있습니다.</div>`;
      return;
    }
    recentHost.innerHTML = recents.length
      ? recents.map(c => `<div class="drawerItem" data-open-comm="${esc(c.id)}"><div class="l"><span>r/${esc(c.name)}</span></div><div class="r">최근 방문</div></div>`).join("")
      : `<div class="drawerMiniEmpty">최근 방문 기록이 없습니다.</div>`;
  }

  function drawerCommunityHandler(e){
    const row = e.target.closest("[data-open-comm]");
    if(!row) return;
    openDrawer(false);
    openCommunity(row.dataset.openComm);
  }

  function rememberRecentCommunity(commId){
    if(!commId) return;
    const next = [commId, ...(db.ui.recentCommunityIds || []).filter(id => id !== commId)].slice(0, 8);
    db.ui.recentCommunityIds = next;
  }

  function positionMenuPopup(anchorEl){
    const popup = $("#menuPopup");
    if(!popup) return;
    const vw = window.innerWidth;
    const vh = window.innerHeight;
    const pad = 10;
    const r = anchorEl?.getBoundingClientRect
      ? anchorEl.getBoundingClientRect()
      : {left: vw - 44, right: vw - 10, top: 12, bottom: 46, width: 34, height: 34};

    popup.style.left = "-9999px";
    popup.style.top = "-9999px";
    const pw = popup.offsetWidth || 240;
    const ph = popup.offsetHeight || 260;

    let left = r.right - pw;
    left = Math.max(pad, Math.min(left, vw - pw - pad));

    let top = r.bottom + 6;
    if(top + ph > vh - pad){
      top = r.top - ph - 6;
    }
    top = Math.max(pad, Math.min(top, vh - ph - pad));

    popup.style.left = `${left}px`;
    popup.style.top = `${top}px`;
  }

  function openGeneralMenu(anchorEl){
    state.menuPostId = null;
    state.menuCommentId = null;
    $("#menuPanelTitle").textContent = "More actions...";
    $("#menuGoSettingsRow").style.display = "flex";
    $("#menuShowLessRow").style.display = "none";
    $("#menuFollowRow").style.display = "none";
    $("#menuSaveRow").style.display = "none";
    $("#menuReportRow").style.display = "none";
    $("#menuCrosspostRow").style.display = "none";
    $("#menuWhyRow").style.display = "none";
    $("#menuBlockRow").style.display = "none";
    $("#menuHideRow").style.display = "none";
    $("#menuCopyLinkRow").style.display = "flex";
    $("#menuCopyTextRow").style.display = "none";
    $("#menuDeletePostRow").style.display = "none";
    openOverlay("menuOverlay", true);
    positionMenuPopup(anchorEl);
  }

  function openPostMenu(postId, anchorEl){
    state.menuPostId = postId || null;
    state.menuCommentId = null;
    const post = db.posts.find(x => x.id === postId);
    const canDelete = !!post && (post.author === db.me.anon || isAdminUser());
    $("#menuPanelTitle").textContent = "More actions...";
    $("#menuGoSettingsRow").style.display = "none";
    $("#menuShowLessRow").style.display = "flex";
    $("#menuFollowRow").style.display = "flex";
    $("#menuSaveRow").style.display = "flex";
    $("#menuReportRow").style.display = "flex";
    $("#menuCrosspostRow").style.display = "flex";
    $("#menuWhyRow").style.display = "flex";
    $("#menuBlockRow").style.display = "flex";
    $("#menuHideRow").style.display = "flex";
    $("#menuCopyLinkRow").style.display = "flex";
    $("#menuCopyTextRow").style.display = "flex";
    $("#menuDeleteTitle").textContent = "게시물 삭제";
    $("#menuDeletePostRow").style.display = canDelete ? "flex" : "none";
    openOverlay("menuOverlay", true);
    positionMenuPopup(anchorEl);
  }

  function openCommentMenu(commentId, anchorEl){
    state.menuCommentId = commentId || null;
    state.menuPostId = null;
    const c = db.comments.find(x => x.id === commentId);
    const canDelete = !!c && (c.author === db.me.anon || isAdminUser());
    $("#menuPanelTitle").textContent = "More actions...";
    $("#menuGoSettingsRow").style.display = "none";
    $("#menuShowLessRow").style.display = "none";
    $("#menuFollowRow").style.display = "none";
    $("#menuSaveRow").style.display = "none";
    $("#menuReportRow").style.display = "flex";
    $("#menuCrosspostRow").style.display = "none";
    $("#menuWhyRow").style.display = "none";
    $("#menuBlockRow").style.display = "flex";
    $("#menuHideRow").style.display = "none";
    $("#menuCopyLinkRow").style.display = "none";
    $("#menuCopyTextRow").style.display = "flex";
    $("#menuDeleteTitle").textContent = "댓글 삭제";
    $("#menuDeletePostRow").style.display = canDelete ? "flex" : "none";
    openOverlay("menuOverlay", true);
    positionMenuPopup(anchorEl);
  }

  function handleMenuAction(action){
    if(action === "settings"){
      openOverlay("menuOverlay", false);
      go("settings");
      return;
    }
    if(action === "copyLink"){
      if(state.menuPostId) copyText(makeLink({type:"post", postId: state.menuPostId}));
      else copyText(makeLink(getCurrentLinkTarget()));
      return;
    }
    if(action === "copyText"){
      copyMenuText();
      return;
    }
    if(action === "delete"){
      if(state.menuPostId) deletePost(state.menuPostId);
      if(state.menuCommentId) deleteComment(state.menuCommentId);
      return;
    }
    if(action === "showLess"){ toast("비슷한 게시물 노출이 줄어듭니다"); return; }
    if(action === "follow"){ toast("팔로우 목록에 추가됨"); return; }
    if(action === "save"){ toast("저장되었습니다"); return; }
    if(action === "crosspost"){ toast("글쓰기에서 커뮤니티 선택 후 재게시하세요"); return; }
    if(action === "why"){ toast("최근 관심 커뮤니티와 활동을 기반으로 추천됨"); return; }
    if(action === "report"){ toast("신고 접수됨"); return; }
    if(action === "block"){ toast("계정 차단 목록에 추가됨"); return; }
    if(action === "hide"){ toast("피드에서 숨겼습니다"); return; }
  }

  function copyMenuText(){
    if(state.menuPostId){
      const p = db.posts.find(x => x.id === state.menuPostId);
      if(!p) return;
      copyText(`${p.title}\n${p.body || ""}`.trim());
      return;
    }
    if(state.menuCommentId){
      const c = db.comments.find(x => x.id === state.menuCommentId);
      if(!c) return;
      copyText(c.text || "");
    }
  }

  function deletePost(postId){
    const idx = db.posts.findIndex(x => x.id === postId);
    if(idx < 0) return;
    const target = db.posts[idx];
    if(target.author !== db.me.anon && !isAdminUser()){ toast("내 게시물만 삭제할 수 있어요"); return; }
    const ok = confirm("이 게시물을 삭제할까요?");
    if(!ok) return;
    db.posts.splice(idx, 1);
    db.comments = db.comments.filter(c => c.postId !== postId);
    db.inbox = db.inbox.filter(n => !(n.target?.type === "post" && n.target.postId === postId));
    saveDB(db);
    openOverlay("menuOverlay", false);
    state.menuPostId = null;
    if(state.activePostId === postId){
      state.activePostId = null;
      go("home");
    }
    renderAll();
    toast("게시물 삭제 완료");
  }

  function deleteComment(commentId){
    const idx = db.comments.findIndex(x => x.id === commentId);
    if(idx < 0) return;
    const target = db.comments[idx];
    if(target.author !== db.me.anon && !isAdminUser()){ toast("내 댓글만 삭제할 수 있어요"); return; }
    const ok = confirm("이 댓글을 삭제할까요?");
    if(!ok) return;
    db.comments.splice(idx, 1);
    const post = db.posts.find(p => p.id === target.postId);
    if(post) post.commentsCount = Math.max(0, (post.commentsCount || 0) - 1);
    saveDB(db);
    openOverlay("menuOverlay", false);
    state.menuCommentId = null;
    if(state.activePostId) renderComments(state.activePostId);
    renderAll();
    toast("댓글 삭제 완료");
  }

  function renderProfile(){
    $("#karmaNum").textContent = String(db.profile.karma);
    $("#contribNum").textContent = String(db.profile.contrib);
    $("#ageNum").textContent = db.profile.ageText;
    $("#activeNum").textContent = String(db.profile.active);

    const myPosts = db.posts.filter(p => p.author === db.me.anon);
    $("#profileContent").innerHTML = myPosts.length
      ? myPosts.map(p => postCardHTML(p)).join("")
      : `<div class="muted" style="font-weight:var(--w-semibold);">아직 작성한 게시물이 없어요. “만들기”에서 글을 올려보세요.</div>`;
    $("#profileBioText").textContent = db.profile.bio || "소개를 입력해 주세요.";
  }

  function switchProfileTab(tab){
    const t = tab || "posts";
    $$("#profileTabs .profileTab").forEach(x => x.classList.toggle("active", x.dataset.ptab === t));
    $("#profilePanelPosts").classList.toggle("active", t === "posts");
    $("#profilePanelAbout").classList.toggle("active", t === "about");
    $("#profilePanelStats").classList.toggle("active", t === "stats");
  }

  function saveProfileInfo(){
    const name = $("#profileNameInput").value.trim();
    const bio = $("#profileBioInput").value.trim();
    if(/ps2\d+/i.test(name)){
      toast("닉네임에는 학번/ps2 형식을 넣을 수 없습니다");
      return;
    }
    db.profile.displayName = name.slice(0, 22);
    db.profile.bio = bio.slice(0, 180);
    saveDB(db);
    $("#profileEditBox").style.display = "none";
    syncAuthUI();
    renderProfile();
    toast("프로필 저장됨");
  }

  function renderSettings(){
    const titleInput = $("#settingTitleLabel");
    const themeBtn = $("#themeToggle");
    if(titleInput) titleInput.value = db.settings.composeTitleLabel || "제목";
    if(themeBtn) themeBtn.textContent = (db.settings.theme === "light") ? "화이트" : "다크";
    const muteToggle = $("#settingsMuteVideos");
    const recentToggle = $("#settingsRecentCommunities");
    if(muteToggle) muteToggle.checked = db.settings.muteVideos !== false;
    if(recentToggle) recentToggle.checked = db.settings.showRecentCommunities !== false;
  }

  function renderSuggestScreen(){
    renderSuggestionList();
    renderCommentModerationList();
    syncAuthUI();
  }

  function renderPromoScreen(){
    renderBanner();
    syncAuthUI();
    const cfg = db.ui.banner || {};
    const pImg = $("#promoPreviewImg");
    const pTitle = $("#promoPreviewTitle");
    const pSub = $("#promoPreviewSubtitle");
    if(pTitle) pTitle.textContent = cfg.title || "오늘의 배너";
    if(pSub) pSub.textContent = cfg.subtitle || "프로젝트 참여해주세요";
    if(pImg){
      if(cfg.imageUrl){
        pImg.src = cfg.imageUrl;
        pImg.style.display = "block";
      }else{
        pImg.removeAttribute("src");
        pImg.style.display = "none";
      }
    }
  }

  function isAdminUser(){
    return !!state.adminSession;
  }

  function submitSuggestion(){
    const text = $("#suggestInput").value.trim();
    if(!text){ toast("제안 내용을 입력해 주세요"); return; }
    const author = db.auth.loggedIn ? (db.auth.user?.email || db.me.anon) : db.me.anon;
    const row = {
      id: uid("sg"),
      text: text.slice(0, 500),
      author,
      status: "접수",
      createdAt: Date.now()
    };
    db.suggestions.unshift(row);
    notifyAdminForSuggestion(row);
    $("#suggestInput").value = "";
    saveDB(db);
    renderSuggestionList();
    toast("제안이 등록되었습니다");
  }

  function notifyAdminForSuggestion(s){
    const adminEmail = ADMIN_EMAIL;
    db.inbox.unshift({
      id: uid("n"),
      icon: "💡",
      title: "새 제안이 접수되었습니다",
      body: `수신자: ${adminEmail} • ${s.text.slice(0, 28)}${s.text.length>28?"…":""}`,
      time: "지금",
      target: {type:"suggest"},
      unread: true
    });
    // 메일 클라이언트 초안 생성 시도 (웹/브라우저 환경에 따라 차단될 수 있음)
    try{
      const subject = encodeURIComponent("[표고모] 새 제안 접수");
      const body = encodeURIComponent(`작성자: ${s.author}\n\n내용:\n${s.text}`);
      const a = document.createElement("a");
      a.href = `mailto:${adminEmail}?subject=${subject}&body=${body}`;
      a.style.display = "none";
      document.body.appendChild(a);
      a.click();
      a.remove();
    }catch(e){}
  }

  function notifyAdminForCommentModeration(row, post){
    const title = (post?.title || "").slice(0, 22);
    db.inbox.unshift({
      id: uid("n"),
      icon: "🚨",
      title: "유해 댓글 검수 요청",
      body: `${row.reasons.join(", ")} • ${title}${post?.title?.length > 22 ? "…" : ""}`,
      time: "지금",
      target: {type:"commentModeration", moderationId: row.id},
      unread: true
    });
  }

  function renderCommentModerationList(){
    const host = $("#commentModerationList");
    const hint = $("#commentModerationHint");
    if(!host || !hint) return;
    const rows = Array.isArray(db.commentModerations) ? db.commentModerations : [];
    const pending = rows.filter((x) => x.status === "pending");
    const done = rows.filter((x) => x.status !== "pending").slice(0, 10);

    if(!isAdminUser()){
      hint.textContent = pending.length
        ? `관리자 인증 필요: 현재 ${pending.length}건 대기 중`
        : "관리자 코드 2026 인증 후 승인/거절할 수 있습니다.";
      host.innerHTML = done.length
        ? done.map((r) => `
          <div class="reviewCard">
            <div style="font-weight:var(--w-semibold);">${esc(r.status === "approved" ? "승인됨" : "거절됨")} • ${esc(r.reasons.join(", "))}</div>
            <div class="reviewMeta">${esc(r.author)} • ${esc((r.text || "").slice(0, 80))}${(r.text || "").length > 80 ? "…" : ""}</div>
          </div>
        `).join("")
        : `<div class="drawerMiniEmpty">검수 내역이 아직 없습니다.</div>`;
      return;
    }

    hint.textContent = "관리자 인증됨: 댓글을 승인하거나 거절할 수 있습니다.";
    host.innerHTML = pending.length
      ? pending.map((r) => `
        <div class="reviewCard">
          <div style="font-weight:var(--w-bold);">${esc(r.reasons.join(", "))}</div>
          <div class="reviewMeta">작성자: ${esc(r.author)}<br/>내용: ${esc(r.text)}</div>
          <div class="reviewActions">
            <div class="btn blue" data-mod-act="approve" data-mod-id="${esc(r.id)}">승인</div>
            <div class="btn danger" data-mod-act="reject" data-mod-id="${esc(r.id)}">거절</div>
          </div>
        </div>
      `).join("")
      : `<div class="drawerMiniEmpty">대기 중인 유해 댓글이 없습니다.</div>`;
  }

  function reviewCommentModeration(modId, act){
    const row = (db.commentModerations || []).find((x) => x.id === modId);
    if(!row || row.status !== "pending") return;
    row.status = act === "approve" ? "approved" : "rejected";
    row.resolvedAt = Date.now();
    row.resolvedBy = db.me.anon;

    if(act === "approve"){
      db.comments.push({
        id: uid("cm"),
        postId: row.postId,
        author: row.author,
        time: "방금",
        text: row.text,
        createdAt: Date.now()
      });
      const post = db.posts.find((p) => p.id === row.postId);
      if(post) post.commentsCount = (post.commentsCount || 0) + 1;
      db.inbox.unshift({
        id: uid("n"),
        icon: "✅",
        title: "검수 댓글이 승인되었습니다",
        body: `${row.author} 댓글이 피드에 노출됩니다`,
        time: "지금",
        target: {type:"commentModeration", moderationId: row.id},
        unread: true
      });
      toast("댓글 승인 완료");
    }else{
      db.inbox.unshift({
        id: uid("n"),
        icon: "⛔",
        title: "검수 댓글이 거절되었습니다",
        body: `${row.author} 댓글이 차단되었습니다`,
        time: "지금",
        target: {type:"commentModeration", moderationId: row.id},
        unread: true
      });
      toast("댓글 거절 완료");
    }
    saveDB(db);
    renderCommentModerationList();
    if(state.activeRoute === "comments" && state.activePostId === row.postId){
      renderComments(row.postId);
    }
    renderInbox(getActiveInboxTab());
    syncInboxBadge();
  }

  function renderSuggestionList(){
    const host = $("#suggestList");
    if(!host) return;
    if(!db.suggestions.length){
      host.innerHTML = `<div class="muted2" style="font-size:12px;">아직 등록된 제안이 없습니다.</div>`;
      return;
    }
    const admin = isAdminUser();
    host.innerHTML = db.suggestions.slice(0, 20).map(s => `
      <div style="border:1px solid var(--line);border-radius:12px;padding:10px;margin:8px 0;background:rgba(255,255,255,.02);">
        <div style="display:flex;justify-content:space-between;gap:10px;align-items:center;">
          <b style="font-size:13px;">${esc(s.status)}</b>
          <span class="muted2" style="font-size:11px;">${esc(s.author)}</span>
        </div>
        <div style="margin-top:6px;line-height:1.55;">${esc(s.text)}</div>
        ${admin ? `<div style="display:flex;gap:8px;margin-top:8px;">
          <div class="btn" data-suggest-act="접수" data-suggest-id="${esc(s.id)}">접수</div>
          <div class="btn blue" data-suggest-act="검토중" data-suggest-id="${esc(s.id)}">검토중</div>
          <div class="btn" data-suggest-act="완료" data-suggest-id="${esc(s.id)}">완료</div>
        </div>` : ``}
      </div>
    `).join("");
  }

  function updateSuggestionStatus(id, nextStatus){
    const t = db.suggestions.find(x => x.id === id);
    if(!t) return;
    t.status = nextStatus;
    saveDB(db);
    renderSuggestionList();
    toast(`상태 변경: ${nextStatus}`);
  }

  function renderBanner(){
    const cfg = db.ui.banner || {};
    const img = $("#adBannerImg");
    const title = $("#adBannerTitle");
    const subtitle = $("#adBannerSubtitle");
    if(title) title.textContent = cfg.title || "오늘의 배너";
    if(subtitle) subtitle.textContent = cfg.subtitle || "스크린샷 느낌";
    if(img){
      if(cfg.imageUrl){
        img.style.display = "block";
        img.src = cfg.imageUrl;
        img.onerror = () => { img.style.display = "none"; };
      }else{
        img.removeAttribute("src");
        img.style.display = "none";
      }
    }
  }

  function editBannerByAdmin(){
    if(!isAdminUser()){ toast("관리자 계정만 수정 가능"); return; }
    const cur = db.ui.banner || {};
    const title = prompt("배너 제목", cur.title || "오늘의 배너");
    if(title === null) return;
    const subtitle = prompt("배너 부제목", cur.subtitle || "스크린샷 느낌");
    if(subtitle === null) return;
    const imageUrl = prompt("배너 이미지 URL (비우면 기본 배너 사용)", cur.imageUrl || "");
    if(imageUrl === null) return;
    db.ui.banner = {
      title: title.trim() || "오늘의 배너",
      subtitle: subtitle.trim() || "스크린샷 느낌",
      imageUrl: imageUrl.trim()
    };
    saveDB(db);
    renderBanner();
    toast("배너 수정 완료");
  }

  function uploadBannerImageFile(e){
    if(!isAdminUser()){ toast("관리자 인증 후 업로드 가능"); return; }
    const file = e.target.files && e.target.files[0];
    if(!file) return;
    if(file.size > 4 * 1024 * 1024){
      toast("이미지 용량은 4MB 이하만 가능합니다");
      e.target.value = "";
      return;
    }
    const reader = new FileReader();
    reader.onload = (evt) => {
      const cur = db.ui.banner || {};
      db.ui.banner = {
        title: cur.title || "오늘의 배너",
        subtitle: cur.subtitle || "스크린샷 느낌",
        imageUrl: String(evt.target.result || "")
      };
      saveDB(db);
      renderBanner();
      toast("배너 이미지 업로드 완료");
    };
    reader.readAsDataURL(file);
    e.target.value = "";
  }

  function adminQuickAuth(){
    if(isAdminUser()){
      const off = confirm("관리자 인증을 해제할까요?");
      if(off){
        state.adminSession = false;
        syncAuthUI();
        renderIbHub();
        toast("관리자 인증 해제");
      }
      return;
    }
    const key = prompt("관리 코드 입력");
    if(key && key.trim() === ADMIN_CODE){
      state.adminSession = true;
      syncAuthUI();
      renderSuggestScreen();
      renderIbHub();
      renderCommunityReview();
      toast("관리자 인증 완료");
    }else{
      toast("관리자 코드가 올바르지 않습니다");
    }
  }

  // =========================
  // Community / Dropdown
  // =========================
  function commRowHTML(c, inMy){
    const joined = !!c.joined;
    const icon = c.icon || (c.name[0] ? c.name[0].toUpperCase() : "r");
    return `
      <div class="commCard" data-comm-id="${esc(c.id)}">
        <div class="commIcon">${esc(icon)}</div>
        <div class="commMeta">
          <div class="commName">r/${esc(c.name)}</div>
          <div class="muted2" style="font-weight:var(--w-medium);font-size:12px;margin-bottom:4px;">
            ${esc(String(c.members))}명 • ${esc(c.desc)}
          </div>
          <div class="commSub">${c.createdBy ? `만든 사람: ${esc(c.createdBy)}` : esc(c.desc)}</div>
        </div>
        <div class="joinBtn ${joined ? "joined":""}" data-act="join">${joined ? "참여 중" : "참여"}</div>
        <div class="joinBtn" style="background:rgba(255,255,255,.02);border-color:var(--line);" data-act="open">
          ${inMy ? "열기" : "미리보기"}
        </div>
      </div>
    `;
  }

  function commListHandler(e){
    const card = e.target.closest(".commCard");
    if(!card) return;
    const commId = card.dataset.commId;
    const c = db.communities.find(x => x.id === commId);
    if(!c) return;

    const actBtn = e.target.closest("[data-act]");
    const act = actBtn ? actBtn.dataset.act : null;

    if(act === "join"){
      c.joined = !c.joined;
      c.members += c.joined ? 1 : -1;
      if(c.members < 0) c.members = 0;

      db.inbox.unshift({
        id: uid("n"),
        icon: c.joined ? "✅" : "↩️",
        title: c.joined ? "커뮤니티에 참여했습니다" : "커뮤니티에서 나왔습니다",
        body: `r/${c.name}`,
        time: "지금",
        target: {type:"community", communityId: c.id},
        unread: true
      });

      saveDB(db);
      renderCommunities();
      renderInbox(getActiveInboxTab());
      syncInboxBadge();
      toast(c.joined ? "참여 완료" : "나가기 완료");
      return;
    }

    openCommunity(commId);
  }

  function openCommunity(commId){
    state.activeCommunityId = commId;
    rememberRecentCommunity(commId);
    saveDB(db);
    renderCommDetail(commId);
    renderDrawerCommunityLists();
    go("commDetail");
  }

  function renderCommDetail(commId){
    const c = db.communities.find(x => x.id === commId);
    if(!c) return;

    $("#commDetailTitle").textContent = "r/" + c.name;
    $("#commDetailDesc").textContent = c.desc + (c.joined ? " • 참여 중" : " • 미리보기");

    const list = db.posts.filter(p => p.communityId === commId);
    $("#commDetailFeed").innerHTML = list.length
      ? list.map(p => postCardHTML(p)).join("")
      : `<div class="muted" style="font-weight:var(--w-semibold);">아직 게시물이 없어요. 참여 후 글을 올려보세요.</div>`;
  }

  function renderCommDropdown(){
    const host = $("#commDropdownList");
    const joined = db.communities.filter(c => c.joined);

    if(!joined.length){
      host.innerHTML = `<div style="padding:14px;color:var(--muted);font-weight:var(--w-semibold);">내 커뮤니티가 없어요.</div>`;
      return;
    }

    host.innerHTML = joined.map(c => `
      <div class="drawerItem" style="margin:0;border-radius:0;border-left:none;border-right:none;" data-comm-id="${esc(c.id)}">
        <div class="l"><span>r/${esc(c.name)}</span></div>
        <div class="r">${esc(c.desc)}</div>
      </div>
    `).join("");

    host.querySelectorAll("[data-comm-id]").forEach(item => {
      item.addEventListener("click", () => {
        db.ui.composeSelectedCommunityId = item.dataset.commId;
        saveDB(db);
        syncCompose();
        closeCommDropdown();
        updatePostBtn();
      });
    });
  }

  function toggleCommDropdown(){
    const dd = $("#commDropdown");
    dd.style.display = (dd.style.display === "none" || !dd.style.display) ? "block" : "none";
  }
  function closeCommDropdown(){
    $("#commDropdown").style.display = "none";
  }

  function syncCompose(){
    // title label element removed; no sync needed

    const joined = db.communities.filter(c => c.joined);
    const lock = !joined.length;
    $("#composeLockHint").style.display = lock ? "block" : "none";

    const selId = db.ui.composeSelectedCommunityId;
    const sel = joined.find(c => c.id === selId);
    if(!sel){
      db.ui.composeSelectedCommunityId = joined[0]?.id || null;
      saveDB(db);
    }

    const curId = db.ui.composeSelectedCommunityId;
    const cur = db.communities.find(c => c.id === curId && c.joined);
    $("#selectedCommunity").textContent = cur ? cur.name : "선택";
  }

  function updatePostBtn(){
    const hasComm = !!db.ui.composeSelectedCommunityId && db.communities.some(c => c.id===db.ui.composeSelectedCommunityId && c.joined);
    const hasTitle = $("#composeTitle").value.trim().length > 0;
    const hasBody = $("#composeBody").value.trim().length > 0;
    const hasMedia = composeMedia.length > 0;
    const ok = db.auth.loggedIn && hasComm && (hasTitle || hasBody || hasMedia);
    $("#postBtn").classList.toggle("disabled", !ok);
  }

  function renderComposeMediaPreview(){
    const container = $("#mediaPreviewContainer");
    const preview = $("#composeMediaPreview");
    
    if(composeMedia.length === 0){
      preview.style.display = "none";
      return;
    }
    
    preview.style.display = "block";
    container.innerHTML = composeMedia.map((m, idx) => `
      <div style="position: relative; flex-shrink: 0; width: 120px; height: 120px; border-radius: 12px; overflow: hidden; border: 1px solid var(--line); background: var(--surface);">
        ${m.type === "image" ? `<img src="${esc(m.src)}" style="width: 100%; height: 100%; object-fit: cover;" />` : `<div style="width: 100%; height: 100%; background: rgba(0,0,0,0.3); display: flex; align-items: center; justify-content: center; font-size: 24px;">🎬</div>`}
        <button style="position: absolute; top: -6px; right: -6px; width: 28px; height: 28px; border-radius: 50%; background: rgba(239,68,68,0.9); border: none; color: white; cursor: pointer; font-weight: bold; display: flex; align-items: center; justify-content: center; font-size: 16px; transition: background 200ms;" 
          onmouseover="this.style.background='rgba(239,68,68,1)'" 
          onmouseout="this.style.background='rgba(239,68,68,0.9)'"
          onclick="removeComposeMedia(${idx})">
          ×
        </button>
      </div>
    `).join("");
  }

  function removeComposeMedia(idx){
    composeMedia.splice(idx, 1);
    renderComposeMediaPreview();
    updatePostBtn();
  }
  
  // =========================
  // Posts / Comments
  // =========================
  function submitPost(){
    if($("#postBtn").classList.contains("disabled")) return;
    if(!db.auth.loggedIn){ openAuthGate("작성"); return; }

    const commId = db.ui.composeSelectedCommunityId;
    const comm = db.communities.find(c => c.id === commId && c.joined);
    if(!comm){ toast("커뮤니티 선택 필요"); return; }

    const title = $("#composeTitle").value.trim();
    const body = $("#composeBody").value.trim();
    if(!title && !body && composeMedia.length === 0){
      toast("제목, 본문 또는 첨부를 추가해 주세요");
      return;
    }

    const post = {
      id: uid("p"),
      communityId: commId,
      communityName: comm.name,
      author: db.me.anon,
      time: "방금",
      title: title || "제목 없음",
      body: body || "",
      media: composeMedia.length > 0 ? composeMedia : null,
      good: 0,
      bad: 0,
      commentsCount: 0,
      createdAt: Date.now(),
      votesByClient: {}
    };

    // localStorage 저장 실패(특히 큰 미디어) 시 롤백해서 "글이 사라짐" 문제를 막는다.
    db.posts.unshift(post);
    db.profile.karma += 1;
    db.profile.contrib += 1;

    db.inbox.unshift({
      id: uid("n"),
      icon: "📝",
      title: "게시물이 등록되었습니다",
      body: `r/${comm.name}에 글이 올라갔어요`,
      time: "지금",
      target: {type:"post", postId: post.id},
      unread: true
    });
    try{
      saveDB(db);
    }catch(err){
      db.posts.shift();
      db.profile.karma = Math.max(0, db.profile.karma - 1);
      db.profile.contrib = Math.max(0, db.profile.contrib - 1);
      db.inbox.shift();
      toast("게시 저장 실패: 첨부 용량을 줄여 다시 시도해 주세요");
      return;
    }

    $("#composeTitle").value = "";
    $("#composeBody").value = "";
    composeMedia = [];
    renderComposeMediaPreview();
    closeCommDropdown();

    renderAll();
    go("home");
    toast("게시 완료");
  }

  function postFeedHandler(e){
    if(e.target.closest("video")) return;

    const card = e.target.closest(".postCard");
    if(!card) return;

    const postId = card.dataset.postId;
    const p = db.posts.find(x => x.id === postId);
    if(!p) return;

    const actEl = e.target.closest("[data-act]");
    const act = actEl ? actEl.dataset.act : null;

    if(act === "voteGood"){ vote(postId, "good"); return; }
    if(act === "voteBad"){ vote(postId, "bad"); return; }
    if(act === "openComments"){ openComments(postId); return; }
    if(act === "openCommunity"){ openCommunity(p.communityId); return; }
    if(act === "sharePost"){ copyText(makeLink({type:"post", postId})); return; }
    if(act === "postMenu"){
      openPostMenu(postId, e.target.closest(".moreBtn"));
      return;
    }
    openComments(postId);
  }

  function postCardHTML(p){
    const meVote = getMyVote(p);
    const commLabel = "r/" + (p.communityName || "unknown");
    const bodySnippet = (p.body || "").trim();
    const showBody = bodySnippet ? bodySnippet.slice(0, 120) : "";

    const canInteract = db.auth.loggedIn && isJoined(p.communityId);
    const voteDisabled = !canInteract;
    const commentDisabled = !canInteract;

    return `
      <article class="postCard" data-post-id="${esc(p.id)}">
        <div class="postHead">
          <div class="miniAvatar"></div>
          <div class="metaLine">
            <b>${esc(commLabel)}</b>
            <span>•</span>
            <span>${esc(p.author || "익명")}</span>
            <span>•</span>
            <span>${esc(p.time || "")}</span>
          </div>
          <div class="moreBtn" title="더보기" data-act="postMenu">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
              <path d="M6 12h.01M12 12h.01M18 12h.01" stroke="currentColor" stroke-width="3" stroke-linecap="round"/>
            </svg>
          </div>
        </div>

        <div class="postTitle" data-act="openPost">${esc(p.title)}</div>
        ${showBody ? `<div class="postBodySmall">${esc(showBody)}${bodySnippet.length>120 ? "…" : ""}</div>` : ""}

        ${mediaHTML(p)}

        <div class="postActions">
          <div class="voteBox">
            <button class="voteBtn good ${meVote==='good'?'active':''} ${voteDisabled?'disabled':''}" data-act="voteGood" title="굿">
              <span>↑</span><span class="voteCount">${esc(String(p.good || 0))}</span>
            </button>
            <button class="voteBtn bad ${meVote==='bad'?'active':''} ${voteDisabled?'disabled':''}" data-act="voteBad" title="배드">
              <span>↓</span><span class="voteCount">${esc(String(p.bad || 0))}</span>
            </button>
          </div>

          <div class="pillBtn muted ${commentDisabled?'disabled':''}" data-act="openComments">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none">
              <path d="M21 15a4 4 0 0 1-4 4H8l-5 3V7a4 4 0 0 1 4-4h10a4 4 0 0 1 4 4v8Z" stroke="currentColor" stroke-width="2" stroke-linejoin="round"/>
            </svg>
            ${esc(String(p.commentsCount || 0))}
          </div>

          <div class="pillBtn muted" data-act="sharePost">공유</div>
          <div class="pillBtn muted" data-act="openCommunity" style="margin-left:auto;">커뮤니티</div>
        </div>
      </article>
    `;
  }

  function mediaHTML(p){
    const m = p.media;
    if(!m) return `<div class="mediaFrame" data-act="openPost"><div class="mediaLabel">미디어 없음</div></div>`;
    
    // 배열이면 여러 미디어, 아니면 단일 미디어
    const mediaList = (Array.isArray(m) ? m : [m]).filter(item => item && item.type && item.src);
    
    if(mediaList.length === 0) return `<div class="mediaFrame" data-act="openPost"><div class="mediaLabel">미디어 없음</div></div>`;
    
    // 미디어는 가로 스와이프 가능하도록 표시 (각 미디어 비율 유지)
    const mediaItems = mediaList.map((item, idx) => {
      if(item.type === "image"){
        return `<div class="mediaSlide">
          <img src="${esc(item.src)}" alt="image ${idx}" style="width: 100%; height: auto; display: block; object-fit: contain;"/>
        </div>`;
      }
      if(item.type === "video"){
        const mutedAttr = (db.settings.muteVideos !== false) ? "muted" : "";
        return `<div class="mediaSlide" style="background:#000;">
          <video controls autoplay ${mutedAttr} playsinline preload="metadata" poster="${esc(item.poster||"")}" style="width: 100%; display:block; aspect-ratio:16/9;">
            <source src="${esc(item.src)}" type="video/mp4"/>
          </video>
        </div>`;
      }
      return "";
    }).join("");
    
    return `<div class="mediaFrame" style="position: relative; overflow: hidden; padding: 8px;">
      <div class="mediaCarousel">
        ${mediaItems}
      </div>
      <div class="mediaLabel">${mediaList.length > 1 ? `미디어 (${mediaList.length}개)` : (mediaList[0].type === "image" ? "이미지" : "동영상")}</div>
    </div>`;
  }

  function vote(postId, kind){
    const p = db.posts.find(x => x.id === postId);
    if(!p) return;
    if(!db.auth.loggedIn){ openAuthGate("투표"); return; }
    if(!isJoined(p.communityId)){ toast("참여 후 투표 가능"); return; }

    const client = db.me.clientId;
    const prev = (p.votesByClient && p.votesByClient[client]) || null;

    if(prev === "good") p.good = Math.max(0, (p.good||0)-1);
    if(prev === "bad") p.bad = Math.max(0, (p.bad||0)-1);

    let next = kind;
    if(prev === kind) next = null;

    if(!p.votesByClient) p.votesByClient = {};
    if(next){
      p.votesByClient[client] = next;
      if(next === "good") p.good = (p.good||0)+1;
      if(next === "bad") p.bad = (p.bad||0)+1;
      db.profile.karma += 1;
    }else{
      delete p.votesByClient[client];
    }

    saveDB(db);
    const stage = $("#stage");
    const prevTop = stage ? stage.scrollTop : 0;
    if(state.activeRoute === "home") renderHomeFeed();
    else if(state.activeRoute === "commDetail" && state.activeCommunityId) renderCommDetail(state.activeCommunityId);
    else if(state.activeRoute === "profile") renderProfile();
    else renderAll();
    if(stage) stage.scrollTop = prevTop;
  }

  function getMyVote(p){
    const client = db.me.clientId;
    return (p.votesByClient && p.votesByClient[client]) || null;
  }

  function openComments(postId){
    state.activePostId = postId;
    renderComments(postId);
    go("comments");
    setTimeout(()=> $("#commentInput").focus({preventScroll:true}), 120);
  }

  function renderComments(postId){
    const p = db.posts.find(x => x.id === postId);
    if(!p) return;

    $("#commentsPost").innerHTML = postCardHTML(p);

    const list = db.comments.filter(c => c.postId === postId);
    const host = $("#commentsList");

    host.innerHTML = list.length
      ? list.map(c => `
          <div style="padding:12px 14px; border-top:1px solid var(--line);">
            <div class="muted2" style="font-size:12px;display:flex;gap:8px;align-items:center;justify-content:space-between;">
              <div style="display:flex;gap:8px;align-items:center;min-width:0;">
                <span style="font-weight:var(--w-semibold);">${esc(c.author)}</span><span>•</span><span>${esc(c.time)}</span>
              </div>
              <div class="moreBtn" data-comment-menu="${esc(c.id)}" title="댓글 더보기" style="width:30px;height:30px;flex:0 0 auto;">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none">
                  <path d="M6 12h.01M12 12h.01M18 12h.01" stroke="currentColor" stroke-width="3" stroke-linecap="round"/>
                </svg>
              </div>
            </div>
            <div style="margin-top:6px; font-weight:var(--w-regular); line-height:1.55; white-space:pre-wrap; word-break:break-word;">
              ${esc(c.text)}
            </div>
          </div>
        `).join("")
      : `<div style="padding:14px;"><div class="muted" style="font-weight:var(--w-semibold);">아직 댓글이 없어요. 첫 댓글을 남겨보세요.</div></div>`;

    // lock hint
    const can = db.auth.loggedIn && isJoined(p.communityId);
    $("#commentSendBtn").classList.toggle("disabled", !can);
    $("#commentInput").disabled = !can;
    $("#commentHintText").textContent = !db.auth.loggedIn
      ? "로그인 후 댓글 작성 가능"
      : (!isJoined(p.communityId) ? "참여 후 댓글 작성 가능" : "");
  }

  function sendComment(){
    const postId = state.activePostId;
    const p = db.posts.find(x => x.id === postId);
    if(!p) return;

    if(!db.auth.loggedIn){ openAuthGate("댓글"); return; }
    if(!isJoined(p.communityId)){ toast("참여 후 댓글 작성 가능"); return; }

    const text = $("#commentInput").value.trim();
    if(!text) return;

    const issues = detectCommentIssues(text);
    if(issues.length && !isAdminUser()){
      const pending = {
        id: uid("mod"),
        postId,
        author: db.me.anon,
        text: text.slice(0, 500),
        reasons: issues,
        status: "pending",
        createdAt: Date.now()
      };
      if(!Array.isArray(db.commentModerations)) db.commentModerations = [];
      db.commentModerations.unshift(pending);
      notifyAdminForCommentModeration(pending, p);
      $("#commentInput").value = "";
      saveDB(db);
      renderCommentModerationList();
      renderInbox(getActiveInboxTab());
      syncInboxBadge();
      toast("댓글이 검수 대기로 접수되었습니다");
      return;
    }

    db.comments.push({
      id: uid("cm"),
      postId,
      author: db.me.anon,
      time: "방금",
      text,
      createdAt: Date.now()
    });

    p.commentsCount = (p.commentsCount||0) + 1;
    db.profile.contrib += 1;

    db.inbox.unshift({
      id: uid("n"),
      icon: "💬",
      title: "댓글이 등록되었습니다",
      body: `게시물: ${p.title.slice(0,24)}${p.title.length>24?"…":""}`,
      time: "지금",
      target: {type:"post", postId},
      unread: true
    });

    $("#commentInput").value = "";
    saveDB(db);
    renderInbox(getActiveInboxTab());
    syncInboxBadge();
    renderComments(postId);
    renderProfile();
  }

  function switchIbTab(tab){
    db.ui.ibTab = tab === "apps" ? "apps" : "news";
    saveDB(db);
    $$("#ibMainTabs .segTab").forEach(x => x.classList.toggle("active", x.dataset.ibTab === db.ui.ibTab));
    $("#ibNewsPanel").style.display = db.ui.ibTab === "news" ? "block" : "none";
    $("#ibAppsPanel").style.display = db.ui.ibTab === "apps" ? "block" : "none";
    if(db.ui.ibTab === "news") renderIbNewsList();
    if(db.ui.ibTab === "apps") renderIbAppList();
  }

  function renderIbHub(){
    if(!db.ui.ibTab) db.ui.ibTab = "news";
    switchIbTab(db.ui.ibTab);
    renderIbNewsList();
    renderIbAppList();
    const admin = isAdminUser();
    const adminWriteBtn = $("#ibNewsWriteBtn");
    if(adminWriteBtn) adminWriteBtn.style.display = admin ? "inline-flex" : "none";
    const adminBtn = $("#ibNewsAdminBtn");
    if(adminBtn) adminBtn.textContent = admin ? "인증됨 (2026)" : "뉴스 관리자 인증";
    if(!admin) toggleIbNewsEditor(false);
  }

  function toggleIbNewsEditor(open){
    const editor = $("#ibNewsEditor");
    if(!editor) return;
    if(open && !isAdminUser()){
      toast("관리 코드 2026 인증이 필요합니다");
      return;
    }
    editor.style.display = open ? "block" : "none";
    if(open) $("#ibNewsTitle")?.focus();
  }

  function onIbNewsMediaSelected(e){
    const file = e.target.files && e.target.files[0];
    const hint = $("#ibNewsAttachHint");
    if(!file){
      if(hint) hint.textContent = "첨부 없음";
      return;
    }
    if(file.size > 6 * 1024 * 1024){
      toast("뉴스 미디어는 6MB 이하만 가능합니다");
      e.target.value = "";
      if(hint) hint.textContent = "첨부 없음";
      return;
    }
    const reader = new FileReader();
    reader.onload = (evt) => {
      db.ui.ibNewsDraftMedia = {
        type: file.type.startsWith("video/") ? "video" : "image",
        src: String(evt.target.result || ""),
      };
      if(hint) hint.textContent = `첨부됨: ${file.name}`;
    };
    reader.readAsDataURL(file);
  }

  function submitIbNews(){
    if(!isAdminUser()){ toast("관리 코드 2026 인증이 필요합니다"); return; }
    const title = ($("#ibNewsTitle")?.value || "").trim();
    const body = ($("#ibNewsBody")?.value || "").trim();
    if(!title || !body){ toast("제목과 본문을 입력해 주세요"); return; }
    const media = db.ui.ibNewsDraftMedia && db.ui.ibNewsDraftMedia.src ? db.ui.ibNewsDraftMedia : null;
    db.ibNews.unshift({
      id: uid("ibn"),
      title: title.slice(0, 120),
      body: body.slice(0, 2000),
      author: "IB뉴스 관리자",
      createdAt: Date.now(),
      time: "방금",
      media
    });
    $("#ibNewsTitle").value = "";
    $("#ibNewsBody").value = "";
    $("#ibNewsMediaInput").value = "";
    db.ui.ibNewsDraftMedia = null;
    const hint = $("#ibNewsAttachHint");
    if(hint) hint.textContent = "첨부 없음";
    toggleIbNewsEditor(false);
    saveDB(db);
    renderIbNewsList();
    toast("IB뉴스가 게시되었습니다");
  }

  function renderIbNewsList(){
    const host = $("#ibNewsList");
    if(!host) return;
    const q = ($("#ibNewsSearch")?.value || "").trim().toLowerCase();
    let list = Array.isArray(db.ibNews) ? db.ibNews.slice() : [];
    if(q){
      list = list.filter(n =>
        (n.title || "").toLowerCase().includes(q) ||
        (n.body || "").toLowerCase().includes(q)
      );
    }
    if(!list.length){
      host.innerHTML = `<div class="muted2" style="font-size:13px;">조건에 맞는 IB 뉴스가 없습니다.</div>`;
      return;
    }
    host.innerHTML = list.map(n => `
      <article class="postCard" style="margin:10px 0;">
        <div class="postHead" style="padding-bottom:6px;">
          <div class="miniAvatar"></div>
          <div class="metaLine">
            <b>IB뉴스</b><span>•</span><span>${esc(n.author || "관리자")}</span><span>•</span><span>${esc(n.time || "방금")}</span>
          </div>
        </div>
        <div class="postTitle">${esc(n.title)}</div>
        <div class="postBodySmall" style="white-space:pre-wrap;">${esc(n.body)}</div>
        ${n.media ? mediaHTML({media: n.media}) : ""}
      </article>
    `).join("");
  }

  function renderIbAppList(){
    const host = $("#ibAppList");
    if(!host) return;
    const q = ($("#ibAppSearch")?.value || "").trim().toLowerCase();
    const cat = ($("#ibAppCategory")?.value || "all").toLowerCase();
    const apps = Array.isArray(db.ibApps) ? db.ibApps : [];
    const list = apps.filter(a => {
      const okCat = cat === "all" || (a.category || "").toLowerCase() === cat;
      if(!okCat) return false;
      if(!q) return true;
      return [a.name, a.categoryLabel, a.desc, ...(a.features || [])].join(" ").toLowerCase().includes(q);
    });
    if(!list.length){
      host.innerHTML = `<div class="muted2" style="font-size:13px;">조건에 맞는 앱이 없습니다.</div>`;
      return;
    }
    host.innerHTML = list.map((a, idx) => `
      <div class="ibAppCard animate-in" style="--enter-delay:${Math.min(idx * 30, 220)}ms;">
        <div class="ibAppTop">
          <img class="ibAppThumb" src="${esc(a.image || "")}" alt="${esc(a.name)} 앱 이미지" loading="lazy"
               onerror="this.style.display='none';this.nextElementSibling.style.marginLeft='0';" />
          <div style="min-width:0; flex:1;">
            <div style="display:flex;justify-content:space-between;gap:10px;align-items:center;">
              <b style="font-size:16px;">${esc(a.name)}</b>
              <span class="pillBtn muted" style="cursor:default;">${esc(a.categoryLabel)}</span>
            </div>
            <div class="muted2" style="line-height:1.55;margin-top:4px;">${esc(a.desc)}</div>
          </div>
        </div>
        <div class="ibAppFeatures">
          ${(a.features || []).map(f => `<span class="ibFeatureChip">${esc(f)}</span>`).join("")}
        </div>
        <div class="ibAppActions">
          <a class="btn blue" href="${esc(a.link)}" target="_blank" rel="noopener">앱 바로가기</a>
          ${a.video ? `<a class="btn" href="${esc(a.video)}" target="_blank" rel="noopener">사용 영상</a>` : ""}
        </div>
      </div>
    `).join("");
    applyEntranceAnimations();
  }

  function resetMiniGame(){
    if(miniGameTimer){
      clearTimeout(miniGameTimer);
      miniGameTimer = null;
    }
    miniGameArmed = false;
    const field = $("#miniGameField");
    field.style.background = "rgba(255,255,255,.02)";
    field.textContent = "대기 중";
    $("#miniGameResult").textContent = `최고 기록: ${db.ui.miniBestMs ? db.ui.miniBestMs + "ms" : "-"}`;
  }

  function startMiniGame(){
    resetMiniGame();
    const field = $("#miniGameField");
    field.style.background = "rgba(239,68,68,.28)";
    field.textContent = "기다리세요...";
    const delay = 1200 + Math.floor(Math.random() * 1800);
    miniGameTimer = setTimeout(() => {
      miniGameArmed = true;
      miniGameStart = performance.now();
      field.style.background = "rgba(34,197,94,.35)";
      field.textContent = "지금 누르세요!";
      miniGameTimer = null;
    }, delay);
  }

  function onMiniFieldClick(){
    const field = $("#miniGameField");
    if(miniGameTimer){
      clearTimeout(miniGameTimer);
      miniGameTimer = null;
      field.style.background = "rgba(245,158,11,.28)";
      field.textContent = "너무 빨라요!";
      $("#miniGameResult").textContent = "실패: 신호 전에 눌렀어요.";
      return;
    }
    if(!miniGameArmed) return;
    const ms = Math.round(performance.now() - miniGameStart);
    miniGameArmed = false;
    field.style.background = "rgba(59,130,246,.28)";
    field.textContent = `${ms}ms`;
    if(!db.ui.miniBestMs || ms < db.ui.miniBestMs){
      db.ui.miniBestMs = ms;
      saveDB(db);
    }
    $("#miniGameResult").textContent = `최고 기록: ${db.ui.miniBestMs}ms`;
  }

  function onPullStart(e){
    if(state.activeRoute !== "home") return;
    if($("#stage").scrollTop > 0) return;
    pullState.touching = true;
    pullState.startY = e.touches[0].clientY;
    pullState.offset = 0;
  }

  function onPullMove(e){
    if(!pullState.touching || pullState.refreshing || state.activeRoute !== "home") return;
    const dy = e.touches[0].clientY - pullState.startY;
    if(dy <= 0) return;
    if($("#stage").scrollTop > 0) return;
    const sticky = Math.min(112, Math.pow(dy, 0.78));
    pullState.offset = sticky;
    const bubble = $("#pullBubble");
    bubble.classList.add("open");
    bubble.style.transform = `translateY(${sticky * 0.55}px) scale(1)`;
    const ready = sticky > 78;
    bubble.classList.toggle("ready", ready);
    $("#pullText").textContent = ready ? "놓으면 새로고침" : "당겨서 새로고침";
    if(sticky > 6) e.preventDefault();
  }

  function onPullEnd(){
    if(!pullState.touching) return;
    pullState.touching = false;
    const bubble = $("#pullBubble");
    const shouldRefresh = pullState.offset > 78;
    if(shouldRefresh){
      pullState.refreshing = true;
      $("#pullText").textContent = "새로고침 중...";
      bubble.classList.add("open");
      bubble.classList.remove("ready");
      bubble.style.transform = "translateY(34px) scale(1)";
      setTimeout(() => {
        renderAll();
        bubble.classList.remove("open");
        bubble.style.transform = "";
        pullState.refreshing = false;
        toast("새로고침 완료");
      }, 900);
    }else{
      bubble.classList.remove("open");
      bubble.classList.remove("ready");
      bubble.style.transform = "";
    }
    pullState.offset = 0;
  }

  // =========================
  // Inbox
  // =========================
  function getActiveInboxTab(){
    return ($("#inboxTabs .segTab.active")?.dataset.tab) || "noti";
  }

  function renderInbox(tab="noti"){
    const host = $("#inboxList");

    if(tab === "chat"){
      host.innerHTML = db.auth.loggedIn
        ? `<div class="noticeCard" style="cursor:default;">
            <div class="noticeIcon">💬</div>
            <div class="noticeText">
              <b>채팅이 아직 없어요</b>
              <div class="body">표고모에서 대화를 시작해보세요.</div>
              <small>지금</small>
            </div>
          </div>`
        : `<div class="noticeCard" style="cursor:default;">
            <div class="noticeIcon">🔒</div>
            <div class="noticeText">
              <b>채팅은 로그인 후 사용 가능</b>
              <div class="body">로그인하면 채팅 탭이 열립니다.</div>
              <small>지금</small>
            </div>
          </div>`;
      syncInboxBadge();
      return;
    }

    host.innerHTML = db.inbox.length ? db.inbox.map(n => `
      <div class="noticeCard" data-noti-id="${esc(n.id)}">
        <div class="noticeIcon">${esc(n.icon)}</div>
        <div class="noticeText">
          <b>${esc(n.title)}</b>
          <div class="body">${esc(n.body)}</div>
          <small>${esc(n.time)}${n.unread ? " • 새 알림" : ""}</small>
        </div>
      </div>
    `).join("") : `<div class="noticeCard" style="cursor:default;"><div class="noticeIcon">✅</div><div class="noticeText"><b>새 알림이 없습니다</b><div class="body">새 소식이 생기면 여기에 표시됩니다.</div><small>지금</small></div></div>`;

    host.querySelectorAll(".noticeCard").forEach(card => {
      card.addEventListener("click", () => {
        const id = card.dataset.notiId;
        const idx = db.inbox.findIndex(x => x.id === id);
        const n = idx >= 0 ? db.inbox[idx] : null;
        if(!n) return;
        // 읽은 알림은 리스트에서 바로 제거
        db.inbox.splice(idx, 1);
        saveDB(db);
        syncInboxBadge();

        if(n.target?.type === "post" && n.target.postId) openComments(n.target.postId);
        else if(n.target?.type === "community" && n.target.communityId) openCommunity(n.target.communityId);
        else if(n.target?.type === "comm") go("comm");
        else if(n.target?.type === "suggest") go("suggest");
        else if(n.target?.type === "commentModeration") go("suggest");
        else if(n.target?.type === "promo") go("promo");
        else go("home");

        renderInbox(getActiveInboxTab());
      });
    });

    syncInboxBadge();
  }

  function syncInboxBadge(){
    const unread = db.inbox.filter(n => n.unread).length;
    const badge = $("#inboxBadge");
    badge.style.display = unread ? "inline-block" : "none";
    badge.textContent = unread ? String(Math.min(99, unread)) : "";
    $("#inboxDot").style.display = unread ? "inline-block" : "none";
  }

  // =========================
  // Helpers / DB
  // =========================
  function isJoined(commId){
    const c = db.communities.find(x => x.id === commId);
    return !!c?.joined;
  }
  function hasAnyJoined(){
    return db.communities.some(c => c.joined);
  }

  function normalizeTextForFilter(s){
    return String(s || "")
      .toLowerCase()
      .replace(/\s+/g, "")
      .replace(/[^0-9a-z가-힣]/g, "");
  }

  function detectCommentIssues(text){
    const norm = normalizeTextForFilter(text);
    const rules = [
      { reason: "욕설/비방", words: ["시발","ㅅㅂ","병신","꺼져","죽어","새끼","존나","개새끼","미친놈","등신","바보야"] },
      { reason: "험담/따돌림", words: ["왕따","따돌림","뒷담","험담","소문","카더라","찐따","쟤별로","쟤싫어"] },
      { reason: "연애/학생 방해", words: ["사귄다","연애","전남친","전여친","썸탄다","고백","커플","헤어졌","불륜"] },
    ];
    const hits = [];
    rules.forEach((rule) => {
      if(rule.words.some((w) => norm.includes(normalizeTextForFilter(w)))){
        hits.push(rule.reason);
      }
    });
    return Array.from(new Set(hits));
  }

  function hashString(text){
    let h = 0;
    const t = String(text || "");
    for(let i = 0; i < t.length; i += 1){
      h = ((h << 5) - h) + t.charCodeAt(i);
      h |= 0;
    }
    return Math.abs(h);
  }

  function buildAnonNicknamePool(){
    const traits = [
      "차분한","용감한","재빠른","성실한","든든한","영리한","부지런한","단단한","사려깊은","유쾌한",
      "정직한","반짝이는","따뜻한","침착한","꼼꼼한","당당한","기특한","성장중인","배려하는","끈기있는"
    ];
    const animals = [
      "돼지","펭귄","고래","여우","사자","호랑이","곰","강아지","고양이","수달",
      "독수리","참새","부엉이","거북이","다람쥐","토끼","판다","카피바라","해달","돌고래"
    ];
    const out = [];
    traits.forEach((trait) => {
      animals.forEach((animal) => {
        out.push(`익명의 ${trait} ${animal}`);
      });
    });
    return out.slice(0, 400);
  }

  function pickAnonNickname(key){
    if(!db.nicknameRegistry || typeof db.nicknameRegistry !== "object"){
      db.nicknameRegistry = {};
    }
    if(db.nicknameRegistry[key]) return db.nicknameRegistry[key];

    const used = new Set(Object.values(db.nicknameRegistry));
    const start = hashString(key) % ANON_NICKNAME_POOL.length;
    for(let i = 0; i < ANON_NICKNAME_POOL.length; i += 1){
      const cand = ANON_NICKNAME_POOL[(start + i) % ANON_NICKNAME_POOL.length];
      if(!used.has(cand)){
        db.nicknameRegistry[key] = cand;
        return cand;
      }
    }
    const fallback = `${ANON_NICKNAME_POOL[start]}-${used.size + 1}`;
    db.nicknameRegistry[key] = fallback;
    return fallback;
  }

  function normalizeAnonIdentity(store){
    let changed = false;
    if(!store.nicknameRegistry || typeof store.nicknameRegistry !== "object"){
      store.nicknameRegistry = {};
      changed = true;
    }
    if(!store.me || typeof store.me !== "object"){
      store.me = {};
      changed = true;
    }
    if(!store.me.clientId){
      store.me.clientId = uid("client");
      changed = true;
    }
    const key = (store.auth?.loggedIn && store.auth?.user?.email)
      ? `email:${String(store.auth.user.email).toLowerCase()}`
      : `client:${store.me.clientId}`;
    const anon = pickAnonNickname(key);
    if(store.me.anon !== anon){
      store.me.anon = anon;
      changed = true;
    }
    return changed;
  }

  function refreshCurrentAnonNickname(){
    const key = (db.auth.loggedIn && db.auth.user?.email)
      ? `email:${String(db.auth.user.email).toLowerCase()}`
      : `client:${db.me.clientId}`;
    db.me.anon = pickAnonNickname(key);
  }

  function sanitizeCommName(s){
    let x = s.trim();
    x = x.replace(/^r\//i, "");
    x = x.replace(/\s+/g, "-");
    x = x.replace(/[^0-9a-zA-Z가-힣_-]/g, "");
    x = x.replace(/-+/g, "-");
    x = x.replace(/^[-_]+|[-_]+$/g, "");
    if(x.length < 2) return "";
    if(x.length > 24) x = x.slice(0,24);
    return x;
  }

  function uid(prefix="id"){
    return prefix + "_" + Math.random().toString(36).slice(2,9) + "_" + Date.now().toString(36);
  }
  function esc(s){
    return String(s)
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }

  // toast
  let toastTimer = null;
  function toast(msg){
    const t = $("#toast");
    $("#toastText").textContent = msg;
    t.classList.add("show");
    clearTimeout(toastTimer);
    toastTimer = setTimeout(()=> t.classList.remove("show"), 1500);
  }

  // link deep-link
  function makeLink(target){
    const base = location.href.split("#")[0];
    const t = target || getCurrentLinkTarget();
    return base + "#" + encodeURIComponent(JSON.stringify(t));
  }
  function getCurrentLinkTarget(){
    if(state.activeRoute === "comments" && state.activePostId) return {type:"post", postId: state.activePostId};
    if(state.activeRoute === "commDetail" && state.activeCommunityId) return {type:"community", communityId: state.activeCommunityId};
    if(state.activeRoute === "profile") return {type:"profile"};
    if(state.activeRoute === "suggest") return {type:"suggest"};
    if(state.activeRoute === "promo") return {type:"promo"};
    return {type:"home"};
  }
  function applyHashRouteIfAny(){
    try{
      const h = location.hash.slice(1);
      if(!h) return;
      const obj = JSON.parse(decodeURIComponent(h));
      if(obj.type === "post" && obj.postId){
        openComments(obj.postId);
      }else if(obj.type === "community" && obj.communityId){
        openCommunity(obj.communityId);
      }else if(obj.type === "profile"){
        if(!db.auth.loggedIn){ openAuthGate("회원님"); return; }
        go("profile");
      }else if(obj.type === "suggest"){
        go("suggest");
      }else if(obj.type === "promo"){
        go("promo");
      }else{
        go("home");
      }
    }catch(e){}
  }

  async function copyText(text){
    try{
      await navigator.clipboard.writeText(text);
      toast("링크 복사됨");
    }catch(e){
      const ta = document.createElement("textarea");
      ta.value = text;
      document.body.appendChild(ta);
      ta.select();
      document.execCommand("copy");
      ta.remove();
      toast("링크 복사됨");
    }
  }

  function initLogoFallback(){
    const logoPath = "assets/logo.svg";
    const logoEls = [$("#brandLogoImg"), $("#drawerLogoImg")].filter(Boolean);
    logoEls.forEach(img => {
      img.src = logoPath;
      img.onerror = null;
    });
  }

  function defaultLogoDataUri(){
    const svg = encodeURIComponent(`
      <svg xmlns="http://www.w3.org/2000/svg" width="736" height="615" viewBox="0 0 736 615">
        <rect width="736" height="615" fill="#ebebeb"/>
        <g fill="none" stroke="#ff8a00" stroke-width="34" stroke-linecap="round" stroke-linejoin="round">
          <path d="M113 131h137v137H113z"/>
          <path d="M318 131h120v120"/>
          <path d="M512 131h120v120H512z"/>
          <path d="M300 260h147"/>
          <path d="M525 260h124"/>
          <path d="M113 260h137"/>
          <path d="M182 340c50 62 143 95 236 95s186-33 236-95"/>
        </g>
        <g fill="#67c700">
          <path d="M367 215c0-34 24-58 55-60-4 37-16 58-55 61z"/>
          <path d="M367 215c0-34-24-58-55-60 4 37 16 58 55 61z"/>
        </g>
        <rect x="360" y="215" width="14" height="32" fill="#35b800"/>
        <g fill="#ff8a00" font-family="Arial, sans-serif" font-size="82" font-weight="700">
          <text x="108" y="528">표선고의 모든것</text>
        </g>
      </svg>
    `);
    return "data:image/svg+xml;charset=utf-8," + svg;
  }

  function demoMediaForNewPost(){
    // 데모: 50% 확률 이미지
    if(Math.random() < 0.5){
      return { type:"image", src: demoImageDataUri() };
    }
    return null;
  }

  function demoImageDataUri(){
    const svg = encodeURIComponent(`
      <svg xmlns="http://www.w3.org/2000/svg" width="1200" height="700">
        <defs>
          <linearGradient id="g" x1="0" y1="0" x2="1" y2="1">
            <stop offset="0" stop-color="rgba(59,130,246,0.35)"/>
            <stop offset="0.55" stop-color="rgba(255,69,0,0.22)"/>
            <stop offset="1" stop-color="rgba(0,0,0,0)"/>
          </linearGradient>
        </defs>
        <rect width="1200" height="700" rx="36" fill="rgba(255,255,255,0.06)"/>
        <rect x="36" y="36" width="1128" height="110" rx="26" fill="rgba(0,0,0,0.30)"/>
        <rect x="66" y="66" width="260" height="52" rx="26" fill="rgba(255,69,0,0.20)"/>
        <rect x="36" y="170" width="1128" height="494" rx="30" fill="url(#g)"/>
        <circle cx="104" cy="96" r="18" fill="rgba(255,255,255,0.82)"/>
        <rect x="140" y="82" width="220" height="28" rx="14" fill="rgba(255,255,255,0.50)"/>
        <rect x="80" y="220" width="520" height="42" rx="18" fill="rgba(255,255,255,0.46)"/>
        <rect x="80" y="280" width="760" height="28" rx="14" fill="rgba(255,255,255,0.34)"/>
        <rect x="80" y="330" width="680" height="28" rx="14" fill="rgba(255,255,255,0.28)"/>
      </svg>
    `);
    return "data:image/svg+xml;charset=utf-8," + svg;
  }

  function loadDB(){
    const raw = localStorage.getItem(LS_KEY);
    if(raw){
      try{
        const obj = JSON.parse(raw);
        return normalizeDB(obj);
      }catch(e){}
    }
    const fresh = seedDB();
    localStorage.setItem(LS_KEY, JSON.stringify(fresh));
    return fresh;
  }

  function saveDB(next){
    localStorage.setItem(LS_KEY, JSON.stringify(next));
  }

  function normalizeDB(x){
    const base = seedDB();
    // 얕은 머지
    const out = {...base, ...x};
    out.settings = {...base.settings, ...(x.settings||{})};
    out.me = {...base.me, ...(x.me||{})};
    out.auth = {...base.auth, ...(x.auth||{})};
    out.profile = {...base.profile, ...(x.profile||{})};
    out.ui = {...base.ui, ...(x.ui||{})};
    out.communities = Array.isArray(x.communities) ? x.communities : base.communities;
    out.commRequests = Array.isArray(x.commRequests) ? x.commRequests : base.commRequests;
    out.suggestions = Array.isArray(x.suggestions) ? x.suggestions : base.suggestions;
    out.ibNews = Array.isArray(x.ibNews) ? x.ibNews : base.ibNews;
    out.ibApps = Array.isArray(x.ibApps) ? x.ibApps : base.ibApps;
    out.posts = Array.isArray(x.posts) ? x.posts : base.posts;
    out.comments = Array.isArray(x.comments) ? x.comments : base.comments;
    out.commentModerations = Array.isArray(x.commentModerations) ? x.commentModerations : base.commentModerations;
    out.nicknameRegistry = (x.nicknameRegistry && typeof x.nicknameRegistry === "object") ? x.nicknameRegistry : base.nicknameRegistry;
    out.inbox = Array.isArray(x.inbox) ? x.inbox : base.inbox;
    out.inbox = out.inbox.map(n => ({...n, unread: !!n.unread}));
    if(out.inbox.length === 1 && out.inbox[0].title === "환영합니다"){
      out.inbox[0].unread = false;
    }
    return out;
  }

  function enrichExistingPosts(store){
    if(!store || !Array.isArray(store.posts) || !Array.isArray(store.communities)) return false;
    let changed = false;

    const imgPool = [
      "https://picsum.photos/seed/pyogomo-a/1200/700",
      "https://picsum.photos/seed/pyogomo-b/1200/700",
      "https://picsum.photos/seed/pyogomo-c/1200/700"
    ];
    let imgIdx = 0;

    store.posts.forEach(p => {
      if(!p.media){
        p.media = { type:"image", src: imgPool[imgIdx % imgPool.length] };
        imgIdx += 1;
        changed = true;
      }
    });

    const hasVideo = store.posts.some(p => {
      const m = p.media;
      if(!m) return false;
      if(Array.isArray(m)) return m.some(x => x && x.type === "video");
      return m.type === "video";
    });

    if(!hasVideo){
      const comm = store.communities.find(c => c.joined) || store.communities[0];
      if(comm){
        store.posts.unshift({
          id: uid("p"),
          communityId: comm.id,
          communityName: comm.name,
          author: "익명의 차분한 수달",
          time: "방금",
          title: "영상 테스트 게시물",
          body: "요청하신 동영상 샘플 게시물입니다.",
          media: { type:"video", src: "https://interactive-examples.mdn.mozilla.net/media/cc0-videos/flower.mp4", poster: "" },
          good: 0,
          bad: 0,
          commentsCount: 0,
          createdAt: Date.now(),
          votesByClient: {}
        });
        changed = true;
      }
    }

    return changed;
  }

  function seedDB(){
    const now = Date.now();
    const clientId = "client_" + Math.random().toString(36).slice(2,10);

    const communities = [
      { id: uid("c"), name:"ib", desc:"IB 과제/IA/EE/TOK 팁", members: 128, joined: true, createdBy: "" },
      { id: uid("c"), name:"pyoseon", desc:"표선고 이야기/공지/소통", members: 402, joined: true, createdBy: "" },
      { id: uid("c"), name:"physics", desc:"물리/공학/연구 토론", members: 251, joined: false, createdBy: "" },
      { id: uid("c"), name:"movies", desc:"영화/드라마 추천", members: 198, joined: false, createdBy: "" }
    ];

    const posts = [
      {
        id: uid("p"),
        communityId: communities[0].id,
        communityName: communities[0].name,
        author: "익명의 든든한 펭귄",
        time: "1시간 전",
        title: "TOK AOK 정리 루틴 공유",
        body: "AOK별로 '주장-근거-한계-반례'를 카드로 쪼개면 발표/에세이가 빨라짐.",
        media: { type:"image", src: demoImageDataUri() },
        good: 5,
        bad: 0,
        commentsCount: 1,
        createdAt: now - 3600*1000,
        votesByClient: {}
      },
      {
        id: uid("p"),
        communityId: communities[1].id,
        communityName: communities[1].name,
        author: "익명의 단단한 토끼",
        time: "방금",
        title: "점심 쿠폰 QR 운영 팁",
        body: "동선이 꼬이면 줄이 길어져서, 반별로 2분씩 슬랏 잡는 게 체감이 좋았음.",
        media: { type:"image", src: demoImageDataUri() },
        good: 2,
        bad: 0,
        commentsCount: 0,
        createdAt: now - 1000*60*4,
        votesByClient: {}
      }
    ];

    const comments = [
      { id: uid("cm"), postId: posts[0].id, author:"익명의 성실한 고래", time:"30분 전", text:"이거 템플릿 있으면 공유 가능?", createdAt: now - 1800*1000 }
    ];

    const inbox = [
      { id: uid("n"), icon:"🎉", title:"환영합니다", body:"표고모 데모에 오신 걸 환영해요.", time:"지금", target:{type:"home"}, unread:false }
    ];

    const ibNews = [
      {
        id: uid("ibn"),
        title: "IB 내부평가(IA) 초안 제출 주간 안내",
        body: "과목별 IA 초안 제출 주간이 시작되었습니다. 각 과목 담당 선생님이 공지한 루브릭 기준을 다시 확인하고, 그래프/인용 표기 누락이 없는지 마지막 점검 후 제출하세요.",
        author: "IB뉴스 관리자",
        createdAt: now - 1000 * 60 * 35,
        time: "35분 전",
        media: null
      }
    ];

    const ibApps = [
      {
        id: uid("iba"),
        category: "writing",
        categoryLabel: "글쓰기/첨삭",
        name: "Grammarly",
        desc: "EE, TOK 에세이 문장 교정과 문체 개선에 유용합니다.",
        features: ["문법/철자 자동 교정", "문장 톤 점검", "브라우저/문서 확장 지원"],
        link: "https://www.grammarly.com/",
        image: "https://logo.clearbit.com/grammarly.com",
        video: "https://www.youtube.com/results?search_query=grammarly+tutorial"
      },
      {
        id: uid("iba"),
        category: "research",
        categoryLabel: "자료조사",
        name: "Google Scholar",
        desc: "EE와 IA에 필요한 논문/학술 자료를 검색할 수 있습니다.",
        features: ["키워드 기반 논문 검색", "인용 정보 확인", "연관 논문 탐색"],
        link: "https://scholar.google.com/",
        image: "https://logo.clearbit.com/google.com",
        video: "https://www.youtube.com/results?search_query=google+scholar+how+to+use"
      },
      {
        id: uid("iba"),
        category: "planning",
        categoryLabel: "일정관리",
        name: "Notion",
        desc: "IA/EE/TOK 마감 일정과 체크리스트를 한 곳에서 관리할 수 있습니다.",
        features: ["칸반/캘린더 보드", "템플릿으로 과제 관리", "팀/개인 협업"],
        link: "https://www.notion.so/",
        image: "https://logo.clearbit.com/notion.so",
        video: "https://www.youtube.com/results?search_query=notion+student+template"
      },
      {
        id: uid("iba"),
        category: "focus",
        categoryLabel: "집중/학습",
        name: "Forest",
        desc: "집중 시간 확보가 어려운 학생에게 효과적인 타이머 앱입니다.",
        features: ["집중 타이머", "집중 기록 통계", "습관화 보조"],
        link: "https://www.forestapp.cc/",
        image: "https://logo.clearbit.com/forestapp.cc",
        video: "https://www.youtube.com/results?search_query=forest+study+app"
      },
      {
        id: uid("iba"),
        category: "research",
        categoryLabel: "자료조사",
        name: "Zotero",
        desc: "참고문헌 수집/정리에 강한 무료 레퍼런스 매니저입니다.",
        features: ["웹에서 참고문헌 저장", "인용 스타일 자동 생성", "폴더/태그 정리"],
        link: "https://www.zotero.org/",
        image: "https://logo.clearbit.com/zotero.org",
        video: "https://www.youtube.com/results?search_query=zotero+for+students"
      },
      {
        id: uid("iba"),
        category: "ai",
        categoryLabel: "AI 도우미",
        name: "Perplexity",
        desc: "출처 기반 답변으로 IA 조사 시작점을 빠르게 잡을 수 있습니다.",
        features: ["출처 링크 확인", "후속 질문", "요약/정리"],
        link: "https://www.perplexity.ai/",
        image: "https://logo.clearbit.com/perplexity.ai",
        video: "https://www.youtube.com/results?search_query=perplexity+ai+tutorial"
      },
      {
        id: uid("iba"),
        category: "ai",
        categoryLabel: "AI 도우미",
        name: "ChatGPT",
        desc: "아이디어 정리, 질문 생성, 초안 점검에 유용한 보조 도구입니다.",
        features: ["브레인스토밍", "초안 피드백", "요약/재작성"],
        link: "https://chatgpt.com/",
        image: "https://logo.clearbit.com/openai.com",
        video: "https://www.youtube.com/results?search_query=chatgpt+study+tips"
      },
      {
        id: uid("iba"),
        category: "language",
        categoryLabel: "언어학습",
        name: "DeepL",
        desc: "영문 텍스트 번역 품질이 높아 표현 비교에 도움이 됩니다.",
        features: ["자연스러운 번역", "문체 선택", "확장 프로그램"],
        link: "https://www.deepl.com/",
        image: "https://logo.clearbit.com/deepl.com",
        video: "https://www.youtube.com/results?search_query=deepl+translator+tips"
      },
      {
        id: uid("iba"),
        category: "language",
        categoryLabel: "언어학습",
        name: "Quizlet",
        desc: "IB 과목 용어, 핵심 개념 암기 카드 제작에 편합니다.",
        features: ["플래시카드", "테스트 모드", "학습 세트 공유"],
        link: "https://quizlet.com/",
        image: "https://logo.clearbit.com/quizlet.com",
        video: "https://www.youtube.com/results?search_query=quizlet+study+set"
      },
      {
        id: uid("iba"),
        category: "planning",
        categoryLabel: "일정관리",
        name: "Google Calendar",
        desc: "시험/마감일을 과목별 색상으로 관리하기 좋습니다.",
        features: ["알림 설정", "반복 일정", "공유 캘린더"],
        link: "https://calendar.google.com/",
        image: "https://logo.clearbit.com/google.com",
        video: "https://www.youtube.com/results?search_query=google+calendar+student+setup"
      },
      {
        id: uid("iba"),
        category: "focus",
        categoryLabel: "집중/학습",
        name: "Anki",
        desc: "간격 반복 학습으로 장기 암기에 특화된 앱입니다.",
        features: ["SRS 복습", "커스텀 카드", "통계"],
        link: "https://apps.ankiweb.net/",
        image: "https://logo.clearbit.com/ankiweb.net",
        video: "https://www.youtube.com/results?search_query=anki+for+exam"
      },
      {
        id: uid("iba"),
        category: "writing",
        categoryLabel: "글쓰기/첨삭",
        name: "Hemingway Editor",
        desc: "문장 난이도와 장문을 점검해 글을 더 명확하게 다듬어줍니다.",
        features: ["가독성 점수", "장문/수동태 표시", "간결한 문장 유도"],
        link: "https://hemingwayapp.com/",
        image: "https://logo.clearbit.com/hemingwayapp.com",
        video: "https://www.youtube.com/results?search_query=hemingway+editor+tutorial"
    }
  ];

    return {
      settings: {
        theme: "dark",
        composeTitleLabel: "제목",
        mediaAnimations: true,
        muteVideos: true,
        showRecentCommunities: true
      },
      me: { anon: "익명의 성실한 고래", clientId },
      auth: { loggedIn: false, user: null },
      profile: { karma: 0, contrib: 0, ageText: "20일", active: 1 },
      ui: {
        composeSelectedCommunityId: communities[0].id,
        recentCommunityIds: [],
        commTab: "explore",
        ibTab: "news",
        ibNewsDraftMedia: null,
        miniBestMs: null,
        banner: { title: "오늘의 배너", subtitle: "프로젝트 참여해주세요", imageUrl: "" }
      },
      communities,
      commRequests: [],
      suggestions: [],
      ibNews,
      ibApps,
      posts,
      comments,
      commentModerations: [],
      nicknameRegistry: {},
      inbox
    };
  }
})();
</script>
</body>
</html>
